import{Aa as Ul,Ba as Gl,Ca as zl,H as Il,O as El,a as yl,c as wl,d as re,e as gn,fa as Tl,g as Rt,i as So,j as cr,l as vl,m as Ei,n as Ti,na as Dl,o as Ai,oa as Cl,p as Ro,pa as Dt,qa as Vl,ra as Nl,sa as kl,t as Si,ua as Fl,v as lr,va as Ml,w as rt,wa as Ll,xa as Ol,ya as ql,za as Bl}from"./chunk-62R4RV7J.js";import{a as mn,b as ur,c as Ao,d as p,k as Al,l as hr,m as Po,n as Sl,o as Rl,q as bo,r as H,s as Ri,t as zt,u as Pl,v as bl,w as xl,y as xo,z as Do}from"./chunk-7FQVP44B.js";var $g=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Lt={},T,Xo=Xo||{},D=$g||self;function Bi(n){var t=typeof n;return t=t!="object"?t:n?Array.isArray(n)?"array":t:"null",t=="array"||t=="object"&&typeof n.length=="number"}function Sr(n){var t=typeof n;return t=="object"&&n!=null||t=="function"}function Qg(n){return Object.prototype.hasOwnProperty.call(n,Co)&&n[Co]||(n[Co]=++Wg)}var Co="closure_uid_"+(1e9*Math.random()>>>0),Wg=0;function Hg(n,t,e){return n.call.apply(n.bind,arguments)}function Jg(n,t,e){if(!n)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var i=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(i,r),n.apply(t,i)}}return function(){return n.apply(t,arguments)}}function _t(n,t,e){return Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?_t=Hg:_t=Jg,_t.apply(null,arguments)}function Pi(n,t){var e=Array.prototype.slice.call(arguments,1);return function(){var r=e.slice();return r.push.apply(r,arguments),n.apply(this,r)}}function ht(n,t){function e(){}e.prototype=t.prototype,n.$=t.prototype,n.prototype=new e,n.prototype.constructor=n,n.ac=function(r,i,s){for(var o=Array(arguments.length-2),a=2;a<arguments.length;a++)o[a-2]=arguments[a];return t.prototype[i].apply(r,o)}}function ge(){this.s=this.s,this.o=this.o}var Yg=0;ge.prototype.s=!1;ge.prototype.sa=function(){!this.s&&(this.s=!0,this.N(),Yg!=0)&&Qg(this)};ge.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};var nh=Array.prototype.indexOf?function(n,t){return Array.prototype.indexOf.call(n,t,void 0)}:function(n,t){if(typeof n=="string")return typeof t!="string"||t.length!=1?-1:n.indexOf(t,0);for(let e=0;e<n.length;e++)if(e in n&&n[e]===t)return e;return-1};function Zo(n){let t=n.length;if(0<t){let e=Array(t);for(let r=0;r<t;r++)e[r]=n[r];return e}return[]}function jl(n,t){for(let e=1;e<arguments.length;e++){let r=arguments[e];if(Bi(r)){let i=n.length||0,s=r.length||0;n.length=i+s;for(let o=0;o<s;o++)n[i+o]=r[o]}else n.push(r)}}function yt(n,t){this.type=n,this.g=this.target=t,this.defaultPrevented=!1}yt.prototype.h=function(){this.defaultPrevented=!0};var Xg=function(){if(!D.addEventListener||!Object.defineProperty)return!1;var n=!1,t=Object.defineProperty({},"passive",{get:function(){n=!0}});try{let e=()=>{};D.addEventListener("test",e,t),D.removeEventListener("test",e,t)}catch{}return n}();function _r(n){return/^[\s\xa0]*$/.test(n)}function Ui(){var n=D.navigator;return n&&(n=n.userAgent)?n:""}function jt(n){return Ui().indexOf(n)!=-1}function ta(n){return ta[" "](n),n}ta[" "]=function(){};function Zg(n,t){var e=Up;return Object.prototype.hasOwnProperty.call(e,n)?e[n]:e[n]=t(n)}var tp=jt("Opera"),wn=jt("Trident")||jt("MSIE"),rh=jt("Edge"),Mo=rh||wn,ih=jt("Gecko")&&!(Ui().toLowerCase().indexOf("webkit")!=-1&&!jt("Edge"))&&!(jt("Trident")||jt("MSIE"))&&!jt("Edge"),ep=Ui().toLowerCase().indexOf("webkit")!=-1&&!jt("Edge");function sh(){var n=D.document;return n?n.documentMode:void 0}var Lo;t:{if(bi="",xi=function(){var n=Ui();if(ih)return/rv:([^\);]+)(\)|;)/.exec(n);if(rh)return/Edge\/([\d\.]+)/.exec(n);if(wn)return/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(n);if(ep)return/WebKit\/(\S+)/.exec(n);if(tp)return/(?:Version)[ \/]?(\S+)/.exec(n)}(),xi&&(bi=xi?xi[1]:""),wn&&(Di=sh(),Di!=null&&Di>parseFloat(bi))){Lo=String(Di);break t}Lo=bi}var bi,xi,Di,Oo;D.document&&wn?(Vo=sh(),Oo=Vo||parseInt(Lo,10)||void 0):Oo=void 0;var Vo,np=Oo;function yr(n,t){if(yt.call(this,n?n.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,n){var e=this.type=n.type,r=n.changedTouches&&n.changedTouches.length?n.changedTouches[0]:null;if(this.target=n.target||n.srcElement,this.g=t,t=n.relatedTarget){if(ih){t:{try{ta(t.nodeName);var i=!0;break t}catch{}i=!1}i||(t=null)}}else e=="mouseover"?t=n.fromElement:e=="mouseout"&&(t=n.toElement);this.relatedTarget=t,r?(this.clientX=r.clientX!==void 0?r.clientX:r.pageX,this.clientY=r.clientY!==void 0?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=n.clientX!==void 0?n.clientX:n.pageX,this.clientY=n.clientY!==void 0?n.clientY:n.pageY,this.screenX=n.screenX||0,this.screenY=n.screenY||0),this.button=n.button,this.key=n.key||"",this.ctrlKey=n.ctrlKey,this.altKey=n.altKey,this.shiftKey=n.shiftKey,this.metaKey=n.metaKey,this.pointerId=n.pointerId||0,this.pointerType=typeof n.pointerType=="string"?n.pointerType:rp[n.pointerType]||"",this.state=n.state,this.i=n,n.defaultPrevented&&yr.$.h.call(this)}}ht(yr,yt);var rp={2:"touch",3:"pen",4:"mouse"};yr.prototype.h=function(){yr.$.h.call(this);var n=this.i;n.preventDefault?n.preventDefault():n.returnValue=!1};var Rr="closure_listenable_"+(1e6*Math.random()|0),ip=0;function sp(n,t,e,r,i){this.listener=n,this.proxy=null,this.src=t,this.type=e,this.capture=!!r,this.la=i,this.key=++ip,this.fa=this.ia=!1}function Gi(n){n.fa=!0,n.listener=null,n.proxy=null,n.src=null,n.la=null}function ea(n,t,e){for(let r in n)t.call(e,n[r],r,n)}function op(n,t){for(let e in n)t.call(void 0,n[e],e,n)}function oh(n){let t={};for(let e in n)t[e]=n[e];return t}var Kl="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function ah(n,t){let e,r;for(let i=1;i<arguments.length;i++){r=arguments[i];for(e in r)n[e]=r[e];for(let s=0;s<Kl.length;s++)e=Kl[s],Object.prototype.hasOwnProperty.call(r,e)&&(n[e]=r[e])}}function zi(n){this.src=n,this.g={},this.h=0}zi.prototype.add=function(n,t,e,r,i){var s=n.toString();n=this.g[s],n||(n=this.g[s]=[],this.h++);var o=Bo(n,t,r,i);return-1<o?(t=n[o],e||(t.ia=!1)):(t=new sp(t,this.src,s,!!r,i),t.ia=e,n.push(t)),t};function qo(n,t){var e=t.type;if(e in n.g){var r=n.g[e],i=nh(r,t),s;(s=0<=i)&&Array.prototype.splice.call(r,i,1),s&&(Gi(t),n.g[e].length==0&&(delete n.g[e],n.h--))}}function Bo(n,t,e,r){for(var i=0;i<n.length;++i){var s=n[i];if(!s.fa&&s.listener==t&&s.capture==!!e&&s.la==r)return i}return-1}var na="closure_lm_"+(1e6*Math.random()|0),No={};function uh(n,t,e,r,i){if(r&&r.once)return lh(n,t,e,r,i);if(Array.isArray(t)){for(var s=0;s<t.length;s++)uh(n,t[s],e,r,i);return null}return e=sa(e),n&&n[Rr]?n.O(t,e,Sr(r)?!!r.capture:!!r,i):ch(n,t,e,!1,r,i)}function ch(n,t,e,r,i,s){if(!t)throw Error("Invalid event type");var o=Sr(i)?!!i.capture:!!i,a=ia(n);if(a||(n[na]=a=new zi(n)),e=a.add(t,e,r,o,s),e.proxy)return e;if(r=ap(),e.proxy=r,r.src=n,r.listener=e,n.addEventListener)Xg||(i=o),i===void 0&&(i=!1),n.addEventListener(t.toString(),r,i);else if(n.attachEvent)n.attachEvent(dh(t.toString()),r);else if(n.addListener&&n.removeListener)n.addListener(r);else throw Error("addEventListener and attachEvent are unavailable.");return e}function ap(){function n(e){return t.call(n.src,n.listener,e)}let t=up;return n}function lh(n,t,e,r,i){if(Array.isArray(t)){for(var s=0;s<t.length;s++)lh(n,t[s],e,r,i);return null}return e=sa(e),n&&n[Rr]?n.P(t,e,Sr(r)?!!r.capture:!!r,i):ch(n,t,e,!0,r,i)}function hh(n,t,e,r,i){if(Array.isArray(t))for(var s=0;s<t.length;s++)hh(n,t[s],e,r,i);else r=Sr(r)?!!r.capture:!!r,e=sa(e),n&&n[Rr]?(n=n.i,t=String(t).toString(),t in n.g&&(s=n.g[t],e=Bo(s,e,r,i),-1<e&&(Gi(s[e]),Array.prototype.splice.call(s,e,1),s.length==0&&(delete n.g[t],n.h--)))):n&&(n=ia(n))&&(t=n.g[t.toString()],n=-1,t&&(n=Bo(t,e,r,i)),(e=-1<n?t[n]:null)&&ra(e))}function ra(n){if(typeof n!="number"&&n&&!n.fa){var t=n.src;if(t&&t[Rr])qo(t.i,n);else{var e=n.type,r=n.proxy;t.removeEventListener?t.removeEventListener(e,r,n.capture):t.detachEvent?t.detachEvent(dh(e),r):t.addListener&&t.removeListener&&t.removeListener(r),(e=ia(t))?(qo(e,n),e.h==0&&(e.src=null,t[na]=null)):Gi(n)}}}function dh(n){return n in No?No[n]:No[n]="on"+n}function up(n,t){if(n.fa)n=!0;else{t=new yr(t,this);var e=n.listener,r=n.la||n.src;n.ia&&ra(n),n=e.call(r,t)}return n}function ia(n){return n=n[na],n instanceof zi?n:null}var ko="__closure_events_fn_"+(1e9*Math.random()>>>0);function sa(n){return typeof n=="function"?n:(n[ko]||(n[ko]=function(t){return n.handleEvent(t)}),n[ko])}function lt(){ge.call(this),this.i=new zi(this),this.S=this,this.J=null}ht(lt,ge);lt.prototype[Rr]=!0;lt.prototype.removeEventListener=function(n,t,e,r){hh(this,n,t,e,r)};function gt(n,t){var e,r=n.J;if(r)for(e=[];r;r=r.J)e.push(r);if(n=n.S,r=t.type||t,typeof t=="string")t=new yt(t,n);else if(t instanceof yt)t.target=t.target||n;else{var i=t;t=new yt(r,n),ah(t,i)}if(i=!0,e)for(var s=e.length-1;0<=s;s--){var o=t.g=e[s];i=Ci(o,r,!0,t)&&i}if(o=t.g=n,i=Ci(o,r,!0,t)&&i,i=Ci(o,r,!1,t)&&i,e)for(s=0;s<e.length;s++)o=t.g=e[s],i=Ci(o,r,!1,t)&&i}lt.prototype.N=function(){if(lt.$.N.call(this),this.i){var n=this.i,t;for(t in n.g){for(var e=n.g[t],r=0;r<e.length;r++)Gi(e[r]);delete n.g[t],n.h--}}this.J=null};lt.prototype.O=function(n,t,e,r){return this.i.add(String(n),t,!1,e,r)};lt.prototype.P=function(n,t,e,r){return this.i.add(String(n),t,!0,e,r)};function Ci(n,t,e,r){if(t=n.i.g[String(t)],!t)return!0;t=t.concat();for(var i=!0,s=0;s<t.length;++s){var o=t[s];if(o&&!o.fa&&o.capture==e){var a=o.listener,u=o.la||o.src;o.ia&&qo(n.i,o),i=a.call(u,r)!==!1&&i}}return i&&!r.defaultPrevented}var oa=D.JSON.stringify,Uo=class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}};function cp(){var n=aa;let t=null;return n.g&&(t=n.g,n.g=n.g.next,n.g||(n.h=null),t.next=null),t}var Go=class{constructor(){this.h=this.g=null}add(t,e){let r=fh.get();r.set(t,e),this.h?this.h.next=r:this.g=r,this.h=r}},fh=new Uo(()=>new zo,n=>n.reset()),zo=class{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}};function lp(n){var t=1;n=n.split(":");let e=[];for(;0<t&&n.length;)e.push(n.shift()),t--;return n.length&&e.push(n.join(":")),e}function hp(n){D.setTimeout(()=>{throw n},0)}var wr,vr=!1,aa=new Go,mh=()=>{let n=D.Promise.resolve(void 0);wr=()=>{n.then(dp)}},dp=()=>{for(var n;n=cp();){try{n.h.call(n.g)}catch(e){hp(e)}var t=fh;t.j(n),100>t.h&&(t.h++,n.next=t.g,t.g=n)}vr=!1};function ji(n,t){lt.call(this),this.h=n||1,this.g=t||D,this.j=_t(this.qb,this),this.l=Date.now()}ht(ji,lt);T=ji.prototype;T.ga=!1;T.T=null;T.qb=function(){if(this.ga){var n=Date.now()-this.l;0<n&&n<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-n):(this.T&&(this.g.clearTimeout(this.T),this.T=null),gt(this,"tick"),this.ga&&(ua(this),this.start()))}};T.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())};function ua(n){n.ga=!1,n.T&&(n.g.clearTimeout(n.T),n.T=null)}T.N=function(){ji.$.N.call(this),ua(this),delete this.g};function ca(n,t,e){if(typeof n=="function")e&&(n=_t(n,e));else if(n&&typeof n.handleEvent=="function")n=_t(n.handleEvent,n);else throw Error("Invalid listener argument");return 2147483647<Number(t)?-1:D.setTimeout(n,t||0)}function gh(n){n.g=ca(()=>{n.g=null,n.i&&(n.i=!1,gh(n))},n.j);let t=n.h;n.h=null,n.m.apply(null,t)}var jo=class extends ge{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:gh(this)}N(){super.N(),this.g&&(D.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}};function Ir(n){ge.call(this),this.h=n,this.g={}}ht(Ir,ge);var $l=[];function ph(n,t,e,r){Array.isArray(e)||(e&&($l[0]=e.toString()),e=$l);for(var i=0;i<e.length;i++){var s=uh(t,e[i],r||n.handleEvent,!1,n.h||n);if(!s)break;n.g[s.key]=s}}function _h(n){ea(n.g,function(t,e){this.g.hasOwnProperty(e)&&ra(t)},n),n.g={}}Ir.prototype.N=function(){Ir.$.N.call(this),_h(this)};Ir.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};function Ki(){this.g=!0}Ki.prototype.Ea=function(){this.g=!1};function fp(n,t,e,r,i,s){n.info(function(){if(n.g)if(s)for(var o="",a=s.split("&"),u=0;u<a.length;u++){var c=a[u].split("=");if(1<c.length){var l=c[0];c=c[1];var h=l.split("_");o=2<=h.length&&h[1]=="type"?o+(l+"="+c+"&"):o+(l+"=redacted&")}}else o=null;else o=s;return"XMLHTTP REQ ("+r+") [attempt "+i+"]: "+t+`
`+e+`
`+o})}function mp(n,t,e,r,i,s,o){n.info(function(){return"XMLHTTP RESP ("+r+") [ attempt "+i+"]: "+t+`
`+e+`
`+s+" "+o})}function _n(n,t,e,r){n.info(function(){return"XMLHTTP TEXT ("+t+"): "+pp(n,e)+(r?" "+r:"")})}function gp(n,t){n.info(function(){return"TIMEOUT: "+t})}Ki.prototype.info=function(){};function pp(n,t){if(!n.g)return t;if(!t)return null;try{var e=JSON.parse(t);if(e){for(n=0;n<e.length;n++)if(Array.isArray(e[n])){var r=e[n];if(!(2>r.length)){var i=r[1];if(Array.isArray(i)&&!(1>i.length)){var s=i[0];if(s!="noop"&&s!="stop"&&s!="close")for(var o=1;o<i.length;o++)i[o]=""}}}}return oa(e)}catch{return t}}var qe={},Ql=null;function $i(){return Ql=Ql||new lt}qe.Ta="serverreachability";function yh(n){yt.call(this,qe.Ta,n)}ht(yh,yt);function Er(n){let t=$i();gt(t,new yh(t))}qe.STAT_EVENT="statevent";function wh(n,t){yt.call(this,qe.STAT_EVENT,n),this.stat=t}ht(wh,yt);function It(n){let t=$i();gt(t,new wh(t,n))}qe.Ua="timingevent";function vh(n,t){yt.call(this,qe.Ua,n),this.size=t}ht(vh,yt);function Pr(n,t){if(typeof n!="function")throw Error("Fn must not be null and must be a function");return D.setTimeout(function(){n()},t)}var Qi={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},Ih={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function la(){}la.prototype.h=null;function Wl(n){return n.h||(n.h=n.i())}function Eh(){}var br={OPEN:"a",vb:"b",Ra:"c",Hb:"d"};function ha(){yt.call(this,"d")}ht(ha,yt);function da(){yt.call(this,"c")}ht(da,yt);var Ko;function Wi(){}ht(Wi,la);Wi.prototype.g=function(){return new XMLHttpRequest};Wi.prototype.i=function(){return{}};Ko=new Wi;function xr(n,t,e,r){this.l=n,this.j=t,this.m=e,this.W=r||1,this.U=new Ir(this),this.P=_p,n=Mo?125:void 0,this.V=new ji(n),this.I=null,this.i=!1,this.u=this.B=this.A=this.L=this.G=this.Y=this.C=null,this.F=[],this.g=null,this.o=0,this.s=this.v=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new Th}function Th(){this.i=null,this.g="",this.h=!1}var _p=45e3,Ah={},$o={};T=xr.prototype;T.setTimeout=function(n){this.P=n};function Qo(n,t,e){n.L=1,n.A=Ji(se(t)),n.u=e,n.S=!0,Sh(n,null)}function Sh(n,t){n.G=Date.now(),Dr(n),n.B=se(n.A);var e=n.B,r=n.W;Array.isArray(r)||(r=[String(r)]),Nh(e.i,"t",r),n.o=0,e=n.l.J,n.h=new Th,n.g=td(n.l,e?t:null,!n.u),0<n.O&&(n.M=new jo(_t(n.Pa,n,n.g),n.O)),ph(n.U,n.g,"readystatechange",n.nb),t=n.I?oh(n.I):{},n.u?(n.v||(n.v="POST"),t["Content-Type"]="application/x-www-form-urlencoded",n.g.ha(n.B,n.v,n.u,t)):(n.v="GET",n.g.ha(n.B,n.v,null,t)),Er(),fp(n.j,n.v,n.B,n.m,n.W,n.u)}T.nb=function(n){n=n.target;let t=this.M;t&&Kt(n)==3?t.l():this.Pa(n)};T.Pa=function(n){try{if(n==this.g)t:{let l=Kt(this.g);var t=this.g.Ia();let h=this.g.da();if(!(3>l)&&(l!=3||Mo||this.g&&(this.h.h||this.g.ja()||Xl(this.g)))){this.J||l!=4||t==7||(t==8||0>=h?Er(3):Er(2)),Hi(this);var e=this.g.da();this.ca=e;e:if(Rh(this)){var r=Xl(this.g);n="";var i=r.length,s=Kt(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){Me(this),pr(this);var o="";break e}this.h.i=new D.TextDecoder}for(t=0;t<i;t++)this.h.h=!0,n+=this.h.i.decode(r[t],{stream:s&&t==i-1});r.length=0,this.h.g+=n,this.o=0,o=this.h.g}else o=this.g.ja();if(this.i=e==200,mp(this.j,this.v,this.B,this.m,this.W,l,e),this.i){if(this.aa&&!this.K){e:{if(this.g){var a,u=this.g;if((a=u.g?u.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!_r(a)){var c=a;break e}}c=null}if(e=c)_n(this.j,this.m,e,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Wo(this,e);else{this.i=!1,this.s=3,It(12),Me(this),pr(this);break t}}this.S?(Ph(this,l,o),Mo&&this.i&&l==3&&(ph(this.U,this.V,"tick",this.mb),this.V.start())):(_n(this.j,this.m,o,null),Wo(this,o)),l==4&&Me(this),this.i&&!this.J&&(l==4?Jh(this.l,this):(this.i=!1,Dr(this)))}else Op(this.g),e==400&&0<o.indexOf("Unknown SID")?(this.s=3,It(12)):(this.s=0,It(13)),Me(this),pr(this)}}}catch{}finally{}};function Rh(n){return n.g?n.v=="GET"&&n.L!=2&&n.l.Ha:!1}function Ph(n,t,e){let r=!0,i;for(;!n.J&&n.o<e.length;)if(i=yp(n,e),i==$o){t==4&&(n.s=4,It(14),r=!1),_n(n.j,n.m,null,"[Incomplete Response]");break}else if(i==Ah){n.s=4,It(15),_n(n.j,n.m,e,"[Invalid Chunk]"),r=!1;break}else _n(n.j,n.m,i,null),Wo(n,i);Rh(n)&&n.o!=0&&(n.h.g=n.h.g.slice(n.o),n.o=0),t!=4||e.length!=0||n.h.h||(n.s=1,It(16),r=!1),n.i=n.i&&r,r?0<e.length&&!n.ba&&(n.ba=!0,t=n.l,t.g==n&&t.ca&&!t.M&&(t.l.info("Great, no buffering proxy detected. Bytes received: "+e.length),ya(t),t.M=!0,It(11))):(_n(n.j,n.m,e,"[Invalid Chunked Response]"),Me(n),pr(n))}T.mb=function(){if(this.g){var n=Kt(this.g),t=this.g.ja();this.o<t.length&&(Hi(this),Ph(this,n,t),this.i&&n!=4&&Dr(this))}};function yp(n,t){var e=n.o,r=t.indexOf(`
`,e);return r==-1?$o:(e=Number(t.substring(e,r)),isNaN(e)?Ah:(r+=1,r+e>t.length?$o:(t=t.slice(r,r+e),n.o=r+e,t)))}T.cancel=function(){this.J=!0,Me(this)};function Dr(n){n.Y=Date.now()+n.P,bh(n,n.P)}function bh(n,t){if(n.C!=null)throw Error("WatchDog timer not null");n.C=Pr(_t(n.lb,n),t)}function Hi(n){n.C&&(D.clearTimeout(n.C),n.C=null)}T.lb=function(){this.C=null;let n=Date.now();0<=n-this.Y?(gp(this.j,this.B),this.L!=2&&(Er(),It(17)),Me(this),this.s=2,pr(this)):bh(this,this.Y-n)};function pr(n){n.l.H==0||n.J||Jh(n.l,n)}function Me(n){Hi(n);var t=n.M;t&&typeof t.sa=="function"&&t.sa(),n.M=null,ua(n.V),_h(n.U),n.g&&(t=n.g,n.g=null,t.abort(),t.sa())}function Wo(n,t){try{var e=n.l;if(e.H!=0&&(e.g==n||Ho(e.i,n))){if(!n.K&&Ho(e.i,n)&&e.H==3){try{var r=e.Ja.g.parse(t)}catch{r=null}if(Array.isArray(r)&&r.length==3){var i=r;if(i[0]==0){t:if(!e.u){if(e.g)if(e.g.G+3e3<n.G)Mi(e),Zi(e);else break t;_a(e),It(18)}}else e.Fa=i[1],0<e.Fa-e.V&&37500>i[2]&&e.G&&e.A==0&&!e.v&&(e.v=Pr(_t(e.ib,e),6e3));if(1>=Mh(e.i)&&e.oa){try{e.oa()}catch{}e.oa=void 0}}else Le(e,11)}else if((n.K||e.g==n)&&Mi(e),!_r(t))for(i=e.Ja.g.parse(t),t=0;t<i.length;t++){let c=i[t];if(e.V=c[0],c=c[1],e.H==2)if(c[0]=="c"){e.K=c[1],e.pa=c[2];let l=c[3];l!=null&&(e.ra=l,e.l.info("VER="+e.ra));let h=c[4];h!=null&&(e.Ga=h,e.l.info("SVER="+e.Ga));let d=c[5];d!=null&&typeof d=="number"&&0<d&&(r=1.5*d,e.L=r,e.l.info("backChannelRequestTimeoutMs_="+r)),r=e;let m=n.g;if(m){let A=m.g?m.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(A){var s=r.i;s.g||A.indexOf("spdy")==-1&&A.indexOf("quic")==-1&&A.indexOf("h2")==-1||(s.j=s.l,s.g=new Set,s.h&&(fa(s,s.h),s.h=null))}if(r.F){let w=m.g?m.g.getResponseHeader("X-HTTP-Session-Id"):null;w&&(r.Da=w,K(r.I,r.F,w))}}e.H=3,e.h&&e.h.Ba(),e.ca&&(e.S=Date.now()-n.G,e.l.info("Handshake RTT: "+e.S+"ms")),r=e;var o=n;if(r.wa=Zh(r,r.J?r.pa:null,r.Y),o.K){Lh(r.i,o);var a=o,u=r.L;u&&a.setTimeout(u),a.C&&(Hi(a),Dr(a)),r.g=o}else Wh(r);0<e.j.length&&ts(e)}else c[0]!="stop"&&c[0]!="close"||Le(e,7);else e.H==3&&(c[0]=="stop"||c[0]=="close"?c[0]=="stop"?Le(e,7):pa(e):c[0]!="noop"&&e.h&&e.h.Aa(c),e.A=0)}}Er(4)}catch{}}function wp(n){if(n.Z&&typeof n.Z=="function")return n.Z();if(typeof Map<"u"&&n instanceof Map||typeof Set<"u"&&n instanceof Set)return Array.from(n.values());if(typeof n=="string")return n.split("");if(Bi(n)){for(var t=[],e=n.length,r=0;r<e;r++)t.push(n[r]);return t}t=[],e=0;for(r in n)t[e++]=n[r];return t}function vp(n){if(n.ta&&typeof n.ta=="function")return n.ta();if(!n.Z||typeof n.Z!="function"){if(typeof Map<"u"&&n instanceof Map)return Array.from(n.keys());if(!(typeof Set<"u"&&n instanceof Set)){if(Bi(n)||typeof n=="string"){var t=[];n=n.length;for(var e=0;e<n;e++)t.push(e);return t}t=[],e=0;for(let r in n)t[e++]=r;return t}}}function xh(n,t){if(n.forEach&&typeof n.forEach=="function")n.forEach(t,void 0);else if(Bi(n)||typeof n=="string")Array.prototype.forEach.call(n,t,void 0);else for(var e=vp(n),r=wp(n),i=r.length,s=0;s<i;s++)t.call(void 0,r[s],e&&e[s],n)}var Dh=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Ip(n,t){if(n){n=n.split("&");for(var e=0;e<n.length;e++){var r=n[e].indexOf("="),i=null;if(0<=r){var s=n[e].substring(0,r);i=n[e].substring(r+1)}else s=n[e];t(s,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}function Oe(n){if(this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,n instanceof Oe){this.h=n.h,ki(this,n.j),this.s=n.s,this.g=n.g,Fi(this,n.m),this.l=n.l;var t=n.i,e=new Tr;e.i=t.i,t.g&&(e.g=new Map(t.g),e.h=t.h),Hl(this,e),this.o=n.o}else n&&(t=String(n).match(Dh))?(this.h=!1,ki(this,t[1]||"",!0),this.s=mr(t[2]||""),this.g=mr(t[3]||"",!0),Fi(this,t[4]),this.l=mr(t[5]||"",!0),Hl(this,t[6]||"",!0),this.o=mr(t[7]||"")):(this.h=!1,this.i=new Tr(null,this.h))}Oe.prototype.toString=function(){var n=[],t=this.j;t&&n.push(gr(t,Jl,!0),":");var e=this.g;return(e||t=="file")&&(n.push("//"),(t=this.s)&&n.push(gr(t,Jl,!0),"@"),n.push(encodeURIComponent(String(e)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),e=this.m,e!=null&&n.push(":",String(e))),(e=this.l)&&(this.g&&e.charAt(0)!="/"&&n.push("/"),n.push(gr(e,e.charAt(0)=="/"?Ap:Tp,!0))),(e=this.i.toString())&&n.push("?",e),(e=this.o)&&n.push("#",gr(e,Rp)),n.join("")};function se(n){return new Oe(n)}function ki(n,t,e){n.j=e?mr(t,!0):t,n.j&&(n.j=n.j.replace(/:$/,""))}function Fi(n,t){if(t){if(t=Number(t),isNaN(t)||0>t)throw Error("Bad port number "+t);n.m=t}else n.m=null}function Hl(n,t,e){t instanceof Tr?(n.i=t,Pp(n.i,n.h)):(e||(t=gr(t,Sp)),n.i=new Tr(t,n.h))}function K(n,t,e){n.i.set(t,e)}function Ji(n){return K(n,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),n}function mr(n,t){return n?t?decodeURI(n.replace(/%25/g,"%2525")):decodeURIComponent(n):""}function gr(n,t,e){return typeof n=="string"?(n=encodeURI(n).replace(t,Ep),e&&(n=n.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),n):null}function Ep(n){return n=n.charCodeAt(0),"%"+(n>>4&15).toString(16)+(n&15).toString(16)}var Jl=/[#\/\?@]/g,Tp=/[#\?:]/g,Ap=/[#\?]/g,Sp=/[#\?@]/g,Rp=/#/g;function Tr(n,t){this.h=this.g=null,this.i=n||null,this.j=!!t}function pe(n){n.g||(n.g=new Map,n.h=0,n.i&&Ip(n.i,function(t,e){n.add(decodeURIComponent(t.replace(/\+/g," ")),e)}))}T=Tr.prototype;T.add=function(n,t){pe(this),this.i=null,n=vn(this,n);var e=this.g.get(n);return e||this.g.set(n,e=[]),e.push(t),this.h+=1,this};function Ch(n,t){pe(n),t=vn(n,t),n.g.has(t)&&(n.i=null,n.h-=n.g.get(t).length,n.g.delete(t))}function Vh(n,t){return pe(n),t=vn(n,t),n.g.has(t)}T.forEach=function(n,t){pe(this),this.g.forEach(function(e,r){e.forEach(function(i){n.call(t,i,r,this)},this)},this)};T.ta=function(){pe(this);let n=Array.from(this.g.values()),t=Array.from(this.g.keys()),e=[];for(let r=0;r<t.length;r++){let i=n[r];for(let s=0;s<i.length;s++)e.push(t[r])}return e};T.Z=function(n){pe(this);let t=[];if(typeof n=="string")Vh(this,n)&&(t=t.concat(this.g.get(vn(this,n))));else{n=Array.from(this.g.values());for(let e=0;e<n.length;e++)t=t.concat(n[e])}return t};T.set=function(n,t){return pe(this),this.i=null,n=vn(this,n),Vh(this,n)&&(this.h-=this.g.get(n).length),this.g.set(n,[t]),this.h+=1,this};T.get=function(n,t){return n?(n=this.Z(n),0<n.length?String(n[0]):t):t};function Nh(n,t,e){Ch(n,t),0<e.length&&(n.i=null,n.g.set(vn(n,t),Zo(e)),n.h+=e.length)}T.toString=function(){if(this.i)return this.i;if(!this.g)return"";let n=[],t=Array.from(this.g.keys());for(var e=0;e<t.length;e++){var r=t[e];let s=encodeURIComponent(String(r)),o=this.Z(r);for(r=0;r<o.length;r++){var i=s;o[r]!==""&&(i+="="+encodeURIComponent(String(o[r]))),n.push(i)}}return this.i=n.join("&")};function vn(n,t){return t=String(t),n.j&&(t=t.toLowerCase()),t}function Pp(n,t){t&&!n.j&&(pe(n),n.i=null,n.g.forEach(function(e,r){var i=r.toLowerCase();r!=i&&(Ch(this,r),Nh(this,i,e))},n)),n.j=t}var bp=class{constructor(n,t){this.g=n,this.map=t}};function kh(n){this.l=n||xp,D.PerformanceNavigationTiming?(n=D.performance.getEntriesByType("navigation"),n=0<n.length&&(n[0].nextHopProtocol=="hq"||n[0].nextHopProtocol=="h2")):n=!!(D.g&&D.g.Ka&&D.g.Ka()&&D.g.Ka().dc),this.j=n?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var xp=10;function Fh(n){return n.h?!0:n.g?n.g.size>=n.j:!1}function Mh(n){return n.h?1:n.g?n.g.size:0}function Ho(n,t){return n.h?n.h==t:n.g?n.g.has(t):!1}function fa(n,t){n.g?n.g.add(t):n.h=t}function Lh(n,t){n.h&&n.h==t?n.h=null:n.g&&n.g.has(t)&&n.g.delete(t)}kh.prototype.cancel=function(){if(this.i=Oh(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(let n of this.g.values())n.cancel();this.g.clear()}};function Oh(n){if(n.h!=null)return n.i.concat(n.h.F);if(n.g!=null&&n.g.size!==0){let t=n.i;for(let e of n.g.values())t=t.concat(e.F);return t}return Zo(n.i)}var Dp=class{stringify(n){return D.JSON.stringify(n,void 0)}parse(n){return D.JSON.parse(n,void 0)}};function Cp(){this.g=new Dp}function Vp(n,t,e){let r=e||"";try{xh(n,function(i,s){let o=i;Sr(i)&&(o=oa(i)),t.push(r+s+"="+encodeURIComponent(o))})}catch(i){throw t.push(r+"type="+encodeURIComponent("_badmap")),i}}function Np(n,t){let e=new Ki;if(D.Image){let r=new Image;r.onload=Pi(Vi,e,r,"TestLoadImage: loaded",!0,t),r.onerror=Pi(Vi,e,r,"TestLoadImage: error",!1,t),r.onabort=Pi(Vi,e,r,"TestLoadImage: abort",!1,t),r.ontimeout=Pi(Vi,e,r,"TestLoadImage: timeout",!1,t),D.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=n}else t(!1)}function Vi(n,t,e,r,i){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,i(r)}catch{}}function Cr(n){this.l=n.ec||null,this.j=n.ob||!1}ht(Cr,la);Cr.prototype.g=function(){return new Yi(this.l,this.j)};Cr.prototype.i=function(n){return function(){return n}}({});function Yi(n,t){lt.call(this),this.F=n,this.u=t,this.m=void 0,this.readyState=ma,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}ht(Yi,lt);var ma=0;T=Yi.prototype;T.open=function(n,t){if(this.readyState!=ma)throw this.abort(),Error("Error reopening a connection");this.C=n,this.B=t,this.readyState=1,Ar(this)};T.send=function(n){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;let t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};n&&(t.body=n),(this.F||D).fetch(new Request(this.B,t)).then(this.$a.bind(this),this.ka.bind(this))};T.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,Vr(this)),this.readyState=ma};T.$a=function(n){if(this.g&&(this.l=n,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=n.headers,this.readyState=2,Ar(this)),this.g&&(this.readyState=3,Ar(this),this.g)))if(this.responseType==="arraybuffer")n.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(typeof D.ReadableStream<"u"&&"body"in n){if(this.j=n.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;qh(this)}else n.text().then(this.Za.bind(this),this.ka.bind(this))};function qh(n){n.j.read().then(n.Xa.bind(n)).catch(n.ka.bind(n))}T.Xa=function(n){if(this.g){if(this.u&&n.value)this.response.push(n.value);else if(!this.u){var t=n.value?n.value:new Uint8Array(0);(t=this.A.decode(t,{stream:!n.done}))&&(this.response=this.responseText+=t)}n.done?Vr(this):Ar(this),this.readyState==3&&qh(this)}};T.Za=function(n){this.g&&(this.response=this.responseText=n,Vr(this))};T.Ya=function(n){this.g&&(this.response=n,Vr(this))};T.ka=function(){this.g&&Vr(this)};function Vr(n){n.readyState=4,n.l=null,n.j=null,n.A=null,Ar(n)}T.setRequestHeader=function(n,t){this.v.append(n,t)};T.getResponseHeader=function(n){return this.h&&this.h.get(n.toLowerCase())||""};T.getAllResponseHeaders=function(){if(!this.h)return"";let n=[],t=this.h.entries();for(var e=t.next();!e.done;)e=e.value,n.push(e[0]+": "+e[1]),e=t.next();return n.join(`\r
`)};function Ar(n){n.onreadystatechange&&n.onreadystatechange.call(n)}Object.defineProperty(Yi.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(n){this.m=n?"include":"same-origin"}});var kp=D.JSON.parse;function J(n){lt.call(this),this.headers=new Map,this.u=n||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=Bh,this.L=this.M=!1}ht(J,lt);var Bh="",Fp=/^https?$/i,Mp=["POST","PUT"];T=J.prototype;T.Oa=function(n){this.M=n};T.ha=function(n,t,e,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+n);t=t?t.toUpperCase():"GET",this.I=n,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=this.u?this.u.g():Ko.g(),this.C=this.u?Wl(this.u):Wl(Ko),this.g.onreadystatechange=_t(this.La,this);try{this.G=!0,this.g.open(t,String(n),!0),this.G=!1}catch(s){Yl(this,s);return}if(n=e||"",e=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var i in r)e.set(i,r[i]);else if(typeof r.keys=="function"&&typeof r.get=="function")for(let s of r.keys())e.set(s,r.get(s));else throw Error("Unknown input type for opt_headers: "+String(r));r=Array.from(e.keys()).find(s=>s.toLowerCase()=="content-type"),i=D.FormData&&n instanceof D.FormData,!(0<=nh(Mp,t))||r||i||e.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(let[s,o]of e)this.g.setRequestHeader(s,o);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{zh(this),0<this.B&&((this.L=Lp(this.g))?(this.g.timeout=this.B,this.g.ontimeout=_t(this.ua,this)):this.A=ca(this.ua,this.B,this)),this.v=!0,this.g.send(n),this.v=!1}catch(s){Yl(this,s)}};function Lp(n){return wn&&typeof n.timeout=="number"&&n.ontimeout!==void 0}T.ua=function(){typeof Xo<"u"&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,gt(this,"timeout"),this.abort(8))};function Yl(n,t){n.h=!1,n.g&&(n.l=!0,n.g.abort(),n.l=!1),n.j=t,n.m=5,Uh(n),Xi(n)}function Uh(n){n.F||(n.F=!0,gt(n,"complete"),gt(n,"error"))}T.abort=function(n){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=n||7,gt(this,"complete"),gt(this,"abort"),Xi(this))};T.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Xi(this,!0)),J.$.N.call(this)};T.La=function(){this.s||(this.G||this.v||this.l?Gh(this):this.kb())};T.kb=function(){Gh(this)};function Gh(n){if(n.h&&typeof Xo<"u"&&(!n.C[1]||Kt(n)!=4||n.da()!=2)){if(n.v&&Kt(n)==4)ca(n.La,0,n);else if(gt(n,"readystatechange"),Kt(n)==4){n.h=!1;try{let o=n.da();t:switch(o){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var t=!0;break t;default:t=!1}var e;if(!(e=t)){var r;if(r=o===0){var i=String(n.I).match(Dh)[1]||null;!i&&D.self&&D.self.location&&(i=D.self.location.protocol.slice(0,-1)),r=!Fp.test(i?i.toLowerCase():"")}e=r}if(e)gt(n,"complete"),gt(n,"success");else{n.m=6;try{var s=2<Kt(n)?n.g.statusText:""}catch{s=""}n.j=s+" ["+n.da()+"]",Uh(n)}}finally{Xi(n)}}}}function Xi(n,t){if(n.g){zh(n);let e=n.g,r=n.C[0]?()=>{}:null;n.g=null,n.C=null,t||gt(n,"ready");try{e.onreadystatechange=r}catch{}}}function zh(n){n.g&&n.L&&(n.g.ontimeout=null),n.A&&(D.clearTimeout(n.A),n.A=null)}T.isActive=function(){return!!this.g};function Kt(n){return n.g?n.g.readyState:0}T.da=function(){try{return 2<Kt(this)?this.g.status:-1}catch{return-1}};T.ja=function(){try{return this.g?this.g.responseText:""}catch{return""}};T.Wa=function(n){if(this.g){var t=this.g.responseText;return n&&t.indexOf(n)==0&&(t=t.substring(n.length)),kp(t)}};function Xl(n){try{if(!n.g)return null;if("response"in n.g)return n.g.response;switch(n.K){case Bh:case"text":return n.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in n.g)return n.g.mozResponseArrayBuffer}return null}catch{return null}}function Op(n){let t={};n=(n.g&&2<=Kt(n)&&n.g.getAllResponseHeaders()||"").split(`\r
`);for(let r=0;r<n.length;r++){if(_r(n[r]))continue;var e=lp(n[r]);let i=e[0];if(e=e[1],typeof e!="string")continue;e=e.trim();let s=t[i]||[];t[i]=s,s.push(e)}op(t,function(r){return r.join(", ")})}T.Ia=function(){return this.m};T.Sa=function(){return typeof this.j=="string"?this.j:String(this.j)};function jh(n){let t="";return ea(n,function(e,r){t+=r,t+=":",t+=e,t+=`\r
`}),t}function ga(n,t,e){t:{for(r in e){var r=!1;break t}r=!0}r||(e=jh(e),typeof n=="string"?e!=null&&encodeURIComponent(String(e)):K(n,t,e))}function dr(n,t,e){return e&&e.internalChannelParams&&e.internalChannelParams[n]||t}function Kh(n){this.Ga=0,this.j=[],this.l=new Ki,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=dr("failFast",!1,n),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=dr("baseRetryDelayMs",5e3,n),this.hb=dr("retryDelaySeedMs",1e4,n),this.eb=dr("forwardChannelMaxRetries",2,n),this.xa=dr("forwardChannelRequestTimeoutMs",2e4,n),this.va=n&&n.xmlHttpFactory||void 0,this.Ha=n&&n.useFetchStreams||!1,this.L=void 0,this.J=n&&n.supportsCrossDomainXhr||!1,this.K="",this.i=new kh(n&&n.concurrentRequestLimit),this.Ja=new Cp,this.P=n&&n.fastHandshake||!1,this.O=n&&n.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=n&&n.bc||!1,n&&n.Ea&&this.l.Ea(),n&&n.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&n&&n.detectBufferingProxy||!1,this.qa=void 0,n&&n.longPollingTimeout&&0<n.longPollingTimeout&&(this.qa=n.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}T=Kh.prototype;T.ra=8;T.H=1;function pa(n){if($h(n),n.H==3){var t=n.W++,e=se(n.I);if(K(e,"SID",n.K),K(e,"RID",t),K(e,"TYPE","terminate"),Nr(n,e),t=new xr(n,n.l,t),t.L=2,t.A=Ji(se(e)),e=!1,D.navigator&&D.navigator.sendBeacon)try{e=D.navigator.sendBeacon(t.A.toString(),"")}catch{}!e&&D.Image&&(new Image().src=t.A,e=!0),e||(t.g=td(t.l,null),t.g.ha(t.A)),t.G=Date.now(),Dr(t)}Xh(n)}function Zi(n){n.g&&(ya(n),n.g.cancel(),n.g=null)}function $h(n){Zi(n),n.u&&(D.clearTimeout(n.u),n.u=null),Mi(n),n.i.cancel(),n.m&&(typeof n.m=="number"&&D.clearTimeout(n.m),n.m=null)}function ts(n){if(!Fh(n.i)&&!n.m){n.m=!0;var t=n.Na;wr||mh(),vr||(wr(),vr=!0),aa.add(t,n),n.C=0}}function qp(n,t){return Mh(n.i)>=n.i.j-(n.m?1:0)?!1:n.m?(n.j=t.F.concat(n.j),!0):n.H==1||n.H==2||n.C>=(n.cb?0:n.eb)?!1:(n.m=Pr(_t(n.Na,n,t),Yh(n,n.C)),n.C++,!0)}T.Na=function(n){if(this.m)if(this.m=null,this.H==1){if(!n){this.W=Math.floor(1e5*Math.random()),n=this.W++;let i=new xr(this,this.l,n),s=this.s;if(this.U&&(s?(s=oh(s),ah(s,this.U)):s=this.U),this.o!==null||this.O||(i.I=s,s=null),this.P)t:{for(var t=0,e=0;e<this.j.length;e++){e:{var r=this.j[e];if("__data__"in r.map&&(r=r.map.__data__,typeof r=="string")){r=r.length;break e}r=void 0}if(r===void 0)break;if(t+=r,4096<t){t=e;break t}if(t===4096||e===this.j.length-1){t=e+1;break t}}t=1e3}else t=1e3;t=Qh(this,i,t),e=se(this.I),K(e,"RID",n),K(e,"CVER",22),this.F&&K(e,"X-HTTP-Session-Id",this.F),Nr(this,e),s&&(this.O?t="headers="+encodeURIComponent(String(jh(s)))+"&"+t:this.o&&ga(e,this.o,s)),fa(this.i,i),this.bb&&K(e,"TYPE","init"),this.P?(K(e,"$req",t),K(e,"SID","null"),i.aa=!0,Qo(i,e,null)):Qo(i,e,t),this.H=2}}else this.H==3&&(n?Zl(this,n):this.j.length==0||Fh(this.i)||Zl(this))};function Zl(n,t){var e;t?e=t.m:e=n.W++;let r=se(n.I);K(r,"SID",n.K),K(r,"RID",e),K(r,"AID",n.V),Nr(n,r),n.o&&n.s&&ga(r,n.o,n.s),e=new xr(n,n.l,e,n.C+1),n.o===null&&(e.I=n.s),t&&(n.j=t.F.concat(n.j)),t=Qh(n,e,1e3),e.setTimeout(Math.round(.5*n.xa)+Math.round(.5*n.xa*Math.random())),fa(n.i,e),Qo(e,r,t)}function Nr(n,t){n.na&&ea(n.na,function(e,r){K(t,r,e)}),n.h&&xh({},function(e,r){K(t,r,e)})}function Qh(n,t,e){e=Math.min(n.j.length,e);var r=n.h?_t(n.h.Va,n.h,n):null;t:{var i=n.j;let s=-1;for(;;){let o=["count="+e];s==-1?0<e?(s=i[0].g,o.push("ofs="+s)):s=0:o.push("ofs="+s);let a=!0;for(let u=0;u<e;u++){let c=i[u].g,l=i[u].map;if(c-=s,0>c)s=Math.max(0,i[u].g-100),a=!1;else try{Vp(l,o,"req"+c+"_")}catch{r&&r(l)}}if(a){r=o.join("&");break t}}}return n=n.j.splice(0,e),t.F=n,r}function Wh(n){if(!n.g&&!n.u){n.ba=1;var t=n.Ma;wr||mh(),vr||(wr(),vr=!0),aa.add(t,n),n.A=0}}function _a(n){return n.g||n.u||3<=n.A?!1:(n.ba++,n.u=Pr(_t(n.Ma,n),Yh(n,n.A)),n.A++,!0)}T.Ma=function(){if(this.u=null,Hh(this),this.ca&&!(this.M||this.g==null||0>=this.S)){var n=2*this.S;this.l.info("BP detection timer enabled: "+n),this.B=Pr(_t(this.jb,this),n)}};T.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,It(10),Zi(this),Hh(this))};function ya(n){n.B!=null&&(D.clearTimeout(n.B),n.B=null)}function Hh(n){n.g=new xr(n,n.l,"rpc",n.ba),n.o===null&&(n.g.I=n.s),n.g.O=0;var t=se(n.wa);K(t,"RID","rpc"),K(t,"SID",n.K),K(t,"AID",n.V),K(t,"CI",n.G?"0":"1"),!n.G&&n.qa&&K(t,"TO",n.qa),K(t,"TYPE","xmlhttp"),Nr(n,t),n.o&&n.s&&ga(t,n.o,n.s),n.L&&n.g.setTimeout(n.L);var e=n.g;n=n.pa,e.L=1,e.A=Ji(se(t)),e.u=null,e.S=!0,Sh(e,n)}T.ib=function(){this.v!=null&&(this.v=null,Zi(this),_a(this),It(19))};function Mi(n){n.v!=null&&(D.clearTimeout(n.v),n.v=null)}function Jh(n,t){var e=null;if(n.g==t){Mi(n),ya(n),n.g=null;var r=2}else if(Ho(n.i,t))e=t.F,Lh(n.i,t),r=1;else return;if(n.H!=0){if(t.i)if(r==1){e=t.u?t.u.length:0,t=Date.now()-t.G;var i=n.C;r=$i(),gt(r,new vh(r,e)),ts(n)}else Wh(n);else if(i=t.s,i==3||i==0&&0<t.ca||!(r==1&&qp(n,t)||r==2&&_a(n)))switch(e&&0<e.length&&(t=n.i,t.i=t.i.concat(e)),i){case 1:Le(n,5);break;case 4:Le(n,10);break;case 3:Le(n,6);break;default:Le(n,2)}}}function Yh(n,t){let e=n.ab+Math.floor(Math.random()*n.hb);return n.isActive()||(e*=2),e*t}function Le(n,t){if(n.l.info("Error code "+t),t==2){var e=null;n.h&&(e=null);var r=_t(n.pb,n);e||(e=new Oe("//www.google.com/images/cleardot.gif"),D.location&&D.location.protocol=="http"||ki(e,"https"),Ji(e)),Np(e.toString(),r)}else It(2);n.H=0,n.h&&n.h.za(t),Xh(n),$h(n)}T.pb=function(n){n?(this.l.info("Successfully pinged google.com"),It(2)):(this.l.info("Failed to ping google.com"),It(1))};function Xh(n){if(n.H=0,n.ma=[],n.h){let t=Oh(n.i);(t.length!=0||n.j.length!=0)&&(jl(n.ma,t),jl(n.ma,n.j),n.i.i.length=0,Zo(n.j),n.j.length=0),n.h.ya()}}function Zh(n,t,e){var r=e instanceof Oe?se(e):new Oe(e);if(r.g!="")t&&(r.g=t+"."+r.g),Fi(r,r.m);else{var i=D.location;r=i.protocol,t=t?t+"."+i.hostname:i.hostname,i=+i.port;var s=new Oe(null);r&&ki(s,r),t&&(s.g=t),i&&Fi(s,i),e&&(s.l=e),r=s}return e=n.F,t=n.Da,e&&t&&K(r,e,t),K(r,"VER",n.ra),Nr(n,r),r}function td(n,t,e){if(t&&!n.J)throw Error("Can't create secondary domain capable XhrIo object.");return t=n.Ha&&!n.va?new J(new Cr({ob:e})):new J(n.va),t.Oa(n.J),t}T.isActive=function(){return!!this.h&&this.h.isActive(this)};function ed(){}T=ed.prototype;T.Ba=function(){};T.Aa=function(){};T.za=function(){};T.ya=function(){};T.isActive=function(){return!0};T.Va=function(){};function Li(){if(wn&&!(10<=Number(np)))throw Error("Environmental error: no available transport.")}Li.prototype.g=function(n,t){return new Pt(n,t)};function Pt(n,t){lt.call(this),this.g=new Kh(t),this.l=n,this.h=t&&t.messageUrlParams||null,n=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(n?n["X-Client-Protocol"]="webchannel":n={"X-Client-Protocol":"webchannel"}),this.g.s=n,n=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(n?n["X-WebChannel-Content-Type"]=t.messageContentType:n={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.Ca&&(n?n["X-WebChannel-Client-Profile"]=t.Ca:n={"X-WebChannel-Client-Profile":t.Ca}),this.g.U=n,(n=t&&t.cc)&&!_r(n)&&(this.g.o=n),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!_r(t)&&(this.g.F=t,n=this.h,n!==null&&t in n&&(n=this.h,t in n&&delete n[t])),this.j=new In(this)}ht(Pt,lt);Pt.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var n=this.g,t=this.l,e=this.h||void 0;It(0),n.Y=t,n.na=e||{},n.G=n.aa,n.I=Zh(n,null,n.Y),ts(n)};Pt.prototype.close=function(){pa(this.g)};Pt.prototype.u=function(n){var t=this.g;if(typeof n=="string"){var e={};e.__data__=n,n=e}else this.v&&(e={},e.__data__=oa(n),n=e);t.j.push(new bp(t.fb++,n)),t.H==3&&ts(t)};Pt.prototype.N=function(){this.g.h=null,delete this.j,pa(this.g),delete this.g,Pt.$.N.call(this)};function nd(n){ha.call(this),n.__headers__&&(this.headers=n.__headers__,this.statusCode=n.__status__,delete n.__headers__,delete n.__status__);var t=n.__sm__;if(t){t:{for(let e in t){n=e;break t}n=void 0}(this.i=n)&&(n=this.i,t=t!==null&&n in t?t[n]:void 0),this.data=t}else this.data=n}ht(nd,ha);function rd(){da.call(this),this.status=1}ht(rd,da);function In(n){this.g=n}ht(In,ed);In.prototype.Ba=function(){gt(this.g,"a")};In.prototype.Aa=function(n){gt(this.g,new nd(n))};In.prototype.za=function(n){gt(this.g,new rd)};In.prototype.ya=function(){gt(this.g,"b")};function Bp(){this.blockSize=-1}function Mt(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}ht(Mt,Bp);Mt.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0};function Fo(n,t,e){e||(e=0);var r=Array(16);if(typeof t=="string")for(var i=0;16>i;++i)r[i]=t.charCodeAt(e++)|t.charCodeAt(e++)<<8|t.charCodeAt(e++)<<16|t.charCodeAt(e++)<<24;else for(i=0;16>i;++i)r[i]=t[e++]|t[e++]<<8|t[e++]<<16|t[e++]<<24;t=n.g[0],e=n.g[1],i=n.g[2];var s=n.g[3],o=t+(s^e&(i^s))+r[0]+3614090360&4294967295;t=e+(o<<7&4294967295|o>>>25),o=s+(i^t&(e^i))+r[1]+3905402710&4294967295,s=t+(o<<12&4294967295|o>>>20),o=i+(e^s&(t^e))+r[2]+606105819&4294967295,i=s+(o<<17&4294967295|o>>>15),o=e+(t^i&(s^t))+r[3]+3250441966&4294967295,e=i+(o<<22&4294967295|o>>>10),o=t+(s^e&(i^s))+r[4]+4118548399&4294967295,t=e+(o<<7&4294967295|o>>>25),o=s+(i^t&(e^i))+r[5]+1200080426&4294967295,s=t+(o<<12&4294967295|o>>>20),o=i+(e^s&(t^e))+r[6]+2821735955&4294967295,i=s+(o<<17&4294967295|o>>>15),o=e+(t^i&(s^t))+r[7]+4249261313&4294967295,e=i+(o<<22&4294967295|o>>>10),o=t+(s^e&(i^s))+r[8]+1770035416&4294967295,t=e+(o<<7&4294967295|o>>>25),o=s+(i^t&(e^i))+r[9]+2336552879&4294967295,s=t+(o<<12&4294967295|o>>>20),o=i+(e^s&(t^e))+r[10]+4294925233&4294967295,i=s+(o<<17&4294967295|o>>>15),o=e+(t^i&(s^t))+r[11]+2304563134&4294967295,e=i+(o<<22&4294967295|o>>>10),o=t+(s^e&(i^s))+r[12]+1804603682&4294967295,t=e+(o<<7&4294967295|o>>>25),o=s+(i^t&(e^i))+r[13]+4254626195&4294967295,s=t+(o<<12&4294967295|o>>>20),o=i+(e^s&(t^e))+r[14]+2792965006&4294967295,i=s+(o<<17&4294967295|o>>>15),o=e+(t^i&(s^t))+r[15]+1236535329&4294967295,e=i+(o<<22&4294967295|o>>>10),o=t+(i^s&(e^i))+r[1]+4129170786&4294967295,t=e+(o<<5&4294967295|o>>>27),o=s+(e^i&(t^e))+r[6]+3225465664&4294967295,s=t+(o<<9&4294967295|o>>>23),o=i+(t^e&(s^t))+r[11]+643717713&4294967295,i=s+(o<<14&4294967295|o>>>18),o=e+(s^t&(i^s))+r[0]+3921069994&4294967295,e=i+(o<<20&4294967295|o>>>12),o=t+(i^s&(e^i))+r[5]+3593408605&4294967295,t=e+(o<<5&4294967295|o>>>27),o=s+(e^i&(t^e))+r[10]+38016083&4294967295,s=t+(o<<9&4294967295|o>>>23),o=i+(t^e&(s^t))+r[15]+3634488961&4294967295,i=s+(o<<14&4294967295|o>>>18),o=e+(s^t&(i^s))+r[4]+3889429448&4294967295,e=i+(o<<20&4294967295|o>>>12),o=t+(i^s&(e^i))+r[9]+568446438&4294967295,t=e+(o<<5&4294967295|o>>>27),o=s+(e^i&(t^e))+r[14]+3275163606&4294967295,s=t+(o<<9&4294967295|o>>>23),o=i+(t^e&(s^t))+r[3]+4107603335&4294967295,i=s+(o<<14&4294967295|o>>>18),o=e+(s^t&(i^s))+r[8]+1163531501&4294967295,e=i+(o<<20&4294967295|o>>>12),o=t+(i^s&(e^i))+r[13]+2850285829&4294967295,t=e+(o<<5&4294967295|o>>>27),o=s+(e^i&(t^e))+r[2]+4243563512&4294967295,s=t+(o<<9&4294967295|o>>>23),o=i+(t^e&(s^t))+r[7]+1735328473&4294967295,i=s+(o<<14&4294967295|o>>>18),o=e+(s^t&(i^s))+r[12]+2368359562&4294967295,e=i+(o<<20&4294967295|o>>>12),o=t+(e^i^s)+r[5]+4294588738&4294967295,t=e+(o<<4&4294967295|o>>>28),o=s+(t^e^i)+r[8]+2272392833&4294967295,s=t+(o<<11&4294967295|o>>>21),o=i+(s^t^e)+r[11]+1839030562&4294967295,i=s+(o<<16&4294967295|o>>>16),o=e+(i^s^t)+r[14]+4259657740&4294967295,e=i+(o<<23&4294967295|o>>>9),o=t+(e^i^s)+r[1]+2763975236&4294967295,t=e+(o<<4&4294967295|o>>>28),o=s+(t^e^i)+r[4]+1272893353&4294967295,s=t+(o<<11&4294967295|o>>>21),o=i+(s^t^e)+r[7]+4139469664&4294967295,i=s+(o<<16&4294967295|o>>>16),o=e+(i^s^t)+r[10]+3200236656&4294967295,e=i+(o<<23&4294967295|o>>>9),o=t+(e^i^s)+r[13]+681279174&4294967295,t=e+(o<<4&4294967295|o>>>28),o=s+(t^e^i)+r[0]+3936430074&4294967295,s=t+(o<<11&4294967295|o>>>21),o=i+(s^t^e)+r[3]+3572445317&4294967295,i=s+(o<<16&4294967295|o>>>16),o=e+(i^s^t)+r[6]+76029189&4294967295,e=i+(o<<23&4294967295|o>>>9),o=t+(e^i^s)+r[9]+3654602809&4294967295,t=e+(o<<4&4294967295|o>>>28),o=s+(t^e^i)+r[12]+3873151461&4294967295,s=t+(o<<11&4294967295|o>>>21),o=i+(s^t^e)+r[15]+530742520&4294967295,i=s+(o<<16&4294967295|o>>>16),o=e+(i^s^t)+r[2]+3299628645&4294967295,e=i+(o<<23&4294967295|o>>>9),o=t+(i^(e|~s))+r[0]+4096336452&4294967295,t=e+(o<<6&4294967295|o>>>26),o=s+(e^(t|~i))+r[7]+1126891415&4294967295,s=t+(o<<10&4294967295|o>>>22),o=i+(t^(s|~e))+r[14]+2878612391&4294967295,i=s+(o<<15&4294967295|o>>>17),o=e+(s^(i|~t))+r[5]+4237533241&4294967295,e=i+(o<<21&4294967295|o>>>11),o=t+(i^(e|~s))+r[12]+1700485571&4294967295,t=e+(o<<6&4294967295|o>>>26),o=s+(e^(t|~i))+r[3]+2399980690&4294967295,s=t+(o<<10&4294967295|o>>>22),o=i+(t^(s|~e))+r[10]+4293915773&4294967295,i=s+(o<<15&4294967295|o>>>17),o=e+(s^(i|~t))+r[1]+2240044497&4294967295,e=i+(o<<21&4294967295|o>>>11),o=t+(i^(e|~s))+r[8]+1873313359&4294967295,t=e+(o<<6&4294967295|o>>>26),o=s+(e^(t|~i))+r[15]+4264355552&4294967295,s=t+(o<<10&4294967295|o>>>22),o=i+(t^(s|~e))+r[6]+2734768916&4294967295,i=s+(o<<15&4294967295|o>>>17),o=e+(s^(i|~t))+r[13]+1309151649&4294967295,e=i+(o<<21&4294967295|o>>>11),o=t+(i^(e|~s))+r[4]+4149444226&4294967295,t=e+(o<<6&4294967295|o>>>26),o=s+(e^(t|~i))+r[11]+3174756917&4294967295,s=t+(o<<10&4294967295|o>>>22),o=i+(t^(s|~e))+r[2]+718787259&4294967295,i=s+(o<<15&4294967295|o>>>17),o=e+(s^(i|~t))+r[9]+3951481745&4294967295,n.g[0]=n.g[0]+t&4294967295,n.g[1]=n.g[1]+(i+(o<<21&4294967295|o>>>11))&4294967295,n.g[2]=n.g[2]+i&4294967295,n.g[3]=n.g[3]+s&4294967295}Mt.prototype.j=function(n,t){t===void 0&&(t=n.length);for(var e=t-this.blockSize,r=this.m,i=this.h,s=0;s<t;){if(i==0)for(;s<=e;)Fo(this,n,s),s+=this.blockSize;if(typeof n=="string"){for(;s<t;)if(r[i++]=n.charCodeAt(s++),i==this.blockSize){Fo(this,r),i=0;break}}else for(;s<t;)if(r[i++]=n[s++],i==this.blockSize){Fo(this,r),i=0;break}}this.h=i,this.i+=t};Mt.prototype.l=function(){var n=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);n[0]=128;for(var t=1;t<n.length-8;++t)n[t]=0;var e=8*this.i;for(t=n.length-8;t<n.length;++t)n[t]=e&255,e/=256;for(this.j(n),n=Array(16),t=e=0;4>t;++t)for(var r=0;32>r;r+=8)n[e++]=this.g[t]>>>r&255;return n};function U(n,t){this.h=t;for(var e=[],r=!0,i=n.length-1;0<=i;i--){var s=n[i]|0;r&&s==t||(e[i]=s,r=!1)}this.g=e}var Up={};function wa(n){return-128<=n&&128>n?Zg(n,function(t){return new U([t|0],0>t?-1:0)}):new U([n|0],0>n?-1:0)}function $t(n){if(isNaN(n)||!isFinite(n))return yn;if(0>n)return mt($t(-n));for(var t=[],e=1,r=0;n>=e;r++)t[r]=n/e|0,e*=Jo;return new U(t,0)}function id(n,t){if(n.length==0)throw Error("number format error: empty string");if(t=t||10,2>t||36<t)throw Error("radix out of range: "+t);if(n.charAt(0)=="-")return mt(id(n.substring(1),t));if(0<=n.indexOf("-"))throw Error('number format error: interior "-" character');for(var e=$t(Math.pow(t,8)),r=yn,i=0;i<n.length;i+=8){var s=Math.min(8,n.length-i),o=parseInt(n.substring(i,i+s),t);8>s?(s=$t(Math.pow(t,s)),r=r.R(s).add($t(o))):(r=r.R(e),r=r.add($t(o)))}return r}var Jo=4294967296,yn=wa(0),Yo=wa(1),th=wa(16777216);T=U.prototype;T.ea=function(){if(Ct(this))return-mt(this).ea();for(var n=0,t=1,e=0;e<this.g.length;e++){var r=this.D(e);n+=(0<=r?r:Jo+r)*t,t*=Jo}return n};T.toString=function(n){if(n=n||10,2>n||36<n)throw Error("radix out of range: "+n);if(ie(this))return"0";if(Ct(this))return"-"+mt(this).toString(n);for(var t=$t(Math.pow(n,6)),e=this,r="";;){var i=qi(e,t).g;e=Oi(e,i.R(t));var s=((0<e.g.length?e.g[0]:e.h)>>>0).toString(n);if(e=i,ie(e))return s+r;for(;6>s.length;)s="0"+s;r=s+r}};T.D=function(n){return 0>n?0:n<this.g.length?this.g[n]:this.h};function ie(n){if(n.h!=0)return!1;for(var t=0;t<n.g.length;t++)if(n.g[t]!=0)return!1;return!0}function Ct(n){return n.h==-1}T.X=function(n){return n=Oi(this,n),Ct(n)?-1:ie(n)?0:1};function mt(n){for(var t=n.g.length,e=[],r=0;r<t;r++)e[r]=~n.g[r];return new U(e,~n.h).add(Yo)}T.abs=function(){return Ct(this)?mt(this):this};T.add=function(n){for(var t=Math.max(this.g.length,n.g.length),e=[],r=0,i=0;i<=t;i++){var s=r+(this.D(i)&65535)+(n.D(i)&65535),o=(s>>>16)+(this.D(i)>>>16)+(n.D(i)>>>16);r=o>>>16,s&=65535,o&=65535,e[i]=o<<16|s}return new U(e,e[e.length-1]&-2147483648?-1:0)};function Oi(n,t){return n.add(mt(t))}T.R=function(n){if(ie(this)||ie(n))return yn;if(Ct(this))return Ct(n)?mt(this).R(mt(n)):mt(mt(this).R(n));if(Ct(n))return mt(this.R(mt(n)));if(0>this.X(th)&&0>n.X(th))return $t(this.ea()*n.ea());for(var t=this.g.length+n.g.length,e=[],r=0;r<2*t;r++)e[r]=0;for(r=0;r<this.g.length;r++)for(var i=0;i<n.g.length;i++){var s=this.D(r)>>>16,o=this.D(r)&65535,a=n.D(i)>>>16,u=n.D(i)&65535;e[2*r+2*i]+=o*u,Ni(e,2*r+2*i),e[2*r+2*i+1]+=s*u,Ni(e,2*r+2*i+1),e[2*r+2*i+1]+=o*a,Ni(e,2*r+2*i+1),e[2*r+2*i+2]+=s*a,Ni(e,2*r+2*i+2)}for(r=0;r<t;r++)e[r]=e[2*r+1]<<16|e[2*r];for(r=t;r<2*t;r++)e[r]=0;return new U(e,0)};function Ni(n,t){for(;(n[t]&65535)!=n[t];)n[t+1]+=n[t]>>>16,n[t]&=65535,t++}function fr(n,t){this.g=n,this.h=t}function qi(n,t){if(ie(t))throw Error("division by zero");if(ie(n))return new fr(yn,yn);if(Ct(n))return t=qi(mt(n),t),new fr(mt(t.g),mt(t.h));if(Ct(t))return t=qi(n,mt(t)),new fr(mt(t.g),t.h);if(30<n.g.length){if(Ct(n)||Ct(t))throw Error("slowDivide_ only works with positive integers.");for(var e=Yo,r=t;0>=r.X(n);)e=eh(e),r=eh(r);var i=pn(e,1),s=pn(r,1);for(r=pn(r,2),e=pn(e,2);!ie(r);){var o=s.add(r);0>=o.X(n)&&(i=i.add(e),s=o),r=pn(r,1),e=pn(e,1)}return t=Oi(n,i.R(t)),new fr(i,t)}for(i=yn;0<=n.X(t);){for(e=Math.max(1,Math.floor(n.ea()/t.ea())),r=Math.ceil(Math.log(e)/Math.LN2),r=48>=r?1:Math.pow(2,r-48),s=$t(e),o=s.R(t);Ct(o)||0<o.X(n);)e-=r,s=$t(e),o=s.R(t);ie(s)&&(s=Yo),i=i.add(s),n=Oi(n,o)}return new fr(i,n)}T.gb=function(n){return qi(this,n).h};T.and=function(n){for(var t=Math.max(this.g.length,n.g.length),e=[],r=0;r<t;r++)e[r]=this.D(r)&n.D(r);return new U(e,this.h&n.h)};T.or=function(n){for(var t=Math.max(this.g.length,n.g.length),e=[],r=0;r<t;r++)e[r]=this.D(r)|n.D(r);return new U(e,this.h|n.h)};T.xor=function(n){for(var t=Math.max(this.g.length,n.g.length),e=[],r=0;r<t;r++)e[r]=this.D(r)^n.D(r);return new U(e,this.h^n.h)};function eh(n){for(var t=n.g.length+1,e=[],r=0;r<t;r++)e[r]=n.D(r)<<1|n.D(r-1)>>>31;return new U(e,n.h)}function pn(n,t){var e=t>>5;t%=32;for(var r=n.g.length-e,i=[],s=0;s<r;s++)i[s]=0<t?n.D(s+e)>>>t|n.D(s+e+1)<<32-t:n.D(s+e);return new U(i,n.h)}Li.prototype.createWebChannel=Li.prototype.g;Pt.prototype.send=Pt.prototype.u;Pt.prototype.open=Pt.prototype.m;Pt.prototype.close=Pt.prototype.close;Qi.NO_ERROR=0;Qi.TIMEOUT=8;Qi.HTTP_ERROR=6;Ih.COMPLETE="complete";Eh.EventType=br;br.OPEN="a";br.CLOSE="b";br.ERROR="c";br.MESSAGE="d";lt.prototype.listen=lt.prototype.O;J.prototype.listenOnce=J.prototype.P;J.prototype.getLastError=J.prototype.Sa;J.prototype.getLastErrorCode=J.prototype.Ia;J.prototype.getStatus=J.prototype.da;J.prototype.getResponseJson=J.prototype.Wa;J.prototype.getResponseText=J.prototype.ja;J.prototype.send=J.prototype.ha;J.prototype.setWithCredentials=J.prototype.Oa;Mt.prototype.digest=Mt.prototype.l;Mt.prototype.reset=Mt.prototype.reset;Mt.prototype.update=Mt.prototype.j;U.prototype.add=U.prototype.add;U.prototype.multiply=U.prototype.R;U.prototype.modulo=U.prototype.gb;U.prototype.compare=U.prototype.X;U.prototype.toNumber=U.prototype.ea;U.prototype.toString=U.prototype.toString;U.prototype.getBits=U.prototype.D;U.fromNumber=$t;U.fromString=id;var sd=Lt.createWebChannelTransport=function(){return new Li},od=Lt.getStatEventTarget=function(){return $i()},es=Lt.ErrorCode=Qi,ad=Lt.EventType=Ih,ud=Lt.Event=qe,va=Lt.Stat={xb:0,Ab:1,Bb:2,Ub:3,Zb:4,Wb:5,Xb:6,Vb:7,Tb:8,Yb:9,PROXY:10,NOPROXY:11,Rb:12,Nb:13,Ob:14,Mb:15,Pb:16,Qb:17,tb:18,sb:19,ub:20},cd=Lt.FetchXmlHttpFactory=Cr,kr=Lt.WebChannel=Eh,ld=Lt.XhrIo=J,hd=Lt.Md5=Mt,Be=Lt.Integer=U;var dd="@firebase/firestore";var ot=class{constructor(t){this.uid=t}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}};ot.UNAUTHENTICATED=new ot(null),ot.GOOGLE_CREDENTIALS=new ot("google-credentials-uid"),ot.FIRST_PARTY=new ot("first-party-uid"),ot.MOCK_USER=new ot("mock-user");var Xn="10.11.1";var Te=new Pl("@firebase/firestore");function Rn(){return Te.logLevel}function ff(n){Te.setLogLevel(n)}function y(n,...t){if(Te.logLevel<=zt.DEBUG){let e=t.map(Tc);Te.debug(`Firestore (${Xn}): ${n}`,...e)}}function Z(n,...t){if(Te.logLevel<=zt.ERROR){let e=t.map(Tc);Te.error(`Firestore (${Xn}): ${n}`,...e)}}function Nt(n,...t){if(Te.logLevel<=zt.WARN){let e=t.map(Tc);Te.warn(`Firestore (${Xn}): ${n}`,...e)}}function Tc(n){if(typeof n=="string")return n;try{return function(e){return JSON.stringify(e)}(n)}catch{return n}}function S(n="Unexpected state"){let t=`FIRESTORE (${Xn}) INTERNAL ASSERTION FAILED: `+n;throw Z(t),new Error(t)}function R(n,t){n||S()}function mf(n,t){n||S()}function E(n,t){return n}var g={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},_=class extends Rl{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}};var at=class{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}};var ds=class{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}},Sa=class{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(ot.UNAUTHENTICATED))}shutdown(){}},Ra=class{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable(()=>e(this.token.user))}shutdown(){this.changeListener=null}},Pa=class{constructor(t){this.t=t,this.currentUser=ot.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let r=this.i,i=u=>this.i!==r?(r=this.i,e(u)):Promise.resolve(),s=new at;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new at,t.enqueueRetryable(()=>i(this.currentUser))};let o=()=>{let u=s;t.enqueueRetryable(()=>p(this,null,function*(){yield u.promise,yield i(this.currentUser)}))},a=u=>{y("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=u,this.auth.addAuthTokenListener(this.o),o()};this.t.onInit(u=>a(u)),setTimeout(()=>{if(!this.auth){let u=this.t.getImmediate({optional:!0});u?a(u):(y("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new at)}},0),o()}getToken(){let t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(r=>this.i!==t?(y("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):r?(R(typeof r.accessToken=="string"),new ds(r.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){let t=this.auth&&this.auth.getUid();return R(t===null||typeof t=="string"),new ot(t)}},ba=class{constructor(t,e,r){this.l=t,this.h=e,this.P=r,this.type="FirstParty",this.user=ot.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);let t=this.T();return t&&this.I.set("Authorization",t),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}},xa=class{constructor(t,e,r){this.l=t,this.h=e,this.P=r}getToken(){return Promise.resolve(new ba(this.l,this.h,this.P))}start(t,e){t.enqueueRetryable(()=>e(ot.FIRST_PARTY))}shutdown(){}invalidateToken(){}},Da=class{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}},Ca=class{constructor(t){this.A=t,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,e){let r=s=>{s.error!=null&&y("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${s.error.message}`);let o=s.token!==this.R;return this.R=s.token,y("FirebaseAppCheckTokenProvider",`Received ${o?"new":"existing"} token.`),o?e(s.token):Promise.resolve()};this.o=s=>{t.enqueueRetryable(()=>r(s))};let i=s=>{y("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=s,this.appCheck.addTokenListener(this.o)};this.A.onInit(s=>i(s)),setTimeout(()=>{if(!this.appCheck){let s=this.A.getImmediate({optional:!0});s?i(s):y("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){let t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then(e=>e?(R(typeof e.token=="string"),this.R=e.token,new Da(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}};function Gp(n){let t=typeof self<"u"&&(self.crypto||self.msCrypto),e=new Uint8Array(n);if(t&&typeof t.getRandomValues=="function")t.getRandomValues(e);else for(let r=0;r<n;r++)e[r]=Math.floor(256*Math.random());return e}var fs=class{static newId(){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length,r="";for(;r.length<20;){let i=Gp(40);for(let s=0;s<i.length;++s)r.length<20&&i[s]<e&&(r+=t.charAt(i[s]%t.length))}return r}};function C(n,t){return n<t?-1:n>t?1:0}function Fn(n,t,e){return n.length===t.length&&n.every((r,i)=>e(r,t[i]))}function gf(n){return n+"\0"}var W=class n{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new _(g.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new _(g.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new _(g.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new _(g.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return n.fromMillis(Date.now())}static fromDate(t){return n.fromMillis(t.getTime())}static fromMillis(t){let e=Math.floor(t/1e3),r=Math.floor(1e6*(t-1e3*e));return new n(e,r)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?C(this.nanoseconds,t.nanoseconds):C(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){let t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}};var P=class n{constructor(t){this.timestamp=t}static fromTimestamp(t){return new n(t)}static min(){return new n(new W(0,0))}static max(){return new n(new W(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}};var ms=class n{constructor(t,e,r){e===void 0?e=0:e>t.length&&S(),r===void 0?r=t.length-e:r>t.length-e&&S(),this.segments=t,this.offset=e,this.len=r}get length(){return this.len}isEqual(t){return n.comparator(this,t)===0}child(t){let e=this.segments.slice(this.offset,this.limit());return t instanceof n?t.forEach(r=>{e.push(r)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=t===void 0?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return this.length===0}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,r=this.limit();e<r;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){let r=Math.min(t.length,e.length);for(let i=0;i<r;i++){let s=t.get(i),o=e.get(i);if(s<o)return-1;if(s>o)return 1}return t.length<e.length?-1:t.length>e.length?1:0}},M=class n extends ms{construct(t,e,r){return new n(t,e,r)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...t){let e=[];for(let r of t){if(r.indexOf("//")>=0)throw new _(g.INVALID_ARGUMENT,`Invalid segment (${r}). Paths must not contain // in them.`);e.push(...r.split("/").filter(i=>i.length>0))}return new n(e)}static emptyPath(){return new n([])}},zp=/^[_a-zA-Z][_a-zA-Z0-9]*$/,tt=class n extends ms{construct(t,e,r){return new n(t,e,r)}static isValidIdentifier(t){return zp.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),n.isValidIdentifier(t)||(t="`"+t+"`"),t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)==="__name__"}static keyField(){return new n(["__name__"])}static fromServerFormat(t){let e=[],r="",i=0,s=()=>{if(r.length===0)throw new _(g.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(r),r=""},o=!1;for(;i<t.length;){let a=t[i];if(a==="\\"){if(i+1===t.length)throw new _(g.INVALID_ARGUMENT,"Path has trailing escape character: "+t);let u=t[i+1];if(u!=="\\"&&u!=="."&&u!=="`")throw new _(g.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);r+=u,i+=2}else a==="`"?(o=!o,i++):a!=="."||o?(r+=a,i++):(s(),i++)}if(s(),o)throw new _(g.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new n(e)}static emptyPath(){return new n([])}};var I=class n{constructor(t){this.path=t}static fromPath(t){return new n(M.fromString(t))}static fromName(t){return new n(M.fromString(t).popFirst(5))}static empty(){return new n(M.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return t!==null&&M.comparator(this.path,t.path)===0}toString(){return this.path.toString()}static comparator(t,e){return M.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new n(new M(t.slice()))}};var Mn=class{constructor(t,e,r,i){this.indexId=t,this.collectionGroup=e,this.fields=r,this.indexState=i}};function Va(n){return n.fields.find(t=>t.kind===2)}function Ge(n){return n.fields.filter(t=>t.kind!==2)}Mn.UNKNOWN_ID=-1;var Vn=class{constructor(t,e){this.fieldPath=t,this.kind=e}};var $r=class n{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new n(0,kt.min())}};function pf(n,t){let e=n.toTimestamp().seconds,r=n.toTimestamp().nanoseconds+1,i=P.fromTimestamp(r===1e9?new W(e+1,0):new W(e,r));return new kt(i,I.empty(),t)}function _f(n){return new kt(n.readTime,n.key,-1)}var kt=class n{constructor(t,e,r){this.readTime=t,this.documentKey=e,this.largestBatchId=r}static min(){return new n(P.min(),I.empty(),-1)}static max(){return new n(P.max(),I.empty(),-1)}};function Ac(n,t){let e=n.readTime.compareTo(t.readTime);return e!==0?e:(e=I.comparator(n.documentKey,t.documentKey),e!==0?e:C(n.largestBatchId,t.largestBatchId))}var yf="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",gs=class{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}};function Ne(n){return p(this,null,function*(){if(n.code!==g.FAILED_PRECONDITION||n.message!==yf)throw n;y("LocalStore","Unexpectedly lost primary lease")})}var f=class n{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&S(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new n((r,i)=>{this.nextCallback=s=>{this.wrapSuccess(t,s).next(r,i)},this.catchCallback=s=>{this.wrapFailure(e,s).next(r,i)}})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{let e=t();return e instanceof n?e:n.resolve(e)}catch(e){return n.reject(e)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):n.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):n.reject(e)}static resolve(t){return new n((e,r)=>{e(t)})}static reject(t){return new n((e,r)=>{r(t)})}static waitFor(t){return new n((e,r)=>{let i=0,s=0,o=!1;t.forEach(a=>{++i,a.next(()=>{++s,o&&s===i&&e()},u=>r(u))}),o=!0,s===i&&e()})}static or(t){let e=n.resolve(!1);for(let r of t)e=e.next(i=>i?n.resolve(i):r());return e}static forEach(t,e){let r=[];return t.forEach((i,s)=>{r.push(e.call(this,i,s))}),this.waitFor(r)}static mapArray(t,e){return new n((r,i)=>{let s=t.length,o=new Array(s),a=0;for(let u=0;u<s;u++){let c=u;e(t[c]).next(l=>{o[c]=l,++a,a===s&&r(o)},l=>i(l))}})}static doWhile(t,e){return new n((r,i)=>{let s=()=>{t()===!0?e().next(()=>{s()},i):r()};s()})}};var ps=class n{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.V=new at,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{e.error?this.V.reject(new We(t,e.error)):this.V.resolve()},this.transaction.onerror=r=>{let i=Sc(r.target.error);this.V.reject(new We(t,i))}}static open(t,e,r,i){try{return new n(e,t.transaction(i,r))}catch(s){throw new We(e,s)}}get m(){return this.V.promise}abort(t){t&&this.V.reject(t),this.aborted||(y("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){let t=this.transaction;this.aborted||typeof t.commit!="function"||t.commit()}store(t){let e=this.transaction.objectStore(t);return new ka(e)}},Ae=class n{constructor(t,e,r){this.name=t,this.version=e,this.p=r,n.S(hr())===12.2&&Z("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return y("SimpleDb","Removing database:",t),ze(window.indexedDB.deleteDatabase(t)).toPromise()}static D(){if(!Sl())return!1;if(n.C())return!0;let t=hr(),e=n.S(t),r=0<e&&e<10,i=wf(t),s=0<i&&i<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||r||s)}static C(){var t;return typeof process<"u"&&((t=process.__PRIVATE_env)===null||t===void 0?void 0:t.v)==="YES"}static F(t,e){return t.store(e)}static S(t){let e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),r=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(r)}M(t){return p(this,null,function*(){return this.db||(y("SimpleDb","Opening database:",this.name),this.db=yield new Promise((e,r)=>{let i=indexedDB.open(this.name,this.version);i.onsuccess=s=>{let o=s.target.result;e(o)},i.onblocked=()=>{r(new We(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=s=>{let o=s.target.error;o.name==="VersionError"?r(new _(g.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):o.name==="InvalidStateError"?r(new _(g.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+o)):r(new We(t,o))},i.onupgradeneeded=s=>{y("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',s.oldVersion);let o=s.target.result;this.p.O(o,i.transaction,s.oldVersion,this.version).next(()=>{y("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.N&&(this.db.onversionchange=e=>this.N(e)),this.db})}L(t){this.N=t,this.db&&(this.db.onversionchange=e=>t(e))}runTransaction(t,e,r,i){return p(this,null,function*(){let s=e==="readonly",o=0;for(;;){++o;try{this.db=yield this.M(t);let a=ps.open(this.db,t,s?"readonly":"readwrite",r),u=i(a).next(c=>(a.g(),c)).catch(c=>(a.abort(c),f.reject(c))).toPromise();return u.catch(()=>{}),yield a.m,u}catch(a){let u=a,c=u.name!=="FirebaseError"&&o<3;if(y("SimpleDb","Transaction failed with error:",u.message,"Retrying:",c),this.close(),!c)return Promise.reject(u)}}})}close(){this.db&&this.db.close(),this.db=void 0}};function wf(n){let t=n.match(/Android ([\d.]+)/i),e=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(e)}var Na=class{constructor(t){this.B=t,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(t){this.B=t}done(){this.k=!0}$(t){this.q=t}delete(){return ze(this.B.delete())}},We=class extends _{constructor(t,e){super(g.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}};function ke(n){return n.name==="IndexedDbTransactionError"}var ka=class{constructor(t){this.store=t}put(t,e){let r;return e!==void 0?(y("SimpleDb","PUT",this.store.name,t,e),r=this.store.put(e,t)):(y("SimpleDb","PUT",this.store.name,"<auto-key>",t),r=this.store.put(t)),ze(r)}add(t){return y("SimpleDb","ADD",this.store.name,t,t),ze(this.store.add(t))}get(t){return ze(this.store.get(t)).next(e=>(e===void 0&&(e=null),y("SimpleDb","GET",this.store.name,t,e),e))}delete(t){return y("SimpleDb","DELETE",this.store.name,t),ze(this.store.delete(t))}count(){return y("SimpleDb","COUNT",this.store.name),ze(this.store.count())}U(t,e){let r=this.options(t,e),i=r.index?this.store.index(r.index):this.store;if(typeof i.getAll=="function"){let s=i.getAll(r.range);return new f((o,a)=>{s.onerror=u=>{a(u.target.error)},s.onsuccess=u=>{o(u.target.result)}})}{let s=this.cursor(r),o=[];return this.W(s,(a,u)=>{o.push(u)}).next(()=>o)}}G(t,e){let r=this.store.getAll(t,e===null?void 0:e);return new f((i,s)=>{r.onerror=o=>{s(o.target.error)},r.onsuccess=o=>{i(o.target.result)}})}j(t,e){y("SimpleDb","DELETE ALL",this.store.name);let r=this.options(t,e);r.H=!1;let i=this.cursor(r);return this.W(i,(s,o,a)=>a.delete())}J(t,e){let r;e?r=t:(r={},e=t);let i=this.cursor(r);return this.W(i,e)}Y(t){let e=this.cursor({});return new f((r,i)=>{e.onerror=s=>{let o=Sc(s.target.error);i(o)},e.onsuccess=s=>{let o=s.target.result;o?t(o.primaryKey,o.value).next(a=>{a?o.continue():r()}):r()}})}W(t,e){let r=[];return new f((i,s)=>{t.onerror=o=>{s(o.target.error)},t.onsuccess=o=>{let a=o.target.result;if(!a)return void i();let u=new Na(a),c=e(a.primaryKey,a.value,u);if(c instanceof f){let l=c.catch(h=>(u.done(),f.reject(h)));r.push(l)}u.isDone?i():u.K===null?a.continue():a.continue(u.K)}}).next(()=>f.waitFor(r))}options(t,e){let r;return t!==void 0&&(typeof t=="string"?r=t:e=t),{index:r,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){let r=this.store.index(t.index);return t.H?r.openKeyCursor(t.range,e):r.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}};function ze(n){return new f((t,e)=>{n.onsuccess=r=>{let i=r.target.result;t(i)},n.onerror=r=>{let i=Sc(r.target.error);e(i)}})}var fd=!1;function Sc(n){let t=Ae.S(hr());if(t>=12.2&&t<13){let e="An internal error was encountered in the Indexed Database server";if(n.message.indexOf(e)>=0){let r=new _("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return fd||(fd=!0,setTimeout(()=>{throw r},0)),r}}return n}var Fa=class{constructor(t,e){this.asyncQueue=t,this.Z=e,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return this.task!==null}X(t){y("IndexBackfiller",`Scheduled in ${t}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",t,()=>p(this,null,function*(){this.task=null;try{y("IndexBackfiller",`Documents written: ${yield this.Z.ee()}`)}catch(e){ke(e)?y("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",e):yield Ne(e)}yield this.X(6e4)}))}},Ma=class{constructor(t,e){this.localStore=t,this.persistence=e}ee(t=50){return p(this,null,function*(){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.te(e,t))})}te(t,e){let r=new Set,i=e,s=!0;return f.doWhile(()=>s===!0&&i>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(t).next(o=>{if(o!==null&&!r.has(o))return y("IndexBackfiller",`Processing collection: ${o}`),this.ne(t,o,i).next(a=>{i-=a,r.add(o)});s=!1})).next(()=>e-i)}ne(t,e,r){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(t,e).next(i=>this.localStore.localDocuments.getNextDocuments(t,e,i,r).next(s=>{let o=s.changes;return this.localStore.indexManager.updateIndexEntries(t,o).next(()=>this.re(i,s)).next(a=>(y("IndexBackfiller",`Updating offset: ${a}`),this.localStore.indexManager.updateCollectionGroup(t,e,a))).next(()=>o.size)}))}re(t,e){let r=t;return e.changes.forEach((i,s)=>{let o=_f(s);Ac(o,r)>0&&(r=o)}),new kt(r.readTime,r.documentKey,Math.max(e.batchId,t.largestBatchId))}};var bt=(()=>{class n{constructor(e,r){this.previousValue=e,r&&(r.sequenceNumberHandler=i=>this.ie(i),this.se=i=>r.writeSequenceNumber(i))}ie(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this.se&&this.se(e),e}}return n.oe=-1,n})();function mi(n){return n==null}function Qr(n){return n===0&&1/n==-1/0}function vf(n){return typeof n=="number"&&Number.isInteger(n)&&!Qr(n)&&n<=Number.MAX_SAFE_INTEGER&&n>=Number.MIN_SAFE_INTEGER}function Et(n){let t="";for(let e=0;e<n.length;e++)t.length>0&&(t=md(t)),t=jp(n.get(e),t);return md(t)}function jp(n,t){let e=t,r=n.length;for(let i=0;i<r;i++){let s=n.charAt(i);switch(s){case"\0":e+="";break;case"":e+="";break;default:e+=s}}return e}function md(n){return n+""}function Qt(n){let t=n.length;if(R(t>=2),t===2)return R(n.charAt(0)===""&&n.charAt(1)===""),M.emptyPath();let e=t-2,r=[],i="";for(let s=0;s<t;){let o=n.indexOf("",s);switch((o<0||o>e)&&S(),n.charAt(o+1)){case"":let a=n.substring(s,o),u;i.length===0?u=a:(i+=a,u=i,i=""),r.push(u);break;case"":i+=n.substring(s,o),i+="\0";break;case"":i+=n.substring(s,o+1);break;default:S()}s=o+2}return new M(r)}var gd=["userId","batchId"];function os(n,t){return[n,Et(t)]}function If(n,t,e){return[n,Et(t),e]}var Kp={},$p=["prefixPath","collectionGroup","readTime","documentId"],Qp=["prefixPath","collectionGroup","documentId"],Wp=["collectionGroup","readTime","prefixPath","documentId"],Hp=["canonicalId","targetId"],Jp=["targetId","path"],Yp=["path","targetId"],Xp=["collectionId","parent"],Zp=["indexId","uid"],t_=["uid","sequenceNumber"],e_=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],n_=["indexId","uid","orderedDocumentKey"],r_=["userId","collectionPath","documentId"],i_=["userId","collectionPath","largestBatchId"],s_=["userId","collectionGroup","largestBatchId"],Ef=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],o_=[...Ef,"documentOverlays"],Tf=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Af=Tf,Sf=[...Af,"indexConfiguration","indexState","indexEntries"],a_=Sf;var Wr=class extends gs{constructor(t,e){super(),this._e=t,this.currentSequenceNumber=e}};function ft(n,t){let e=E(n);return Ae.F(e._e,t)}function pd(n){let t=0;for(let e in n)Object.prototype.hasOwnProperty.call(n,e)&&t++;return t}function an(n,t){for(let e in n)Object.prototype.hasOwnProperty.call(n,e)&&t(e,n[e])}function Rf(n){for(let t in n)if(Object.prototype.hasOwnProperty.call(n,t))return!1;return!0}var $=class n{constructor(t,e){this.comparator=t,this.root=e||Ht.EMPTY}insert(t,e){return new n(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Ht.BLACK,null,null))}remove(t){return new n(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Ht.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){let r=this.comparator(t,e.key);if(r===0)return e.value;r<0?e=e.left:r>0&&(e=e.right)}return null}indexOf(t){let e=0,r=this.root;for(;!r.isEmpty();){let i=this.comparator(t,r.key);if(i===0)return e+r.left.size;i<0?r=r.left:(e+=r.left.size+1,r=r.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal((e,r)=>(t(e,r),!1))}toString(){let t=[];return this.inorderTraversal((e,r)=>(t.push(`${e}:${r}`),!1)),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new Cn(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new Cn(this.root,t,this.comparator,!1)}getReverseIterator(){return new Cn(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new Cn(this.root,t,this.comparator,!0)}},Cn=class{constructor(t,e,r,i){this.isReverse=i,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?r(t.key,e):1,e&&i&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(s===0){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop(),e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;let t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}},Ht=class n{constructor(t,e,r,i,s){this.key=t,this.value=e,this.color=r??n.RED,this.left=i??n.EMPTY,this.right=s??n.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,r,i,s){return new n(t??this.key,e??this.value,r??this.color,i??this.left,s??this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,r){let i=this,s=r(t,i.key);return i=s<0?i.copy(null,null,null,i.left.insert(t,e,r),null):s===0?i.copy(null,e,null,null,null):i.copy(null,null,null,null,i.right.insert(t,e,r)),i.fixUp()}removeMin(){if(this.left.isEmpty())return n.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let r,i=this;if(e(t,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(t,e),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),e(t,i.key)===0){if(i.right.isEmpty())return n.EMPTY;r=i.right.min(),i=i.copy(r.key,r.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(t,e))}return i.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){let t=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){let t=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){let t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){let t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw S();let t=this.left.check();if(t!==this.right.check())throw S();return t+(this.isRed()?0:1)}};Ht.EMPTY=null,Ht.RED=!0,Ht.BLACK=!1;Ht.EMPTY=new class{constructor(){this.size=0}get key(){throw S()}get value(){throw S()}get color(){throw S()}get left(){throw S()}get right(){throw S()}copy(t,e,r,i,s){return this}insert(t,e,r){return new Ht(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};var z=class n{constructor(t){this.comparator=t,this.data=new $(this.comparator)}has(t){return this.data.get(t)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal((e,r)=>(t(e),!1))}forEachInRange(t,e){let r=this.data.getIteratorFrom(t[0]);for(;r.hasNext();){let i=r.getNext();if(this.comparator(i.key,t[1])>=0)return;e(i.key)}}forEachWhile(t,e){let r;for(r=e!==void 0?this.data.getIteratorFrom(e):this.data.getIterator();r.hasNext();)if(!t(r.getNext().key))return}firstAfterOrEqual(t){let e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new _s(this.data.getIterator())}getIteratorFrom(t){return new _s(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(r=>{e=e.add(r)}),e}isEqual(t){if(!(t instanceof n)||this.size!==t.size)return!1;let e=this.data.getIterator(),r=t.data.getIterator();for(;e.hasNext();){let i=e.getNext().key,s=r.getNext().key;if(this.comparator(i,s)!==0)return!1}return!0}toArray(){let t=[];return this.forEach(e=>{t.push(e)}),t}toString(){let t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(t){let e=new n(this.comparator);return e.data=t,e}},_s=class{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}};function En(n){return n.hasNext()?n.getNext():void 0}var xt=class n{constructor(t){this.fields=t,t.sort(tt.comparator)}static empty(){return new n([])}unionWith(t){let e=new z(tt.comparator);for(let r of this.fields)e=e.add(r);for(let r of t)e=e.add(r);return new n(e.toArray())}covers(t){for(let e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return Fn(this.fields,t.fields,(e,r)=>e.isEqual(r))}};var ys=class extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}};function Pf(){return typeof atob<"u"}var dt=class n{constructor(t){this.binaryString=t}static fromBase64String(t){let e=function(i){try{return atob(i)}catch(s){throw typeof DOMException<"u"&&s instanceof DOMException?new ys("Invalid base64 string: "+s):s}}(t);return new n(e)}static fromUint8Array(t){let e=function(i){let s="";for(let o=0;o<i.length;++o)s+=String.fromCharCode(i[o]);return s}(t);return new n(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(e){return btoa(e)}(this.binaryString)}toUint8Array(){return function(e){let r=new Uint8Array(e.length);for(let i=0;i<e.length;i++)r[i]=e.charCodeAt(i);return r}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return C(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}};dt.EMPTY_BYTE_STRING=new dt("");var u_=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ue(n){if(R(!!n),typeof n=="string"){let t=0,e=u_.exec(n);if(R(!!e),e[1]){let i=e[1];i=(i+"000000000").substr(0,9),t=Number(i)}let r=new Date(n);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:Y(n.seconds),nanos:Y(n.nanos)}}function Y(n){return typeof n=="number"?n:typeof n=="string"?Number(n):0}function Se(n){return typeof n=="string"?dt.fromBase64String(n):dt.fromUint8Array(n)}function uo(n){var t,e;return((e=(((t=n?.mapValue)===null||t===void 0?void 0:t.fields)||{}).__type__)===null||e===void 0?void 0:e.stringValue)==="server_timestamp"}function Rc(n){let t=n.mapValue.fields.__previous_value__;return uo(t)?Rc(t):t}function Hr(n){let t=ue(n.mapValue.fields.__local_write_time__.timestampValue);return new W(t.seconds,t.nanos)}var La=class{constructor(t,e,r,i,s,o,a,u,c){this.databaseId=t,this.appId=e,this.persistenceKey=r,this.host=i,this.ssl=s,this.forceLongPolling=o,this.autoDetectLongPolling=a,this.longPollingOptions=u,this.useFetchStreams=c}},Re=class n{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new n("","")}get isDefaultDatabase(){return this.database==="(default)"}isEqual(t){return t instanceof n&&t.projectId===this.projectId&&t.database===this.database}};var Ie={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},as={nullValue:"NULL_VALUE"};function He(n){return"nullValue"in n?0:"booleanValue"in n?1:"integerValue"in n||"doubleValue"in n?2:"timestampValue"in n?3:"stringValue"in n?5:"bytesValue"in n?6:"referenceValue"in n?7:"geoPointValue"in n?8:"arrayValue"in n?9:"mapValue"in n?uo(n)?4:bf(n)?9007199254740991:10:S()}function Xt(n,t){if(n===t)return!0;let e=He(n);if(e!==He(t))return!1;switch(e){case 0:case 9007199254740991:return!0;case 1:return n.booleanValue===t.booleanValue;case 4:return Hr(n).isEqual(Hr(t));case 3:return function(i,s){if(typeof i.timestampValue=="string"&&typeof s.timestampValue=="string"&&i.timestampValue.length===s.timestampValue.length)return i.timestampValue===s.timestampValue;let o=ue(i.timestampValue),a=ue(s.timestampValue);return o.seconds===a.seconds&&o.nanos===a.nanos}(n,t);case 5:return n.stringValue===t.stringValue;case 6:return function(i,s){return Se(i.bytesValue).isEqual(Se(s.bytesValue))}(n,t);case 7:return n.referenceValue===t.referenceValue;case 8:return function(i,s){return Y(i.geoPointValue.latitude)===Y(s.geoPointValue.latitude)&&Y(i.geoPointValue.longitude)===Y(s.geoPointValue.longitude)}(n,t);case 2:return function(i,s){if("integerValue"in i&&"integerValue"in s)return Y(i.integerValue)===Y(s.integerValue);if("doubleValue"in i&&"doubleValue"in s){let o=Y(i.doubleValue),a=Y(s.doubleValue);return o===a?Qr(o)===Qr(a):isNaN(o)&&isNaN(a)}return!1}(n,t);case 9:return Fn(n.arrayValue.values||[],t.arrayValue.values||[],Xt);case 10:return function(i,s){let o=i.mapValue.fields||{},a=s.mapValue.fields||{};if(pd(o)!==pd(a))return!1;for(let u in o)if(o.hasOwnProperty(u)&&(a[u]===void 0||!Xt(o[u],a[u])))return!1;return!0}(n,t);default:return S()}}function Jr(n,t){return(n.values||[]).find(e=>Xt(e,t))!==void 0}function Pe(n,t){if(n===t)return 0;let e=He(n),r=He(t);if(e!==r)return C(e,r);switch(e){case 0:case 9007199254740991:return 0;case 1:return C(n.booleanValue,t.booleanValue);case 2:return function(s,o){let a=Y(s.integerValue||s.doubleValue),u=Y(o.integerValue||o.doubleValue);return a<u?-1:a>u?1:a===u?0:isNaN(a)?isNaN(u)?0:-1:1}(n,t);case 3:return _d(n.timestampValue,t.timestampValue);case 4:return _d(Hr(n),Hr(t));case 5:return C(n.stringValue,t.stringValue);case 6:return function(s,o){let a=Se(s),u=Se(o);return a.compareTo(u)}(n.bytesValue,t.bytesValue);case 7:return function(s,o){let a=s.split("/"),u=o.split("/");for(let c=0;c<a.length&&c<u.length;c++){let l=C(a[c],u[c]);if(l!==0)return l}return C(a.length,u.length)}(n.referenceValue,t.referenceValue);case 8:return function(s,o){let a=C(Y(s.latitude),Y(o.latitude));return a!==0?a:C(Y(s.longitude),Y(o.longitude))}(n.geoPointValue,t.geoPointValue);case 9:return function(s,o){let a=s.values||[],u=o.values||[];for(let c=0;c<a.length&&c<u.length;++c){let l=Pe(a[c],u[c]);if(l)return l}return C(a.length,u.length)}(n.arrayValue,t.arrayValue);case 10:return function(s,o){if(s===Ie.mapValue&&o===Ie.mapValue)return 0;if(s===Ie.mapValue)return 1;if(o===Ie.mapValue)return-1;let a=s.fields||{},u=Object.keys(a),c=o.fields||{},l=Object.keys(c);u.sort(),l.sort();for(let h=0;h<u.length&&h<l.length;++h){let d=C(u[h],l[h]);if(d!==0)return d;let m=Pe(a[u[h]],c[l[h]]);if(m!==0)return m}return C(u.length,l.length)}(n.mapValue,t.mapValue);default:throw S()}}function _d(n,t){if(typeof n=="string"&&typeof t=="string"&&n.length===t.length)return C(n,t);let e=ue(n),r=ue(t),i=C(e.seconds,r.seconds);return i!==0?i:C(e.nanos,r.nanos)}function Ln(n){return Oa(n)}function Oa(n){return"nullValue"in n?"null":"booleanValue"in n?""+n.booleanValue:"integerValue"in n?""+n.integerValue:"doubleValue"in n?""+n.doubleValue:"timestampValue"in n?function(e){let r=ue(e);return`time(${r.seconds},${r.nanos})`}(n.timestampValue):"stringValue"in n?n.stringValue:"bytesValue"in n?function(e){return Se(e).toBase64()}(n.bytesValue):"referenceValue"in n?function(e){return I.fromName(e).toString()}(n.referenceValue):"geoPointValue"in n?function(e){return`geo(${e.latitude},${e.longitude})`}(n.geoPointValue):"arrayValue"in n?function(e){let r="[",i=!0;for(let s of e.values||[])i?i=!1:r+=",",r+=Oa(s);return r+"]"}(n.arrayValue):"mapValue"in n?function(e){let r=Object.keys(e.fields||{}).sort(),i="{",s=!0;for(let o of r)s?s=!1:i+=",",i+=`${o}:${Oa(e.fields[o])}`;return i+"}"}(n.mapValue):S()}function Je(n,t){return{referenceValue:`projects/${n.projectId}/databases/${n.database}/documents/${t.path.canonicalString()}`}}function qa(n){return!!n&&"integerValue"in n}function Yr(n){return!!n&&"arrayValue"in n}function yd(n){return!!n&&"nullValue"in n}function wd(n){return!!n&&"doubleValue"in n&&isNaN(Number(n.doubleValue))}function us(n){return!!n&&"mapValue"in n}function Ur(n){if(n.geoPointValue)return{geoPointValue:Object.assign({},n.geoPointValue)};if(n.timestampValue&&typeof n.timestampValue=="object")return{timestampValue:Object.assign({},n.timestampValue)};if(n.mapValue){let t={mapValue:{fields:{}}};return an(n.mapValue.fields,(e,r)=>t.mapValue.fields[e]=Ur(r)),t}if(n.arrayValue){let t={arrayValue:{values:[]}};for(let e=0;e<(n.arrayValue.values||[]).length;++e)t.arrayValue.values[e]=Ur(n.arrayValue.values[e]);return t}return Object.assign({},n)}function bf(n){return(((n.mapValue||{}).fields||{}).__type__||{}).stringValue==="__max__"}function c_(n){return"nullValue"in n?as:"booleanValue"in n?{booleanValue:!1}:"integerValue"in n||"doubleValue"in n?{doubleValue:NaN}:"timestampValue"in n?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in n?{stringValue:""}:"bytesValue"in n?{bytesValue:""}:"referenceValue"in n?Je(Re.empty(),I.empty()):"geoPointValue"in n?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in n?{arrayValue:{}}:"mapValue"in n?{mapValue:{}}:S()}function l_(n){return"nullValue"in n?{booleanValue:!1}:"booleanValue"in n?{doubleValue:NaN}:"integerValue"in n||"doubleValue"in n?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in n?{stringValue:""}:"stringValue"in n?{bytesValue:""}:"bytesValue"in n?Je(Re.empty(),I.empty()):"referenceValue"in n?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in n?{arrayValue:{}}:"arrayValue"in n?{mapValue:{}}:"mapValue"in n?Ie:S()}function vd(n,t){let e=Pe(n.value,t.value);return e!==0?e:n.inclusive&&!t.inclusive?-1:!n.inclusive&&t.inclusive?1:0}function Id(n,t){let e=Pe(n.value,t.value);return e!==0?e:n.inclusive&&!t.inclusive?1:!n.inclusive&&t.inclusive?-1:0}var vt=class n{constructor(t){this.value=t}static empty(){return new n({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let r=0;r<t.length-1;++r)if(e=(e.mapValue.fields||{})[t.get(r)],!us(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=Ur(e)}setAll(t){let e=tt.emptyPath(),r={},i=[];t.forEach((o,a)=>{if(!e.isImmediateParentOf(a)){let u=this.getFieldsMap(e);this.applyChanges(u,r,i),r={},i=[],e=a.popLast()}o?r[a.lastSegment()]=Ur(o):i.push(a.lastSegment())});let s=this.getFieldsMap(e);this.applyChanges(s,r,i)}delete(t){let e=this.field(t.popLast());us(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return Xt(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let r=0;r<t.length;++r){let i=e.mapValue.fields[t.get(r)];us(i)&&i.mapValue.fields||(i={mapValue:{fields:{}}},e.mapValue.fields[t.get(r)]=i),e=i}return e.mapValue.fields}applyChanges(t,e,r){an(e,(i,s)=>t[i]=s);for(let i of r)delete t[i]}clone(){return new n(Ur(this.value))}};function xf(n){let t=[];return an(n.fields,(e,r)=>{let i=new tt([e]);if(us(r)){let s=xf(r.mapValue).fields;if(s.length===0)t.push(i);else for(let o of s)t.push(i.child(o))}else t.push(i)}),new xt(t)}var ut=class n{constructor(t,e,r,i,s,o,a){this.key=t,this.documentType=e,this.version=r,this.readTime=i,this.createTime=s,this.data=o,this.documentState=a}static newInvalidDocument(t){return new n(t,0,P.min(),P.min(),P.min(),vt.empty(),0)}static newFoundDocument(t,e,r,i){return new n(t,1,e,P.min(),r,i,0)}static newNoDocument(t,e){return new n(t,2,e,P.min(),P.min(),vt.empty(),0)}static newUnknownDocument(t,e){return new n(t,3,e,P.min(),P.min(),vt.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(P.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=vt.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=vt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=P.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(t){return t instanceof n&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new n(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}};var Zt=class{constructor(t,e){this.position=t,this.inclusive=e}};function Ed(n,t,e){let r=0;for(let i=0;i<n.position.length;i++){let s=t[i],o=n.position[i];if(s.field.isKeyField()?r=I.comparator(I.fromName(o.referenceValue),e.key):r=Pe(o,e.data.field(s.field)),s.dir==="desc"&&(r*=-1),r!==0)break}return r}function Td(n,t){if(n===null)return t===null;if(t===null||n.inclusive!==t.inclusive||n.position.length!==t.position.length)return!1;for(let e=0;e<n.position.length;e++)if(!Xt(n.position[e],t.position[e]))return!1;return!0}var Ye=class{constructor(t,e="asc"){this.field=t,this.dir=e}};function h_(n,t){return n.dir===t.dir&&n.field.isEqual(t.field)}var ws=class{},k=class n extends ws{constructor(t,e,r){super(),this.field=t,this.op=e,this.value=r}static create(t,e,r){return t.isKeyField()?e==="in"||e==="not-in"?this.createKeyFieldInFilter(t,e,r):new Ga(t,e,r):e==="array-contains"?new Ka(t,r):e==="in"?new vs(t,r):e==="not-in"?new $a(t,r):e==="array-contains-any"?new Qa(t,r):new n(t,e,r)}static createKeyFieldInFilter(t,e,r){return e==="in"?new za(t,r):new ja(t,r)}matches(t){let e=t.data.field(this.field);return this.op==="!="?e!==null&&this.matchesComparison(Pe(e,this.value)):e!==null&&He(this.value)===He(e)&&this.matchesComparison(Pe(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return t===0;case"!=":return t!==0;case">":return t>0;case">=":return t>=0;default:return S()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}},G=class n extends ws{constructor(t,e){super(),this.filters=t,this.op=e,this.ae=null}static create(t,e){return new n(t,e)}matches(t){return On(this)?this.filters.find(e=>!e.matches(t))===void 0:this.filters.find(e=>e.matches(t))!==void 0}getFlattenedFilters(){return this.ae!==null||(this.ae=this.filters.reduce((t,e)=>t.concat(e.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}};function On(n){return n.op==="and"}function Ba(n){return n.op==="or"}function Pc(n){return Df(n)&&On(n)}function Df(n){for(let t of n.filters)if(t instanceof G)return!1;return!0}function Ua(n){if(n instanceof k)return n.field.canonicalString()+n.op.toString()+Ln(n.value);if(Pc(n))return n.filters.map(t=>Ua(t)).join(",");{let t=n.filters.map(e=>Ua(e)).join(",");return`${n.op}(${t})`}}function Cf(n,t){return n instanceof k?function(r,i){return i instanceof k&&r.op===i.op&&r.field.isEqual(i.field)&&Xt(r.value,i.value)}(n,t):n instanceof G?function(r,i){return i instanceof G&&r.op===i.op&&r.filters.length===i.filters.length?r.filters.reduce((s,o,a)=>s&&Cf(o,i.filters[a]),!0):!1}(n,t):void S()}function Vf(n,t){let e=n.filters.concat(t);return G.create(e,n.op)}function Nf(n){return n instanceof k?function(e){return`${e.field.canonicalString()} ${e.op} ${Ln(e.value)}`}(n):n instanceof G?function(e){return e.op.toString()+" {"+e.getFilters().map(Nf).join(" ,")+"}"}(n):"Filter"}var Ga=class extends k{constructor(t,e,r){super(t,e,r),this.key=I.fromName(r.referenceValue)}matches(t){let e=I.comparator(t.key,this.key);return this.matchesComparison(e)}},za=class extends k{constructor(t,e){super(t,"in",e),this.keys=kf("in",e)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}},ja=class extends k{constructor(t,e){super(t,"not-in",e),this.keys=kf("not-in",e)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}};function kf(n,t){var e;return(((e=t.arrayValue)===null||e===void 0?void 0:e.values)||[]).map(r=>I.fromName(r.referenceValue))}var Ka=class extends k{constructor(t,e){super(t,"array-contains",e)}matches(t){let e=t.data.field(this.field);return Yr(e)&&Jr(e.arrayValue,this.value)}},vs=class extends k{constructor(t,e){super(t,"in",e)}matches(t){let e=t.data.field(this.field);return e!==null&&Jr(this.value.arrayValue,e)}},$a=class extends k{constructor(t,e){super(t,"not-in",e)}matches(t){if(Jr(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let e=t.data.field(this.field);return e!==null&&!Jr(this.value.arrayValue,e)}},Qa=class extends k{constructor(t,e){super(t,"array-contains-any",e)}matches(t){let e=t.data.field(this.field);return!(!Yr(e)||!e.arrayValue.values)&&e.arrayValue.values.some(r=>Jr(this.value.arrayValue,r))}};var Wa=class{constructor(t,e=null,r=[],i=[],s=null,o=null,a=null){this.path=t,this.collectionGroup=e,this.orderBy=r,this.filters=i,this.limit=s,this.startAt=o,this.endAt=a,this.ue=null}};function Ha(n,t=null,e=[],r=[],i=null,s=null,o=null){return new Wa(n,t,e,r,i,s,o)}function Xe(n){let t=E(n);if(t.ue===null){let e=t.path.canonicalString();t.collectionGroup!==null&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(r=>Ua(r)).join(","),e+="|ob:",e+=t.orderBy.map(r=>function(s){return s.field.canonicalString()+s.dir}(r)).join(","),mi(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(r=>Ln(r)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(r=>Ln(r)).join(",")),t.ue=e}return t.ue}function gi(n,t){if(n.limit!==t.limit||n.orderBy.length!==t.orderBy.length)return!1;for(let e=0;e<n.orderBy.length;e++)if(!h_(n.orderBy[e],t.orderBy[e]))return!1;if(n.filters.length!==t.filters.length)return!1;for(let e=0;e<n.filters.length;e++)if(!Cf(n.filters[e],t.filters[e]))return!1;return n.collectionGroup===t.collectionGroup&&!!n.path.isEqual(t.path)&&!!Td(n.startAt,t.startAt)&&Td(n.endAt,t.endAt)}function Is(n){return I.isDocumentKey(n.path)&&n.collectionGroup===null&&n.filters.length===0}function Es(n,t){return n.filters.filter(e=>e instanceof k&&e.field.isEqual(t))}function Ad(n,t,e){let r=as,i=!0;for(let s of Es(n,t)){let o=as,a=!0;switch(s.op){case"<":case"<=":o=c_(s.value);break;case"==":case"in":case">=":o=s.value;break;case">":o=s.value,a=!1;break;case"!=":case"not-in":o=as}vd({value:r,inclusive:i},{value:o,inclusive:a})<0&&(r=o,i=a)}if(e!==null){for(let s=0;s<n.orderBy.length;++s)if(n.orderBy[s].field.isEqual(t)){let o=e.position[s];vd({value:r,inclusive:i},{value:o,inclusive:e.inclusive})<0&&(r=o,i=e.inclusive);break}}return{value:r,inclusive:i}}function Sd(n,t,e){let r=Ie,i=!0;for(let s of Es(n,t)){let o=Ie,a=!0;switch(s.op){case">=":case">":o=l_(s.value),a=!1;break;case"==":case"in":case"<=":o=s.value;break;case"<":o=s.value,a=!1;break;case"!=":case"not-in":o=Ie}Id({value:r,inclusive:i},{value:o,inclusive:a})>0&&(r=o,i=a)}if(e!==null){for(let s=0;s<n.orderBy.length;++s)if(n.orderBy[s].field.isEqual(t)){let o=e.position[s];Id({value:r,inclusive:i},{value:o,inclusive:e.inclusive})>0&&(r=o,i=e.inclusive);break}}return{value:r,inclusive:i}}var Ot=class{constructor(t,e=null,r=[],i=[],s=null,o="F",a=null,u=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=r,this.filters=i,this.limit=s,this.limitType=o,this.startAt=a,this.endAt=u,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}};function Ff(n,t,e,r,i,s,o,a){return new Ot(n,t,e,r,i,s,o,a)}function Zn(n){return new Ot(n)}function Rd(n){return n.filters.length===0&&n.limit===null&&n.startAt==null&&n.endAt==null&&(n.explicitOrderBy.length===0||n.explicitOrderBy.length===1&&n.explicitOrderBy[0].field.isKeyField())}function bc(n){return n.collectionGroup!==null}function Nn(n){let t=E(n);if(t.ce===null){t.ce=[];let e=new Set;for(let s of t.explicitOrderBy)t.ce.push(s),e.add(s.field.canonicalString());let r=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";(function(o){let a=new z(tt.comparator);return o.filters.forEach(u=>{u.getFlattenedFilters().forEach(c=>{c.isInequality()&&(a=a.add(c.field))})}),a})(t).forEach(s=>{e.has(s.canonicalString())||s.isKeyField()||t.ce.push(new Ye(s,r))}),e.has(tt.keyField().canonicalString())||t.ce.push(new Ye(tt.keyField(),r))}return t.ce}function Tt(n){let t=E(n);return t.le||(t.le=d_(t,Nn(n))),t.le}function d_(n,t){if(n.limitType==="F")return Ha(n.path,n.collectionGroup,t,n.filters,n.limit,n.startAt,n.endAt);{t=t.map(i=>{let s=i.dir==="desc"?"asc":"desc";return new Ye(i.field,s)});let e=n.endAt?new Zt(n.endAt.position,n.endAt.inclusive):null,r=n.startAt?new Zt(n.startAt.position,n.startAt.inclusive):null;return Ha(n.path,n.collectionGroup,t,n.filters,n.limit,e,r)}}function Ja(n,t){let e=n.filters.concat([t]);return new Ot(n.path,n.collectionGroup,n.explicitOrderBy.slice(),e,n.limit,n.limitType,n.startAt,n.endAt)}function Ts(n,t,e){return new Ot(n.path,n.collectionGroup,n.explicitOrderBy.slice(),n.filters.slice(),t,e,n.startAt,n.endAt)}function pi(n,t){return gi(Tt(n),Tt(t))&&n.limitType===t.limitType}function Mf(n){return`${Xe(Tt(n))}|lt:${n.limitType}`}function Pn(n){return`Query(target=${function(e){let r=e.path.canonicalString();return e.collectionGroup!==null&&(r+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(r+=`, filters: [${e.filters.map(i=>Nf(i)).join(", ")}]`),mi(e.limit)||(r+=", limit: "+e.limit),e.orderBy.length>0&&(r+=`, orderBy: [${e.orderBy.map(i=>function(o){return`${o.field.canonicalString()} (${o.dir})`}(i)).join(", ")}]`),e.startAt&&(r+=", startAt: ",r+=e.startAt.inclusive?"b:":"a:",r+=e.startAt.position.map(i=>Ln(i)).join(",")),e.endAt&&(r+=", endAt: ",r+=e.endAt.inclusive?"a:":"b:",r+=e.endAt.position.map(i=>Ln(i)).join(",")),`Target(${r})`}(Tt(n))}; limitType=${n.limitType})`}function _i(n,t){return t.isFoundDocument()&&function(r,i){let s=i.key.path;return r.collectionGroup!==null?i.key.hasCollectionId(r.collectionGroup)&&r.path.isPrefixOf(s):I.isDocumentKey(r.path)?r.path.isEqual(s):r.path.isImmediateParentOf(s)}(n,t)&&function(r,i){for(let s of Nn(r))if(!s.field.isKeyField()&&i.data.field(s.field)===null)return!1;return!0}(n,t)&&function(r,i){for(let s of r.filters)if(!s.matches(i))return!1;return!0}(n,t)&&function(r,i){return!(r.startAt&&!function(o,a,u){let c=Ed(o,a,u);return o.inclusive?c<=0:c<0}(r.startAt,Nn(r),i)||r.endAt&&!function(o,a,u){let c=Ed(o,a,u);return o.inclusive?c>=0:c>0}(r.endAt,Nn(r),i))}(n,t)}function Lf(n){return n.collectionGroup||(n.path.length%2==1?n.path.lastSegment():n.path.get(n.path.length-2))}function Of(n){return(t,e)=>{let r=!1;for(let i of Nn(n)){let s=f_(i,t,e);if(s!==0)return s;r=r||i.field.isKeyField()}return 0}}function f_(n,t,e){let r=n.field.isKeyField()?I.comparator(t.key,e.key):function(s,o,a){let u=o.data.field(s),c=a.data.field(s);return u!==null&&c!==null?Pe(u,c):S()}(n.field,t,e);switch(n.dir){case"asc":return r;case"desc":return-1*r;default:return S()}}var te=class{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){let e=this.mapKeyFn(t),r=this.inner[e];if(r!==void 0){for(let[i,s]of r)if(this.equalsFn(i,t))return s}}has(t){return this.get(t)!==void 0}set(t,e){let r=this.mapKeyFn(t),i=this.inner[r];if(i===void 0)return this.inner[r]=[[t,e]],void this.innerSize++;for(let s=0;s<i.length;s++)if(this.equalsFn(i[s][0],t))return void(i[s]=[t,e]);i.push([t,e]),this.innerSize++}delete(t){let e=this.mapKeyFn(t),r=this.inner[e];if(r===void 0)return!1;for(let i=0;i<r.length;i++)if(this.equalsFn(r[i][0],t))return r.length===1?delete this.inner[e]:r.splice(i,1),this.innerSize--,!0;return!1}forEach(t){an(this.inner,(e,r)=>{for(let[i,s]of r)t(i,s)})}isEmpty(){return Rf(this.inner)}size(){return this.innerSize}};var m_=new $(I.comparator);function St(){return m_}var qf=new $(I.comparator);function qr(...n){let t=qf;for(let e of n)t=t.insert(e.key,e);return t}function Bf(n){let t=qf;return n.forEach((e,r)=>t=t.insert(e,r.overlayedDocument)),t}function Wt(){return Gr()}function Uf(){return Gr()}function Gr(){return new te(n=>n.toString(),(n,t)=>n.isEqual(t))}var g_=new $(I.comparator),p_=new z(I.comparator);function V(...n){let t=p_;for(let e of n)t=t.add(e);return t}var __=new z(C);function xc(){return __}function Gf(n,t){if(n.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Qr(t)?"-0":t}}function zf(n){return{integerValue:""+n}}function jf(n,t){return vf(t)?zf(t):Gf(n,t)}var qn=class{constructor(){this._=void 0}};function y_(n,t,e){return n instanceof be?function(i,s){let o={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:i.seconds,nanos:i.nanoseconds}}}};return s&&uo(s)&&(s=Rc(s)),s&&(o.fields.__previous_value__=s),{mapValue:o}}(e,t):n instanceof ce?$f(n,t):n instanceof le?Qf(n,t):function(i,s){let o=Kf(i,s),a=Pd(o)+Pd(i.Pe);return qa(o)&&qa(i.Pe)?zf(a):Gf(i.serializer,a)}(n,t)}function w_(n,t,e){return n instanceof ce?$f(n,t):n instanceof le?Qf(n,t):e}function Kf(n,t){return n instanceof xe?function(r){return qa(r)||function(s){return!!s&&"doubleValue"in s}(r)}(t)?t:{integerValue:0}:null}var be=class extends qn{},ce=class extends qn{constructor(t){super(),this.elements=t}};function $f(n,t){let e=Wf(t);for(let r of n.elements)e.some(i=>Xt(i,r))||e.push(r);return{arrayValue:{values:e}}}var le=class extends qn{constructor(t){super(),this.elements=t}};function Qf(n,t){let e=Wf(t);for(let r of n.elements)e=e.filter(i=>!Xt(i,r));return{arrayValue:{values:e}}}var xe=class extends qn{constructor(t,e){super(),this.serializer=t,this.Pe=e}};function Pd(n){return Y(n.integerValue||n.doubleValue)}function Wf(n){return Yr(n)&&n.arrayValue.values?n.arrayValue.values.slice():[]}var Ze=class{constructor(t,e){this.field=t,this.transform=e}};function v_(n,t){return n.field.isEqual(t.field)&&function(r,i){return r instanceof ce&&i instanceof ce||r instanceof le&&i instanceof le?Fn(r.elements,i.elements,Xt):r instanceof xe&&i instanceof xe?Xt(r.Pe,i.Pe):r instanceof be&&i instanceof be}(n.transform,t.transform)}var Ya=class{constructor(t,e){this.version=t,this.transformResults=e}},X=class n{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new n}static exists(t){return new n(void 0,t)}static updateTime(t){return new n(t)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}};function cs(n,t){return n.updateTime!==void 0?t.isFoundDocument()&&t.version.isEqual(n.updateTime):n.exists===void 0||n.exists===t.isFoundDocument()}var Bn=class{};function Hf(n,t){if(!n.hasLocalMutations||t&&t.fields.length===0)return null;if(t===null)return n.isNoDocument()?new Ce(n.key,X.none()):new De(n.key,n.data,X.none());{let e=n.data,r=vt.empty(),i=new z(tt.comparator);for(let s of t.fields)if(!i.has(s)){let o=e.field(s);o===null&&s.length>1&&(s=s.popLast(),o=e.field(s)),o===null?r.delete(s):r.set(s,o),i=i.add(s)}return new qt(n.key,r,new xt(i.toArray()),X.none())}}function I_(n,t,e){n instanceof De?function(i,s,o){let a=i.value.clone(),u=xd(i.fieldTransforms,s,o.transformResults);a.setAll(u),s.convertToFoundDocument(o.version,a).setHasCommittedMutations()}(n,t,e):n instanceof qt?function(i,s,o){if(!cs(i.precondition,s))return void s.convertToUnknownDocument(o.version);let a=xd(i.fieldTransforms,s,o.transformResults),u=s.data;u.setAll(Jf(i)),u.setAll(a),s.convertToFoundDocument(o.version,u).setHasCommittedMutations()}(n,t,e):function(i,s,o){s.convertToNoDocument(o.version).setHasCommittedMutations()}(0,t,e)}function zr(n,t,e,r){return n instanceof De?function(s,o,a,u){if(!cs(s.precondition,o))return a;let c=s.value.clone(),l=Dd(s.fieldTransforms,u,o);return c.setAll(l),o.convertToFoundDocument(o.version,c).setHasLocalMutations(),null}(n,t,e,r):n instanceof qt?function(s,o,a,u){if(!cs(s.precondition,o))return a;let c=Dd(s.fieldTransforms,u,o),l=o.data;return l.setAll(Jf(s)),l.setAll(c),o.convertToFoundDocument(o.version,l).setHasLocalMutations(),a===null?null:a.unionWith(s.fieldMask.fields).unionWith(s.fieldTransforms.map(h=>h.field))}(n,t,e,r):function(s,o,a){return cs(s.precondition,o)?(o.convertToNoDocument(o.version).setHasLocalMutations(),null):a}(n,t,e)}function E_(n,t){let e=null;for(let r of n.fieldTransforms){let i=t.data.field(r.field),s=Kf(r.transform,i||null);s!=null&&(e===null&&(e=vt.empty()),e.set(r.field,s))}return e||null}function bd(n,t){return n.type===t.type&&!!n.key.isEqual(t.key)&&!!n.precondition.isEqual(t.precondition)&&!!function(r,i){return r===void 0&&i===void 0||!(!r||!i)&&Fn(r,i,(s,o)=>v_(s,o))}(n.fieldTransforms,t.fieldTransforms)&&(n.type===0?n.value.isEqual(t.value):n.type!==1||n.data.isEqual(t.data)&&n.fieldMask.isEqual(t.fieldMask))}var De=class extends Bn{constructor(t,e,r,i=[]){super(),this.key=t,this.value=e,this.precondition=r,this.fieldTransforms=i,this.type=0}getFieldMask(){return null}},qt=class extends Bn{constructor(t,e,r,i,s=[]){super(),this.key=t,this.data=e,this.fieldMask=r,this.precondition=i,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}};function Jf(n){let t=new Map;return n.fieldMask.fields.forEach(e=>{if(!e.isEmpty()){let r=n.data.field(e);t.set(e,r)}}),t}function xd(n,t,e){let r=new Map;R(n.length===e.length);for(let i=0;i<e.length;i++){let s=n[i],o=s.transform,a=t.data.field(s.field);r.set(s.field,w_(o,a,e[i]))}return r}function Dd(n,t,e){let r=new Map;for(let i of n){let s=i.transform,o=e.data.field(i.field);r.set(i.field,y_(s,o,t))}return r}var Ce=class extends Bn{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}},Xr=class extends Bn{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}};var Zr=class{constructor(t,e,r,i){this.batchId=t,this.localWriteTime=e,this.baseMutations=r,this.mutations=i}applyToRemoteDocument(t,e){let r=e.mutationResults;for(let i=0;i<this.mutations.length;i++){let s=this.mutations[i];s.key.isEqual(t.key)&&I_(s,t,r[i])}}applyToLocalView(t,e){for(let r of this.baseMutations)r.key.isEqual(t.key)&&(e=zr(r,t,e,this.localWriteTime));for(let r of this.mutations)r.key.isEqual(t.key)&&(e=zr(r,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){let r=Uf();return this.mutations.forEach(i=>{let s=t.get(i.key),o=s.overlayedDocument,a=this.applyToLocalView(o,s.mutatedFields);a=e.has(i.key)?null:a;let u=Hf(o,a);u!==null&&r.set(i.key,u),o.isValidDocument()||o.convertToNoDocument(P.min())}),r}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),V())}isEqual(t){return this.batchId===t.batchId&&Fn(this.mutations,t.mutations,(e,r)=>bd(e,r))&&Fn(this.baseMutations,t.baseMutations,(e,r)=>bd(e,r))}},Xa=class n{constructor(t,e,r,i){this.batch=t,this.commitVersion=e,this.mutationResults=r,this.docVersions=i}static from(t,e,r){R(t.mutations.length===r.length);let i=function(){return g_}(),s=t.mutations;for(let o=0;o<s.length;o++)i=i.insert(s[o].key,r[o].version);return new n(t,e,r,i)}};var ti=class{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return t!==null&&this.mutation===t.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}};var Za=class{constructor(t,e){this.count=t,this.unchangedNames=e}};var it,F;function Yf(n){switch(n){default:return S();case g.CANCELLED:case g.UNKNOWN:case g.DEADLINE_EXCEEDED:case g.RESOURCE_EXHAUSTED:case g.INTERNAL:case g.UNAVAILABLE:case g.UNAUTHENTICATED:return!1;case g.INVALID_ARGUMENT:case g.NOT_FOUND:case g.ALREADY_EXISTS:case g.PERMISSION_DENIED:case g.FAILED_PRECONDITION:case g.ABORTED:case g.OUT_OF_RANGE:case g.UNIMPLEMENTED:case g.DATA_LOSS:return!0}}function Xf(n){if(n===void 0)return Z("GRPC error has no .code"),g.UNKNOWN;switch(n){case it.OK:return g.OK;case it.CANCELLED:return g.CANCELLED;case it.UNKNOWN:return g.UNKNOWN;case it.DEADLINE_EXCEEDED:return g.DEADLINE_EXCEEDED;case it.RESOURCE_EXHAUSTED:return g.RESOURCE_EXHAUSTED;case it.INTERNAL:return g.INTERNAL;case it.UNAVAILABLE:return g.UNAVAILABLE;case it.UNAUTHENTICATED:return g.UNAUTHENTICATED;case it.INVALID_ARGUMENT:return g.INVALID_ARGUMENT;case it.NOT_FOUND:return g.NOT_FOUND;case it.ALREADY_EXISTS:return g.ALREADY_EXISTS;case it.PERMISSION_DENIED:return g.PERMISSION_DENIED;case it.FAILED_PRECONDITION:return g.FAILED_PRECONDITION;case it.ABORTED:return g.ABORTED;case it.OUT_OF_RANGE:return g.OUT_OF_RANGE;case it.UNIMPLEMENTED:return g.UNIMPLEMENTED;case it.DATA_LOSS:return g.DATA_LOSS;default:return S()}}(F=it||(it={}))[F.OK=0]="OK",F[F.CANCELLED=1]="CANCELLED",F[F.UNKNOWN=2]="UNKNOWN",F[F.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",F[F.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",F[F.NOT_FOUND=5]="NOT_FOUND",F[F.ALREADY_EXISTS=6]="ALREADY_EXISTS",F[F.PERMISSION_DENIED=7]="PERMISSION_DENIED",F[F.UNAUTHENTICATED=16]="UNAUTHENTICATED",F[F.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",F[F.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",F[F.ABORTED=10]="ABORTED",F[F.OUT_OF_RANGE=11]="OUT_OF_RANGE",F[F.UNIMPLEMENTED=12]="UNIMPLEMENTED",F[F.INTERNAL=13]="INTERNAL",F[F.UNAVAILABLE=14]="UNAVAILABLE",F[F.DATA_LOSS=15]="DATA_LOSS";var Cd=null;function Zf(){return new TextEncoder}var T_=new Be([4294967295,4294967295],0);function Vd(n){let t=Zf().encode(n),e=new hd;return e.update(t),new Uint8Array(e.digest())}function Nd(n){let t=new DataView(n.buffer),e=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new Be([e,r],0),new Be([i,s],0)]}var tu=class n{constructor(t,e,r){if(this.bitmap=t,this.padding=e,this.hashCount=r,e<0||e>=8)throw new Qe(`Invalid padding: ${e}`);if(r<0)throw new Qe(`Invalid hash count: ${r}`);if(t.length>0&&this.hashCount===0)throw new Qe(`Invalid hash count: ${r}`);if(t.length===0&&e!==0)throw new Qe(`Invalid padding when bitmap length is 0: ${e}`);this.Ie=8*t.length-e,this.Te=Be.fromNumber(this.Ie)}Ee(t,e,r){let i=t.add(e.multiply(Be.fromNumber(r)));return i.compare(T_)===1&&(i=new Be([i.getBits(0),i.getBits(1)],0)),i.modulo(this.Te).toNumber()}de(t){return(this.bitmap[Math.floor(t/8)]&1<<t%8)!=0}mightContain(t){if(this.Ie===0)return!1;let e=Vd(t),[r,i]=Nd(e);for(let s=0;s<this.hashCount;s++){let o=this.Ee(r,i,s);if(!this.de(o))return!1}return!0}static create(t,e,r){let i=t%8==0?0:8-t%8,s=new Uint8Array(Math.ceil(t/8)),o=new n(s,i,e);return r.forEach(a=>o.insert(a)),o}insert(t){if(this.Ie===0)return;let e=Vd(t),[r,i]=Nd(e);for(let s=0;s<this.hashCount;s++){let o=this.Ee(r,i,s);this.Ae(o)}}Ae(t){let e=Math.floor(t/8),r=t%8;this.bitmap[e]|=1<<r}},Qe=class extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}};var ei=class n{constructor(t,e,r,i,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=r,this.documentUpdates=i,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e,r){let i=new Map;return i.set(t,ni.createSynthesizedTargetChangeForCurrentChange(t,e,r)),new n(P.min(),i,new $(C),St(),V())}},ni=class n{constructor(t,e,r,i,s){this.resumeToken=t,this.current=e,this.addedDocuments=r,this.modifiedDocuments=i,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e,r){return new n(r,e,V(),V(),V())}};var kn=class{constructor(t,e,r,i){this.Re=t,this.removedTargetIds=e,this.key=r,this.Ve=i}},As=class{constructor(t,e){this.targetId=t,this.me=e}},Ss=class{constructor(t,e,r=dt.EMPTY_BYTE_STRING,i=null){this.state=t,this.targetIds=e,this.resumeToken=r,this.cause=i}},Rs=class{constructor(){this.fe=0,this.ge=Fd(),this.pe=dt.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return this.fe!==0}get be(){return this.we}De(t){t.approximateByteSize()>0&&(this.we=!0,this.pe=t)}Ce(){let t=V(),e=V(),r=V();return this.ge.forEach((i,s)=>{switch(s){case 0:t=t.add(i);break;case 2:e=e.add(i);break;case 1:r=r.add(i);break;default:S()}}),new ni(this.pe,this.ye,t,e,r)}ve(){this.we=!1,this.ge=Fd()}Fe(t,e){this.we=!0,this.ge=this.ge.insert(t,e)}Me(t){this.we=!0,this.ge=this.ge.remove(t)}xe(){this.fe+=1}Oe(){this.fe-=1,R(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}},eu=class{constructor(t){this.Le=t,this.Be=new Map,this.ke=St(),this.qe=kd(),this.Qe=new $(C)}Ke(t){for(let e of t.Re)t.Ve&&t.Ve.isFoundDocument()?this.$e(e,t.Ve):this.Ue(e,t.key,t.Ve);for(let e of t.removedTargetIds)this.Ue(e,t.key,t.Ve)}We(t){this.forEachTarget(t,e=>{let r=this.Ge(e);switch(t.state){case 0:this.ze(e)&&r.De(t.resumeToken);break;case 1:r.Oe(),r.Se||r.ve(),r.De(t.resumeToken);break;case 2:r.Oe(),r.Se||this.removeTarget(e);break;case 3:this.ze(e)&&(r.Ne(),r.De(t.resumeToken));break;case 4:this.ze(e)&&(this.je(e),r.De(t.resumeToken));break;default:S()}})}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Be.forEach((r,i)=>{this.ze(i)&&e(i)})}He(t){let e=t.targetId,r=t.me.count,i=this.Je(e);if(i){let s=i.target;if(Is(s))if(r===0){let o=new I(s.path);this.Ue(e,o,ut.newNoDocument(o,P.min()))}else R(r===1);else{let o=this.Ye(e);if(o!==r){let a=this.Ze(t),u=a?this.Xe(a,t,o):1;if(u!==0){this.je(e);let c=u===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(e,c)}Cd?.et(function(l,h,d,m,A){var w,v,b,N,x,q;let B={localCacheCount:l,existenceFilterCount:h.count,databaseId:d.database,projectId:d.projectId},O=h.unchangedNames;return O&&(B.bloomFilter={applied:A===0,hashCount:(w=O?.hashCount)!==null&&w!==void 0?w:0,bitmapLength:(N=(b=(v=O?.bits)===null||v===void 0?void 0:v.bitmap)===null||b===void 0?void 0:b.length)!==null&&N!==void 0?N:0,padding:(q=(x=O?.bits)===null||x===void 0?void 0:x.padding)!==null&&q!==void 0?q:0,mightContain:nt=>{var Gt;return(Gt=m?.mightContain(nt))!==null&&Gt!==void 0&&Gt}}),B}(o,t.me,this.Le.tt(),a,u))}}}}Ze(t){let e=t.me.unchangedNames;if(!e||!e.bits)return null;let{bits:{bitmap:r="",padding:i=0},hashCount:s=0}=e,o,a;try{o=Se(r).toUint8Array()}catch(u){if(u instanceof ys)return Nt("Decoding the base64 bloom filter in existence filter failed ("+u.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw u}try{a=new tu(o,i,s)}catch(u){return Nt(u instanceof Qe?"BloomFilter error: ":"Applying bloom filter failed: ",u),null}return a.Ie===0?null:a}Xe(t,e,r){return e.me.count===r-this.nt(t,e.targetId)?0:2}nt(t,e){let r=this.Le.getRemoteKeysForTarget(e),i=0;return r.forEach(s=>{let o=this.Le.tt(),a=`projects/${o.projectId}/databases/${o.database}/documents/${s.path.canonicalString()}`;t.mightContain(a)||(this.Ue(e,s,null),i++)}),i}rt(t){let e=new Map;this.Be.forEach((s,o)=>{let a=this.Je(o);if(a){if(s.current&&Is(a.target)){let u=new I(a.target.path);this.ke.get(u)!==null||this.it(o,u)||this.Ue(o,u,ut.newNoDocument(u,t))}s.be&&(e.set(o,s.Ce()),s.ve())}});let r=V();this.qe.forEach((s,o)=>{let a=!0;o.forEachWhile(u=>{let c=this.Je(u);return!c||c.purpose==="TargetPurposeLimboResolution"||(a=!1,!1)}),a&&(r=r.add(s))}),this.ke.forEach((s,o)=>o.setReadTime(t));let i=new ei(t,e,this.Qe,this.ke,r);return this.ke=St(),this.qe=kd(),this.Qe=new $(C),i}$e(t,e){if(!this.ze(t))return;let r=this.it(t,e.key)?2:0;this.Ge(t).Fe(e.key,r),this.ke=this.ke.insert(e.key,e),this.qe=this.qe.insert(e.key,this.st(e.key).add(t))}Ue(t,e,r){if(!this.ze(t))return;let i=this.Ge(t);this.it(t,e)?i.Fe(e,1):i.Me(e),this.qe=this.qe.insert(e,this.st(e).delete(t)),r&&(this.ke=this.ke.insert(e,r))}removeTarget(t){this.Be.delete(t)}Ye(t){let e=this.Ge(t).Ce();return this.Le.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}xe(t){this.Ge(t).xe()}Ge(t){let e=this.Be.get(t);return e||(e=new Rs,this.Be.set(t,e)),e}st(t){let e=this.qe.get(t);return e||(e=new z(C),this.qe=this.qe.insert(t,e)),e}ze(t){let e=this.Je(t)!==null;return e||y("WatchChangeAggregator","Detected inactive target",t),e}Je(t){let e=this.Be.get(t);return e&&e.Se?null:this.Le.ot(t)}je(t){this.Be.set(t,new Rs),this.Le.getRemoteKeysForTarget(t).forEach(e=>{this.Ue(t,e,null)})}it(t,e){return this.Le.getRemoteKeysForTarget(t).has(e)}};function kd(){return new $(I.comparator)}function Fd(){return new $(I.comparator)}var A_={asc:"ASCENDING",desc:"DESCENDING"},S_={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},R_={and:"AND",or:"OR"},nu=class{constructor(t,e){this.databaseId=t,this.useProto3Json=e}};function ru(n,t){return n.useProto3Json||mi(t)?t:{value:t}}function Un(n,t){return n.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function tm(n,t){return n.useProto3Json?t.toBase64():t.toUint8Array()}function P_(n,t){return Un(n,t.toTimestamp())}function et(n){return R(!!n),P.fromTimestamp(function(e){let r=ue(e);return new W(r.seconds,r.nanos)}(n))}function Dc(n,t){return iu(n,t).canonicalString()}function iu(n,t){let e=function(i){return new M(["projects",i.projectId,"databases",i.database])}(n).child("documents");return t===void 0?e:e.child(t)}function em(n){let t=M.fromString(n);return R(hm(t)),t}function ri(n,t){return Dc(n.databaseId,t.path)}function Jt(n,t){let e=em(t);if(e.get(1)!==n.databaseId.projectId)throw new _(g.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+e.get(1)+" vs "+n.databaseId.projectId);if(e.get(3)!==n.databaseId.database)throw new _(g.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+e.get(3)+" vs "+n.databaseId.database);return new I(im(e))}function nm(n,t){return Dc(n.databaseId,t)}function rm(n){let t=em(n);return t.length===4?M.emptyPath():im(t)}function su(n){return new M(["projects",n.databaseId.projectId,"databases",n.databaseId.database]).canonicalString()}function im(n){return R(n.length>4&&n.get(4)==="documents"),n.popFirst(5)}function Md(n,t,e){return{name:ri(n,t),fields:e.value.mapValue.fields}}function sm(n,t,e){let r=Jt(n,t.name),i=et(t.updateTime),s=t.createTime?et(t.createTime):P.min(),o=new vt({mapValue:{fields:t.fields}}),a=ut.newFoundDocument(r,i,s,o);return e&&a.setHasCommittedMutations(),e?a.setHasCommittedMutations():a}function b_(n,t){return"found"in t?function(r,i){R(!!i.found),i.found.name,i.found.updateTime;let s=Jt(r,i.found.name),o=et(i.found.updateTime),a=i.found.createTime?et(i.found.createTime):P.min(),u=new vt({mapValue:{fields:i.found.fields}});return ut.newFoundDocument(s,o,a,u)}(n,t):"missing"in t?function(r,i){R(!!i.missing),R(!!i.readTime);let s=Jt(r,i.missing),o=et(i.readTime);return ut.newNoDocument(s,o)}(n,t):S()}function x_(n,t){let e;if("targetChange"in t){t.targetChange;let r=function(c){return c==="NO_CHANGE"?0:c==="ADD"?1:c==="REMOVE"?2:c==="CURRENT"?3:c==="RESET"?4:S()}(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],s=function(c,l){return c.useProto3Json?(R(l===void 0||typeof l=="string"),dt.fromBase64String(l||"")):(R(l===void 0||l instanceof Buffer||l instanceof Uint8Array),dt.fromUint8Array(l||new Uint8Array))}(n,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(c){let l=c.code===void 0?g.UNKNOWN:Xf(c.code);return new _(l,c.message||"")}(o);e=new Ss(r,i,s,a||null)}else if("documentChange"in t){t.documentChange;let r=t.documentChange;r.document,r.document.name,r.document.updateTime;let i=Jt(n,r.document.name),s=et(r.document.updateTime),o=r.document.createTime?et(r.document.createTime):P.min(),a=new vt({mapValue:{fields:r.document.fields}}),u=ut.newFoundDocument(i,s,o,a),c=r.targetIds||[],l=r.removedTargetIds||[];e=new kn(c,l,u.key,u)}else if("documentDelete"in t){t.documentDelete;let r=t.documentDelete;r.document;let i=Jt(n,r.document),s=r.readTime?et(r.readTime):P.min(),o=ut.newNoDocument(i,s),a=r.removedTargetIds||[];e=new kn([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;let r=t.documentRemove;r.document;let i=Jt(n,r.document),s=r.removedTargetIds||[];e=new kn([],s,i,null)}else{if(!("filter"in t))return S();{t.filter;let r=t.filter;r.targetId;let{count:i=0,unchangedNames:s}=r,o=new Za(i,s),a=r.targetId;e=new As(a,o)}}return e}function ii(n,t){let e;if(t instanceof De)e={update:Md(n,t.key,t.value)};else if(t instanceof Ce)e={delete:ri(n,t.key)};else if(t instanceof qt)e={update:Md(n,t.key,t.data),updateMask:F_(t.fieldMask)};else{if(!(t instanceof Xr))return S();e={verify:ri(n,t.key)}}return t.fieldTransforms.length>0&&(e.updateTransforms=t.fieldTransforms.map(r=>function(s,o){let a=o.transform;if(a instanceof be)return{fieldPath:o.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(a instanceof ce)return{fieldPath:o.field.canonicalString(),appendMissingElements:{values:a.elements}};if(a instanceof le)return{fieldPath:o.field.canonicalString(),removeAllFromArray:{values:a.elements}};if(a instanceof xe)return{fieldPath:o.field.canonicalString(),increment:a.Pe};throw S()}(0,r))),t.precondition.isNone||(e.currentDocument=function(i,s){return s.updateTime!==void 0?{updateTime:P_(i,s.updateTime)}:s.exists!==void 0?{exists:s.exists}:S()}(n,t.precondition)),e}function ou(n,t){let e=t.currentDocument?function(s){return s.updateTime!==void 0?X.updateTime(et(s.updateTime)):s.exists!==void 0?X.exists(s.exists):X.none()}(t.currentDocument):X.none(),r=t.updateTransforms?t.updateTransforms.map(i=>function(o,a){let u=null;if("setToServerValue"in a)R(a.setToServerValue==="REQUEST_TIME"),u=new be;else if("appendMissingElements"in a){let l=a.appendMissingElements.values||[];u=new ce(l)}else if("removeAllFromArray"in a){let l=a.removeAllFromArray.values||[];u=new le(l)}else"increment"in a?u=new xe(o,a.increment):S();let c=tt.fromServerFormat(a.fieldPath);return new Ze(c,u)}(n,i)):[];if(t.update){t.update.name;let i=Jt(n,t.update.name),s=new vt({mapValue:{fields:t.update.fields}});if(t.updateMask){let o=function(u){let c=u.fieldPaths||[];return new xt(c.map(l=>tt.fromServerFormat(l)))}(t.updateMask);return new qt(i,s,o,e,r)}return new De(i,s,e,r)}if(t.delete){let i=Jt(n,t.delete);return new Ce(i,e)}if(t.verify){let i=Jt(n,t.verify);return new Xr(i,e)}return S()}function D_(n,t){return n&&n.length>0?(R(t!==void 0),n.map(e=>function(i,s){let o=i.updateTime?et(i.updateTime):et(s);return o.isEqual(P.min())&&(o=et(s)),new Ya(o,i.transformResults||[])}(e,t))):[]}function om(n,t){return{documents:[nm(n,t.path)]}}function am(n,t){let e={structuredQuery:{}},r=t.path,i;t.collectionGroup!==null?(i=r,e.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=r.popLast(),e.structuredQuery.from=[{collectionId:r.lastSegment()}]),e.parent=nm(n,i);let s=function(c){if(c.length!==0)return lm(G.create(c,"and"))}(t.filters);s&&(e.structuredQuery.where=s);let o=function(c){if(c.length!==0)return c.map(l=>function(d){return{field:bn(d.field),direction:V_(d.dir)}}(l))}(t.orderBy);o&&(e.structuredQuery.orderBy=o);let a=ru(n,t.limit);return a!==null&&(e.structuredQuery.limit=a),t.startAt&&(e.structuredQuery.startAt=function(c){return{before:c.inclusive,values:c.position}}(t.startAt)),t.endAt&&(e.structuredQuery.endAt=function(c){return{before:!c.inclusive,values:c.position}}(t.endAt)),{_t:e,parent:i}}function um(n){let t=rm(n.parent),e=n.structuredQuery,r=e.from?e.from.length:0,i=null;if(r>0){R(r===1);let l=e.from[0];l.allDescendants?i=l.collectionId:t=t.child(l.collectionId)}let s=[];e.where&&(s=function(h){let d=cm(h);return d instanceof G&&Pc(d)?d.getFilters():[d]}(e.where));let o=[];e.orderBy&&(o=function(h){return h.map(d=>function(A){return new Ye(xn(A.field),function(v){switch(v){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(A.direction))}(d))}(e.orderBy));let a=null;e.limit&&(a=function(h){let d;return d=typeof h=="object"?h.value:h,mi(d)?null:d}(e.limit));let u=null;e.startAt&&(u=function(h){let d=!!h.before,m=h.values||[];return new Zt(m,d)}(e.startAt));let c=null;return e.endAt&&(c=function(h){let d=!h.before,m=h.values||[];return new Zt(m,d)}(e.endAt)),Ff(t,i,o,s,a,"F",u,c)}function C_(n,t){let e=function(i){switch(i){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return S()}}(t.purpose);return e==null?null:{"goog-listen-tags":e}}function cm(n){return n.unaryFilter!==void 0?function(e){switch(e.unaryFilter.op){case"IS_NAN":let r=xn(e.unaryFilter.field);return k.create(r,"==",{doubleValue:NaN});case"IS_NULL":let i=xn(e.unaryFilter.field);return k.create(i,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let s=xn(e.unaryFilter.field);return k.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let o=xn(e.unaryFilter.field);return k.create(o,"!=",{nullValue:"NULL_VALUE"});default:return S()}}(n):n.fieldFilter!==void 0?function(e){return k.create(xn(e.fieldFilter.field),function(i){switch(i){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return S()}}(e.fieldFilter.op),e.fieldFilter.value)}(n):n.compositeFilter!==void 0?function(e){return G.create(e.compositeFilter.filters.map(r=>cm(r)),function(i){switch(i){case"AND":return"and";case"OR":return"or";default:return S()}}(e.compositeFilter.op))}(n):S()}function V_(n){return A_[n]}function N_(n){return S_[n]}function k_(n){return R_[n]}function bn(n){return{fieldPath:n.canonicalString()}}function xn(n){return tt.fromServerFormat(n.fieldPath)}function lm(n){return n instanceof k?function(e){if(e.op==="=="){if(wd(e.value))return{unaryFilter:{field:bn(e.field),op:"IS_NAN"}};if(yd(e.value))return{unaryFilter:{field:bn(e.field),op:"IS_NULL"}}}else if(e.op==="!="){if(wd(e.value))return{unaryFilter:{field:bn(e.field),op:"IS_NOT_NAN"}};if(yd(e.value))return{unaryFilter:{field:bn(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:bn(e.field),op:N_(e.op),value:e.value}}}(n):n instanceof G?function(e){let r=e.getFilters().map(i=>lm(i));return r.length===1?r[0]:{compositeFilter:{op:k_(e.op),filters:r}}}(n):S()}function F_(n){let t=[];return n.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}function hm(n){return n.length>=4&&n.get(0)==="projects"&&n.get(2)==="databases"}var Gn=class n{constructor(t,e,r,i,s=P.min(),o=P.min(),a=dt.EMPTY_BYTE_STRING,u=null){this.target=t,this.targetId=e,this.purpose=r,this.sequenceNumber=i,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=a,this.expectedCount=u}withSequenceNumber(t){return new n(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}};var Ps=class{constructor(t){this.ut=t}};function M_(n,t){let e;if(t.document)e=sm(n.ut,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let r=I.fromSegments(t.noDocument.path),i=en(t.noDocument.readTime);e=ut.newNoDocument(r,i),t.hasCommittedMutations&&e.setHasCommittedMutations()}else{if(!t.unknownDocument)return S();{let r=I.fromSegments(t.unknownDocument.path),i=en(t.unknownDocument.version);e=ut.newUnknownDocument(r,i)}}return t.readTime&&e.setReadTime(function(i){let s=new W(i[0],i[1]);return P.fromTimestamp(s)}(t.readTime)),e}function Ld(n,t){let e=t.key,r={prefixPath:e.getCollectionPath().popLast().toArray(),collectionGroup:e.collectionGroup,documentId:e.path.lastSegment(),readTime:bs(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document=function(s,o){return{name:ri(s,o.key),fields:o.data.value.mapValue.fields,updateTime:Un(s,o.version.toTimestamp()),createTime:Un(s,o.createTime.toTimestamp())}}(n.ut,t);else if(t.isNoDocument())r.noDocument={path:e.path.toArray(),readTime:tn(t.version)};else{if(!t.isUnknownDocument())return S();r.unknownDocument={path:e.path.toArray(),version:tn(t.version)}}return r}function bs(n){let t=n.toTimestamp();return[t.seconds,t.nanoseconds]}function tn(n){let t=n.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function en(n){let t=new W(n.seconds,n.nanoseconds);return P.fromTimestamp(t)}function je(n,t){let e=(t.baseMutations||[]).map(s=>ou(n.ut,s));for(let s=0;s<t.mutations.length-1;++s){let o=t.mutations[s];if(s+1<t.mutations.length&&t.mutations[s+1].transform!==void 0){let a=t.mutations[s+1];o.updateTransforms=a.transform.fieldTransforms,t.mutations.splice(s+1,1),++s}}let r=t.mutations.map(s=>ou(n.ut,s)),i=W.fromMillis(t.localWriteTimeMs);return new Zr(t.batchId,i,e,r)}function Br(n){let t=en(n.readTime),e=n.lastLimboFreeSnapshotVersion!==void 0?en(n.lastLimboFreeSnapshotVersion):P.min(),r;return r=function(s){return s.documents!==void 0}(n.query)?function(s){return R(s.documents.length===1),Tt(Zn(rm(s.documents[0])))}(n.query):function(s){return Tt(um(s))}(n.query),new Gn(r,n.targetId,"TargetPurposeListen",n.lastListenSequenceNumber,t,e,dt.fromBase64String(n.resumeToken))}function dm(n,t){let e=tn(t.snapshotVersion),r=tn(t.lastLimboFreeSnapshotVersion),i;i=Is(t.target)?om(n.ut,t.target):am(n.ut,t.target)._t;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:Xe(t.target),readTime:e,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:i}}function Cc(n){let t=um({parent:n.parent,structuredQuery:n.structuredQuery});return n.limitType==="LAST"?Ts(t,t.limit,"L"):t}function Ia(n,t){return new ti(t.largestBatchId,ou(n.ut,t.overlayMutation))}function Od(n,t){let e=t.path.lastSegment();return[n,Et(t.path.popLast()),e]}function qd(n,t,e,r){return{indexId:n,uid:t,sequenceNumber:e,readTime:tn(r.readTime),documentKey:Et(r.documentKey.path),largestBatchId:r.largestBatchId}}var au=class{getBundleMetadata(t,e){return Bd(t).get(e).next(r=>{if(r)return function(s){return{id:s.bundleId,createTime:en(s.createTime),version:s.version}}(r)})}saveBundleMetadata(t,e){return Bd(t).put(function(i){return{bundleId:i.id,createTime:tn(et(i.createTime)),version:i.version}}(e))}getNamedQuery(t,e){return Ud(t).get(e).next(r=>{if(r)return function(s){return{name:s.name,query:Cc(s.bundledQuery),readTime:en(s.readTime)}}(r)})}saveNamedQuery(t,e){return Ud(t).put(function(i){return{name:i.name,readTime:tn(et(i.readTime)),bundledQuery:i.bundledQuery}}(e))}};function Bd(n){return ft(n,"bundles")}function Ud(n){return ft(n,"namedQueries")}var xs=class n{constructor(t,e){this.serializer=t,this.userId=e}static ct(t,e){let r=e.uid||"";return new n(t,r)}getOverlay(t,e){return Fr(t).get(Od(this.userId,e)).next(r=>r?Ia(this.serializer,r):null)}getOverlays(t,e){let r=Wt();return f.forEach(e,i=>this.getOverlay(t,i).next(s=>{s!==null&&r.set(i,s)})).next(()=>r)}saveOverlays(t,e,r){let i=[];return r.forEach((s,o)=>{let a=new ti(e,o);i.push(this.lt(t,a))}),f.waitFor(i)}removeOverlaysForBatchId(t,e,r){let i=new Set;e.forEach(o=>i.add(Et(o.getCollectionPath())));let s=[];return i.forEach(o=>{let a=IDBKeyRange.bound([this.userId,o,r],[this.userId,o,r+1],!1,!0);s.push(Fr(t).j("collectionPathOverlayIndex",a))}),f.waitFor(s)}getOverlaysForCollection(t,e,r){let i=Wt(),s=Et(e),o=IDBKeyRange.bound([this.userId,s,r],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Fr(t).U("collectionPathOverlayIndex",o).next(a=>{for(let u of a){let c=Ia(this.serializer,u);i.set(c.getKey(),c)}return i})}getOverlaysForCollectionGroup(t,e,r,i){let s=Wt(),o,a=IDBKeyRange.bound([this.userId,e,r],[this.userId,e,Number.POSITIVE_INFINITY],!0);return Fr(t).J({index:"collectionGroupOverlayIndex",range:a},(u,c,l)=>{let h=Ia(this.serializer,c);s.size()<i||h.largestBatchId===o?(s.set(h.getKey(),h),o=h.largestBatchId):l.done()}).next(()=>s)}lt(t,e){return Fr(t).put(function(i,s,o){let[a,u,c]=Od(s,o.mutation.key);return{userId:s,collectionPath:u,documentId:c,collectionGroup:o.mutation.key.getCollectionGroup(),largestBatchId:o.largestBatchId,overlayMutation:ii(i.ut,o.mutation)}}(this.serializer,this.userId,e))}};function Fr(n){return ft(n,"documentOverlays")}var oe=class{constructor(){}ht(t,e){this.Pt(t,e),e.It()}Pt(t,e){if("nullValue"in t)this.Tt(e,5);else if("booleanValue"in t)this.Tt(e,10),e.Et(t.booleanValue?1:0);else if("integerValue"in t)this.Tt(e,15),e.Et(Y(t.integerValue));else if("doubleValue"in t){let r=Y(t.doubleValue);isNaN(r)?this.Tt(e,13):(this.Tt(e,15),Qr(r)?e.Et(0):e.Et(r))}else if("timestampValue"in t){let r=t.timestampValue;this.Tt(e,20),typeof r=="string"&&(r=ue(r)),e.dt(`${r.seconds||""}`),e.Et(r.nanos||0)}else if("stringValue"in t)this.At(t.stringValue,e),this.Rt(e);else if("bytesValue"in t)this.Tt(e,30),e.Vt(Se(t.bytesValue)),this.Rt(e);else if("referenceValue"in t)this.ft(t.referenceValue,e);else if("geoPointValue"in t){let r=t.geoPointValue;this.Tt(e,45),e.Et(r.latitude||0),e.Et(r.longitude||0)}else"mapValue"in t?bf(t)?this.Tt(e,Number.MAX_SAFE_INTEGER):(this.gt(t.mapValue,e),this.Rt(e)):"arrayValue"in t?(this.yt(t.arrayValue,e),this.Rt(e)):S()}At(t,e){this.Tt(e,25),this.wt(t,e)}wt(t,e){e.dt(t)}gt(t,e){let r=t.fields||{};this.Tt(e,55);for(let i of Object.keys(r))this.At(i,e),this.Pt(r[i],e)}yt(t,e){let r=t.values||[];this.Tt(e,50);for(let i of r)this.Pt(i,e)}ft(t,e){this.Tt(e,37),I.fromName(t).path.forEach(r=>{this.Tt(e,60),this.wt(r,e)})}Tt(t,e){t.Et(e)}Rt(t){t.Et(2)}};oe.St=new oe;function L_(n){if(n===0)return 8;let t=0;return!(n>>4)&&(t+=4,n<<=4),!(n>>6)&&(t+=2,n<<=2),!(n>>7)&&(t+=1),t}function Gd(n){let t=64-function(r){let i=0;for(let s=0;s<8;++s){let o=L_(255&r[s]);if(i+=o,o!==8)break}return i}(n);return Math.ceil(t/8)}var uu=class{constructor(){this.buffer=new Uint8Array(1024),this.position=0}bt(t){let e=t[Symbol.iterator](),r=e.next();for(;!r.done;)this.Dt(r.value),r=e.next();this.Ct()}vt(t){let e=t[Symbol.iterator](),r=e.next();for(;!r.done;)this.Ft(r.value),r=e.next();this.Mt()}xt(t){for(let e of t){let r=e.charCodeAt(0);if(r<128)this.Dt(r);else if(r<2048)this.Dt(960|r>>>6),this.Dt(128|63&r);else if(e<"\uD800"||"\uDBFF"<e)this.Dt(480|r>>>12),this.Dt(128|63&r>>>6),this.Dt(128|63&r);else{let i=e.codePointAt(0);this.Dt(240|i>>>18),this.Dt(128|63&i>>>12),this.Dt(128|63&i>>>6),this.Dt(128|63&i)}}this.Ct()}Ot(t){for(let e of t){let r=e.charCodeAt(0);if(r<128)this.Ft(r);else if(r<2048)this.Ft(960|r>>>6),this.Ft(128|63&r);else if(e<"\uD800"||"\uDBFF"<e)this.Ft(480|r>>>12),this.Ft(128|63&r>>>6),this.Ft(128|63&r);else{let i=e.codePointAt(0);this.Ft(240|i>>>18),this.Ft(128|63&i>>>12),this.Ft(128|63&i>>>6),this.Ft(128|63&i)}}this.Mt()}Nt(t){let e=this.Lt(t),r=Gd(e);this.Bt(1+r),this.buffer[this.position++]=255&r;for(let i=e.length-r;i<e.length;++i)this.buffer[this.position++]=255&e[i]}kt(t){let e=this.Lt(t),r=Gd(e);this.Bt(1+r),this.buffer[this.position++]=~(255&r);for(let i=e.length-r;i<e.length;++i)this.buffer[this.position++]=~(255&e[i])}qt(){this.Qt(255),this.Qt(255)}Kt(){this.$t(255),this.$t(255)}reset(){this.position=0}seed(t){this.Bt(t.length),this.buffer.set(t,this.position),this.position+=t.length}Ut(){return this.buffer.slice(0,this.position)}Lt(t){let e=function(s){let o=new DataView(new ArrayBuffer(8));return o.setFloat64(0,s,!1),new Uint8Array(o.buffer)}(t),r=(128&e[0])!=0;e[0]^=r?255:128;for(let i=1;i<e.length;++i)e[i]^=r?255:0;return e}Dt(t){let e=255&t;e===0?(this.Qt(0),this.Qt(255)):e===255?(this.Qt(255),this.Qt(0)):this.Qt(e)}Ft(t){let e=255&t;e===0?(this.$t(0),this.$t(255)):e===255?(this.$t(255),this.$t(0)):this.$t(t)}Ct(){this.Qt(0),this.Qt(1)}Mt(){this.$t(0),this.$t(1)}Qt(t){this.Bt(1),this.buffer[this.position++]=t}$t(t){this.Bt(1),this.buffer[this.position++]=~t}Bt(t){let e=t+this.position;if(e<=this.buffer.length)return;let r=2*this.buffer.length;r<e&&(r=e);let i=new Uint8Array(r);i.set(this.buffer),this.buffer=i}},cu=class{constructor(t){this.Wt=t}Vt(t){this.Wt.bt(t)}dt(t){this.Wt.xt(t)}Et(t){this.Wt.Nt(t)}It(){this.Wt.qt()}},lu=class{constructor(t){this.Wt=t}Vt(t){this.Wt.vt(t)}dt(t){this.Wt.Ot(t)}Et(t){this.Wt.kt(t)}It(){this.Wt.Kt()}},Ke=class{constructor(){this.Wt=new uu,this.Gt=new cu(this.Wt),this.zt=new lu(this.Wt)}seed(t){this.Wt.seed(t)}jt(t){return t===0?this.Gt:this.zt}Ut(){return this.Wt.Ut()}reset(){this.Wt.reset()}};var $e=class n{constructor(t,e,r,i){this.indexId=t,this.documentKey=e,this.arrayValue=r,this.directionalValue=i}Ht(){let t=this.directionalValue.length,e=t===0||this.directionalValue[t-1]===255?t+1:t,r=new Uint8Array(e);return r.set(this.directionalValue,0),e!==t?r.set([0],this.directionalValue.length):++r[r.length-1],new n(this.indexId,this.documentKey,this.arrayValue,r)}};function _e(n,t){let e=n.indexId-t.indexId;return e!==0?e:(e=zd(n.arrayValue,t.arrayValue),e!==0?e:(e=zd(n.directionalValue,t.directionalValue),e!==0?e:I.comparator(n.documentKey,t.documentKey)))}function zd(n,t){for(let e=0;e<n.length&&e<t.length;++e){let r=n[e]-t[e];if(r!==0)return r}return n.length-t.length}var Ds=class{constructor(t){this.Jt=new z((e,r)=>tt.comparator(e.field,r.field)),this.collectionId=t.collectionGroup!=null?t.collectionGroup:t.path.lastSegment(),this.Yt=t.orderBy,this.Zt=[];for(let e of t.filters){let r=e;r.isInequality()?this.Jt=this.Jt.add(r):this.Zt.push(r)}}get Xt(){return this.Jt.size>1}en(t){if(R(t.collectionGroup===this.collectionId),this.Xt)return!1;let e=Va(t);if(e!==void 0&&!this.tn(e))return!1;let r=Ge(t),i=new Set,s=0,o=0;for(;s<r.length&&this.tn(r[s]);++s)i=i.add(r[s].fieldPath.canonicalString());if(s===r.length)return!0;if(this.Jt.size>0){let a=this.Jt.getIterator().getNext();if(!i.has(a.field.canonicalString())){let u=r[s];if(!this.nn(a,u)||!this.rn(this.Yt[o++],u))return!1}++s}for(;s<r.length;++s){let a=r[s];if(o>=this.Yt.length||!this.rn(this.Yt[o++],a))return!1}return!0}sn(){if(this.Xt)return null;let t=new z(tt.comparator),e=[];for(let r of this.Zt)if(!r.field.isKeyField())if(r.op==="array-contains"||r.op==="array-contains-any")e.push(new Vn(r.field,2));else{if(t.has(r.field))continue;t=t.add(r.field),e.push(new Vn(r.field,0))}for(let r of this.Yt)r.field.isKeyField()||t.has(r.field)||(t=t.add(r.field),e.push(new Vn(r.field,r.dir==="asc"?0:1)));return new Mn(Mn.UNKNOWN_ID,this.collectionId,e,$r.empty())}tn(t){for(let e of this.Zt)if(this.nn(e,t))return!0;return!1}nn(t,e){if(t===void 0||!t.field.isEqual(e.fieldPath))return!1;let r=t.op==="array-contains"||t.op==="array-contains-any";return e.kind===2===r}rn(t,e){return!!t.field.isEqual(e.fieldPath)&&(e.kind===0&&t.dir==="asc"||e.kind===1&&t.dir==="desc")}};function fm(n){var t,e;if(R(n instanceof k||n instanceof G),n instanceof k){if(n instanceof vs){let i=((e=(t=n.value.arrayValue)===null||t===void 0?void 0:t.values)===null||e===void 0?void 0:e.map(s=>k.create(n.field,"==",s)))||[];return G.create(i,"or")}return n}let r=n.filters.map(i=>fm(i));return G.create(r,n.op)}function O_(n){if(n.getFilters().length===0)return[];let t=fu(fm(n));return R(mm(t)),hu(t)||du(t)?[t]:t.getFilters()}function hu(n){return n instanceof k}function du(n){return n instanceof G&&Pc(n)}function mm(n){return hu(n)||du(n)||function(e){if(e instanceof G&&Ba(e)){for(let r of e.getFilters())if(!hu(r)&&!du(r))return!1;return!0}return!1}(n)}function fu(n){if(R(n instanceof k||n instanceof G),n instanceof k)return n;if(n.filters.length===1)return fu(n.filters[0]);let t=n.filters.map(r=>fu(r)),e=G.create(t,n.op);return e=Cs(e),mm(e)?e:(R(e instanceof G),R(On(e)),R(e.filters.length>1),e.filters.reduce((r,i)=>Vc(r,i)))}function Vc(n,t){let e;return R(n instanceof k||n instanceof G),R(t instanceof k||t instanceof G),e=n instanceof k?t instanceof k?function(i,s){return G.create([i,s],"and")}(n,t):jd(n,t):t instanceof k?jd(t,n):function(i,s){if(R(i.filters.length>0&&s.filters.length>0),On(i)&&On(s))return Vf(i,s.getFilters());let o=Ba(i)?i:s,a=Ba(i)?s:i,u=o.filters.map(c=>Vc(c,a));return G.create(u,"or")}(n,t),Cs(e)}function jd(n,t){if(On(t))return Vf(t,n.getFilters());{let e=t.filters.map(r=>Vc(n,r));return G.create(e,"or")}}function Cs(n){if(R(n instanceof k||n instanceof G),n instanceof k)return n;let t=n.getFilters();if(t.length===1)return Cs(t[0]);if(Df(n))return n;let e=t.map(i=>Cs(i)),r=[];return e.forEach(i=>{i instanceof k?r.push(i):i instanceof G&&(i.op===n.op?r.push(...i.filters):r.push(i))}),r.length===1?r[0]:G.create(r,n.op)}var mu=class{constructor(){this.on=new si}addToCollectionParentIndex(t,e){return this.on.add(e),f.resolve()}getCollectionParents(t,e){return f.resolve(this.on.getEntries(e))}addFieldIndex(t,e){return f.resolve()}deleteFieldIndex(t,e){return f.resolve()}deleteAllFieldIndexes(t){return f.resolve()}createTargetIndexes(t,e){return f.resolve()}getDocumentsMatchingTarget(t,e){return f.resolve(null)}getIndexType(t,e){return f.resolve(0)}getFieldIndexes(t,e){return f.resolve([])}getNextCollectionGroupToUpdate(t){return f.resolve(null)}getMinOffset(t,e){return f.resolve(kt.min())}getMinOffsetFromCollectionGroup(t,e){return f.resolve(kt.min())}updateCollectionGroup(t,e,r){return f.resolve()}updateIndexEntries(t,e){return f.resolve()}},si=class{constructor(){this.index={}}add(t){let e=t.lastSegment(),r=t.popLast(),i=this.index[e]||new z(M.comparator),s=!i.has(r);return this.index[e]=i.add(r),s}has(t){let e=t.lastSegment(),r=t.popLast(),i=this.index[e];return i&&i.has(r)}getEntries(t){return(this.index[t]||new z(M.comparator)).toArray()}};var ns=new Uint8Array(0),gu=class{constructor(t,e){this.databaseId=e,this._n=new si,this.an=new te(r=>Xe(r),(r,i)=>gi(r,i)),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this._n.has(e)){let r=e.lastSegment(),i=e.popLast();t.addOnCommittedListener(()=>{this._n.add(e)});let s={collectionId:r,parent:Et(i)};return Kd(t).put(s)}return f.resolve()}getCollectionParents(t,e){let r=[],i=IDBKeyRange.bound([e,""],[gf(e),""],!1,!0);return Kd(t).U(i).next(s=>{for(let o of s){if(o.collectionId!==e)break;r.push(Qt(o.parent))}return r})}addFieldIndex(t,e){let r=Mr(t),i=function(a){return{indexId:a.indexId,collectionGroup:a.collectionGroup,fields:a.fields.map(u=>[u.fieldPath.canonicalString(),u.kind])}}(e);delete i.indexId;let s=r.add(i);if(e.indexState){let o=An(t);return s.next(a=>{o.put(qd(a,this.uid,e.indexState.sequenceNumber,e.indexState.offset))})}return s.next()}deleteFieldIndex(t,e){let r=Mr(t),i=An(t),s=Tn(t);return r.delete(e.indexId).next(()=>i.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))}deleteAllFieldIndexes(t){let e=Mr(t),r=Tn(t),i=An(t);return e.j().next(()=>r.j()).next(()=>i.j())}createTargetIndexes(t,e){return f.forEach(this.un(e),r=>this.getIndexType(t,r).next(i=>{if(i===0||i===1){let s=new Ds(r).sn();if(s!=null)return this.addFieldIndex(t,s)}}))}getDocumentsMatchingTarget(t,e){let r=Tn(t),i=!0,s=new Map;return f.forEach(this.un(e),o=>this.cn(t,o).next(a=>{i&&(i=!!a),s.set(o,a)})).next(()=>{if(i){let o=V(),a=[];return f.forEach(s,(u,c)=>{y("IndexedDbIndexManager",`Using index ${function(x){return`id=${x.indexId}|cg=${x.collectionGroup}|f=${x.fields.map(q=>`${q.fieldPath}:${q.kind}`).join(",")}`}(u)} to execute ${Xe(e)}`);let l=function(x,q){let B=Va(q);if(B===void 0)return null;for(let O of Es(x,B.fieldPath))switch(O.op){case"array-contains-any":return O.value.arrayValue.values||[];case"array-contains":return[O.value]}return null}(c,u),h=function(x,q){let B=new Map;for(let O of Ge(q))for(let nt of Es(x,O.fieldPath))switch(nt.op){case"==":case"in":B.set(O.fieldPath.canonicalString(),nt.value);break;case"not-in":case"!=":return B.set(O.fieldPath.canonicalString(),nt.value),Array.from(B.values())}return null}(c,u),d=function(x,q){let B=[],O=!0;for(let nt of Ge(q)){let Gt=nt.kind===0?Ad(x,nt.fieldPath,x.startAt):Sd(x,nt.fieldPath,x.startAt);B.push(Gt.value),O&&(O=Gt.inclusive)}return new Zt(B,O)}(c,u),m=function(x,q){let B=[],O=!0;for(let nt of Ge(q)){let Gt=nt.kind===0?Sd(x,nt.fieldPath,x.endAt):Ad(x,nt.fieldPath,x.endAt);B.push(Gt.value),O&&(O=Gt.inclusive)}return new Zt(B,O)}(c,u),A=this.ln(u,c,d),w=this.ln(u,c,m),v=this.hn(u,c,h),b=this.Pn(u.indexId,l,A,d.inclusive,w,m.inclusive,v);return f.forEach(b,N=>r.G(N,e.limit).next(x=>{x.forEach(q=>{let B=I.fromSegments(q.documentKey);o.has(B)||(o=o.add(B),a.push(B))})}))}).next(()=>a)}return f.resolve(null)})}un(t){let e=this.an.get(t);return e||(t.filters.length===0?e=[t]:e=O_(G.create(t.filters,"and")).map(r=>Ha(t.path,t.collectionGroup,t.orderBy,r.getFilters(),t.limit,t.startAt,t.endAt)),this.an.set(t,e),e)}Pn(t,e,r,i,s,o,a){let u=(e!=null?e.length:1)*Math.max(r.length,s.length),c=u/(e!=null?e.length:1),l=[];for(let h=0;h<u;++h){let d=e?this.In(e[h/c]):ns,m=this.Tn(t,d,r[h%c],i),A=this.En(t,d,s[h%c],o),w=a.map(v=>this.Tn(t,d,v,!0));l.push(...this.createRange(m,A,w))}return l}Tn(t,e,r,i){let s=new $e(t,I.empty(),e,r);return i?s:s.Ht()}En(t,e,r,i){let s=new $e(t,I.empty(),e,r);return i?s.Ht():s}cn(t,e){let r=new Ds(e),i=e.collectionGroup!=null?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,i).next(s=>{let o=null;for(let a of s)r.en(a)&&(!o||a.fields.length>o.fields.length)&&(o=a);return o})}getIndexType(t,e){let r=2,i=this.un(e);return f.forEach(i,s=>this.cn(t,s).next(o=>{o?r!==0&&o.fields.length<function(u){let c=new z(tt.comparator),l=!1;for(let h of u.filters)for(let d of h.getFlattenedFilters())d.field.isKeyField()||(d.op==="array-contains"||d.op==="array-contains-any"?l=!0:c=c.add(d.field));for(let h of u.orderBy)h.field.isKeyField()||(c=c.add(h.field));return c.size+(l?1:0)}(s)&&(r=1):r=0})).next(()=>function(o){return o.limit!==null}(e)&&i.length>1&&r===2?1:r)}dn(t,e){let r=new Ke;for(let i of Ge(t)){let s=e.data.field(i.fieldPath);if(s==null)return null;let o=r.jt(i.kind);oe.St.ht(s,o)}return r.Ut()}In(t){let e=new Ke;return oe.St.ht(t,e.jt(0)),e.Ut()}An(t,e){let r=new Ke;return oe.St.ht(Je(this.databaseId,e),r.jt(function(s){let o=Ge(s);return o.length===0?0:o[o.length-1].kind}(t))),r.Ut()}hn(t,e,r){if(r===null)return[];let i=[];i.push(new Ke);let s=0;for(let o of Ge(t)){let a=r[s++];for(let u of i)if(this.Rn(e,o.fieldPath)&&Yr(a))i=this.Vn(i,o,a);else{let c=u.jt(o.kind);oe.St.ht(a,c)}}return this.mn(i)}ln(t,e,r){return this.hn(t,e,r.position)}mn(t){let e=[];for(let r=0;r<t.length;++r)e[r]=t[r].Ut();return e}Vn(t,e,r){let i=[...t],s=[];for(let o of r.arrayValue.values||[])for(let a of i){let u=new Ke;u.seed(a.Ut()),oe.St.ht(o,u.jt(e.kind)),s.push(u)}return s}Rn(t,e){return!!t.filters.find(r=>r instanceof k&&r.field.isEqual(e)&&(r.op==="in"||r.op==="not-in"))}getFieldIndexes(t,e){let r=Mr(t),i=An(t);return(e?r.U("collectionGroupIndex",IDBKeyRange.bound(e,e)):r.U()).next(s=>{let o=[];return f.forEach(s,a=>i.get([a.indexId,this.uid]).next(u=>{o.push(function(l,h){let d=h?new $r(h.sequenceNumber,new kt(en(h.readTime),new I(Qt(h.documentKey)),h.largestBatchId)):$r.empty(),m=l.fields.map(([A,w])=>new Vn(tt.fromServerFormat(A),w));return new Mn(l.indexId,l.collectionGroup,m,d)}(a,u))})).next(()=>o)})}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next(e=>e.length===0?null:(e.sort((r,i)=>{let s=r.indexState.sequenceNumber-i.indexState.sequenceNumber;return s!==0?s:C(r.collectionGroup,i.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(t,e,r){let i=Mr(t),s=An(t);return this.fn(t).next(o=>i.U("collectionGroupIndex",IDBKeyRange.bound(e,e)).next(a=>f.forEach(a,u=>s.put(qd(u.indexId,this.uid,o,r)))))}updateIndexEntries(t,e){let r=new Map;return f.forEach(e,(i,s)=>{let o=r.get(i.collectionGroup);return(o?f.resolve(o):this.getFieldIndexes(t,i.collectionGroup)).next(a=>(r.set(i.collectionGroup,a),f.forEach(a,u=>this.gn(t,i,u).next(c=>{let l=this.pn(s,u);return c.isEqual(l)?f.resolve():this.yn(t,s,u,c,l)}))))})}wn(t,e,r,i){return Tn(t).put({indexId:i.indexId,uid:this.uid,arrayValue:i.arrayValue,directionalValue:i.directionalValue,orderedDocumentKey:this.An(r,e.key),documentKey:e.key.path.toArray()})}Sn(t,e,r,i){return Tn(t).delete([i.indexId,this.uid,i.arrayValue,i.directionalValue,this.An(r,e.key),e.key.path.toArray()])}gn(t,e,r){let i=Tn(t),s=new z(_e);return i.J({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.An(r,e)])},(o,a)=>{s=s.add(new $e(r.indexId,e,a.arrayValue,a.directionalValue))}).next(()=>s)}pn(t,e){let r=new z(_e),i=this.dn(e,t);if(i==null)return r;let s=Va(e);if(s!=null){let o=t.data.field(s.fieldPath);if(Yr(o))for(let a of o.arrayValue.values||[])r=r.add(new $e(e.indexId,t.key,this.In(a),i))}else r=r.add(new $e(e.indexId,t.key,ns,i));return r}yn(t,e,r,i,s){y("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);let o=[];return function(u,c,l,h,d){let m=u.getIterator(),A=c.getIterator(),w=En(m),v=En(A);for(;w||v;){let b=!1,N=!1;if(w&&v){let x=l(w,v);x<0?N=!0:x>0&&(b=!0)}else w!=null?N=!0:b=!0;b?(h(v),v=En(A)):N?(d(w),w=En(m)):(w=En(m),v=En(A))}}(i,s,_e,a=>{o.push(this.wn(t,e,r,a))},a=>{o.push(this.Sn(t,e,r,a))}),f.waitFor(o)}fn(t){let e=1;return An(t).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(r,i,s)=>{s.done(),e=i.sequenceNumber+1}).next(()=>e)}createRange(t,e,r){r=r.sort((o,a)=>_e(o,a)).filter((o,a,u)=>!a||_e(o,u[a-1])!==0);let i=[];i.push(t);for(let o of r){let a=_e(o,t),u=_e(o,e);if(a===0)i[0]=t.Ht();else if(a>0&&u<0)i.push(o),i.push(o.Ht());else if(u>0)break}i.push(e);let s=[];for(let o=0;o<i.length;o+=2){if(this.bn(i[o],i[o+1]))return[];let a=[i[o].indexId,this.uid,i[o].arrayValue,i[o].directionalValue,ns,[]],u=[i[o+1].indexId,this.uid,i[o+1].arrayValue,i[o+1].directionalValue,ns,[]];s.push(IDBKeyRange.bound(a,u))}return s}bn(t,e){return _e(t,e)>0}getMinOffsetFromCollectionGroup(t,e){return this.getFieldIndexes(t,e).next($d)}getMinOffset(t,e){return f.mapArray(this.un(e),r=>this.cn(t,r).next(i=>i||S())).next($d)}};function Kd(n){return ft(n,"collectionParents")}function Tn(n){return ft(n,"indexEntries")}function Mr(n){return ft(n,"indexConfiguration")}function An(n){return ft(n,"indexState")}function $d(n){R(n.length!==0);let t=n[0].indexState.offset,e=t.largestBatchId;for(let r=1;r<n.length;r++){let i=n[r].indexState.offset;Ac(i,t)<0&&(t=i),e<i.largestBatchId&&(e=i.largestBatchId)}return new kt(t.readTime,t.documentKey,e)}var Qd={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Vt=class n{constructor(t,e,r){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=r}static withCacheSize(t){return new n(t,n.DEFAULT_COLLECTION_PERCENTILE,n.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}};function gm(n,t,e){let r=n.store("mutations"),i=n.store("documentMutations"),s=[],o=IDBKeyRange.only(e.batchId),a=0,u=r.J({range:o},(l,h,d)=>(a++,d.delete()));s.push(u.next(()=>{R(a===1)}));let c=[];for(let l of e.mutations){let h=If(t,l.key.path,e.batchId);s.push(i.delete(h)),c.push(l.key)}return f.waitFor(s).next(()=>c)}function Vs(n){if(!n)return 0;let t;if(n.document)t=n.document;else if(n.unknownDocument)t=n.unknownDocument;else{if(!n.noDocument)throw S();t=n.noDocument}return JSON.stringify(t).length}Vt.DEFAULT_COLLECTION_PERCENTILE=10,Vt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Vt.DEFAULT=new Vt(41943040,Vt.DEFAULT_COLLECTION_PERCENTILE,Vt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Vt.DISABLED=new Vt(-1,0,0);var Ns=class n{constructor(t,e,r,i){this.userId=t,this.serializer=e,this.indexManager=r,this.referenceDelegate=i,this.Dn={}}static ct(t,e,r,i){R(t.uid!=="");let s=t.isAuthenticated()?t.uid:"";return new n(s,e,r,i)}checkEmpty(t){let e=!0,r=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return ye(t).J({index:"userMutationsIndex",range:r},(i,s,o)=>{e=!1,o.done()}).next(()=>e)}addMutationBatch(t,e,r,i){let s=Dn(t),o=ye(t);return o.add({}).next(a=>{R(typeof a=="number");let u=new Zr(a,e,r,i),c=function(m,A,w){let v=w.baseMutations.map(N=>ii(m.ut,N)),b=w.mutations.map(N=>ii(m.ut,N));return{userId:A,batchId:w.batchId,localWriteTimeMs:w.localWriteTime.toMillis(),baseMutations:v,mutations:b}}(this.serializer,this.userId,u),l=[],h=new z((d,m)=>C(d.canonicalString(),m.canonicalString()));for(let d of i){let m=If(this.userId,d.key.path,a);h=h.add(d.key.path.popLast()),l.push(o.put(c)),l.push(s.put(m,Kp))}return h.forEach(d=>{l.push(this.indexManager.addToCollectionParentIndex(t,d))}),t.addOnCommittedListener(()=>{this.Dn[a]=u.keys()}),f.waitFor(l).next(()=>u)})}lookupMutationBatch(t,e){return ye(t).get(e).next(r=>r?(R(r.userId===this.userId),je(this.serializer,r)):null)}Cn(t,e){return this.Dn[e]?f.resolve(this.Dn[e]):this.lookupMutationBatch(t,e).next(r=>{if(r){let i=r.keys();return this.Dn[e]=i,i}return null})}getNextMutationBatchAfterBatchId(t,e){let r=e+1,i=IDBKeyRange.lowerBound([this.userId,r]),s=null;return ye(t).J({index:"userMutationsIndex",range:i},(o,a,u)=>{a.userId===this.userId&&(R(a.batchId>=r),s=je(this.serializer,a)),u.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(t){let e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),r=-1;return ye(t).J({index:"userMutationsIndex",range:e,reverse:!0},(i,s,o)=>{r=s.batchId,o.done()}).next(()=>r)}getAllMutationBatches(t){let e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return ye(t).U("userMutationsIndex",e).next(r=>r.map(i=>je(this.serializer,i)))}getAllMutationBatchesAffectingDocumentKey(t,e){let r=os(this.userId,e.path),i=IDBKeyRange.lowerBound(r),s=[];return Dn(t).J({range:i},(o,a,u)=>{let[c,l,h]=o,d=Qt(l);if(c===this.userId&&e.path.isEqual(d))return ye(t).get(h).next(m=>{if(!m)throw S();R(m.userId===this.userId),s.push(je(this.serializer,m))});u.done()}).next(()=>s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let r=new z(C),i=[];return e.forEach(s=>{let o=os(this.userId,s.path),a=IDBKeyRange.lowerBound(o),u=Dn(t).J({range:a},(c,l,h)=>{let[d,m,A]=c,w=Qt(m);d===this.userId&&s.path.isEqual(w)?r=r.add(A):h.done()});i.push(u)}),f.waitFor(i).next(()=>this.vn(t,r))}getAllMutationBatchesAffectingQuery(t,e){let r=e.path,i=r.length+1,s=os(this.userId,r),o=IDBKeyRange.lowerBound(s),a=new z(C);return Dn(t).J({range:o},(u,c,l)=>{let[h,d,m]=u,A=Qt(d);h===this.userId&&r.isPrefixOf(A)?A.length===i&&(a=a.add(m)):l.done()}).next(()=>this.vn(t,a))}vn(t,e){let r=[],i=[];return e.forEach(s=>{i.push(ye(t).get(s).next(o=>{if(o===null)throw S();R(o.userId===this.userId),r.push(je(this.serializer,o))}))}),f.waitFor(i).next(()=>r)}removeMutationBatch(t,e){return gm(t._e,this.userId,e).next(r=>(t.addOnCommittedListener(()=>{this.Fn(e.batchId)}),f.forEach(r,i=>this.referenceDelegate.markPotentiallyOrphaned(t,i))))}Fn(t){delete this.Dn[t]}performConsistencyCheck(t){return this.checkEmpty(t).next(e=>{if(!e)return f.resolve();let r=IDBKeyRange.lowerBound(function(o){return[o]}(this.userId)),i=[];return Dn(t).J({range:r},(s,o,a)=>{if(s[0]===this.userId){let u=Qt(s[1]);i.push(u)}else a.done()}).next(()=>{R(i.length===0)})})}containsKey(t,e){return pm(t,this.userId,e)}Mn(t){return _m(t).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}};function pm(n,t,e){let r=os(t,e.path),i=r[1],s=IDBKeyRange.lowerBound(r),o=!1;return Dn(n).J({range:s,H:!0},(a,u,c)=>{let[l,h,d]=a;l===t&&h===i&&(o=!0),c.done()}).next(()=>o)}function ye(n){return ft(n,"mutations")}function Dn(n){return ft(n,"documentMutations")}function _m(n){return ft(n,"mutationQueues")}var zn=class n{constructor(t){this.xn=t}next(){return this.xn+=2,this.xn}static On(){return new n(0)}static Nn(){return new n(-1)}};var pu=class{constructor(t,e){this.referenceDelegate=t,this.serializer=e}allocateTargetId(t){return this.Ln(t).next(e=>{let r=new zn(e.highestTargetId);return e.highestTargetId=r.next(),this.Bn(t,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(t){return this.Ln(t).next(e=>P.fromTimestamp(new W(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(t){return this.Ln(t).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,e,r){return this.Ln(t).next(i=>(i.highestListenSequenceNumber=e,r&&(i.lastRemoteSnapshotVersion=r.toTimestamp()),e>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=e),this.Bn(t,i)))}addTargetData(t,e){return this.kn(t,e).next(()=>this.Ln(t).next(r=>(r.targetCount+=1,this.qn(e,r),this.Bn(t,r))))}updateTargetData(t,e){return this.kn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>Sn(t).delete(e.targetId)).next(()=>this.Ln(t)).next(r=>(R(r.targetCount>0),r.targetCount-=1,this.Bn(t,r)))}removeTargets(t,e,r){let i=0,s=[];return Sn(t).J((o,a)=>{let u=Br(a);u.sequenceNumber<=e&&r.get(u.targetId)===null&&(i++,s.push(this.removeTargetData(t,u)))}).next(()=>f.waitFor(s)).next(()=>i)}forEachTarget(t,e){return Sn(t).J((r,i)=>{let s=Br(i);e(s)})}Ln(t){return Wd(t).get("targetGlobalKey").next(e=>(R(e!==null),e))}Bn(t,e){return Wd(t).put("targetGlobalKey",e)}kn(t,e){return Sn(t).put(dm(this.serializer,e))}qn(t,e){let r=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,r=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,r=!0),r}getTargetCount(t){return this.Ln(t).next(e=>e.targetCount)}getTargetData(t,e){let r=Xe(e),i=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),s=null;return Sn(t).J({range:i,index:"queryTargetsIndex"},(o,a,u)=>{let c=Br(a);gi(e,c.target)&&(s=c,u.done())}).next(()=>s)}addMatchingKeys(t,e,r){let i=[],s=we(t);return e.forEach(o=>{let a=Et(o.path);i.push(s.put({targetId:r,path:a})),i.push(this.referenceDelegate.addReference(t,r,o))}),f.waitFor(i)}removeMatchingKeys(t,e,r){let i=we(t);return f.forEach(e,s=>{let o=Et(s.path);return f.waitFor([i.delete([r,o]),this.referenceDelegate.removeReference(t,r,s)])})}removeMatchingKeysForTargetId(t,e){let r=we(t),i=IDBKeyRange.bound([e],[e+1],!1,!0);return r.delete(i)}getMatchingKeysForTargetId(t,e){let r=IDBKeyRange.bound([e],[e+1],!1,!0),i=we(t),s=V();return i.J({range:r,H:!0},(o,a,u)=>{let c=Qt(o[1]),l=new I(c);s=s.add(l)}).next(()=>s)}containsKey(t,e){let r=Et(e.path),i=IDBKeyRange.bound([r],[gf(r)],!1,!0),s=0;return we(t).J({index:"documentTargetsIndex",H:!0,range:i},([o,a],u,c)=>{o!==0&&(s++,c.done())}).next(()=>s>0)}ot(t,e){return Sn(t).get(e).next(r=>r?Br(r):null)}};function Sn(n){return ft(n,"targets")}function Wd(n){return ft(n,"targetGlobal")}function we(n){return ft(n,"targetDocuments")}function Hd([n,t],[e,r]){let i=C(n,e);return i===0?C(t,r):i}var _u=class{constructor(t){this.Qn=t,this.buffer=new z(Hd),this.Kn=0}$n(){return++this.Kn}Un(t){let e=[t,this.$n()];if(this.buffer.size<this.Qn)this.buffer=this.buffer.add(e);else{let r=this.buffer.last();Hd(e,r)<0&&(this.buffer=this.buffer.delete(r).add(e))}}get maxValue(){return this.buffer.last()[0]}},yu=class{constructor(t,e,r){this.garbageCollector=t,this.asyncQueue=e,this.localStore=r,this.Wn=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.Gn(6e4)}stop(){this.Wn&&(this.Wn.cancel(),this.Wn=null)}get started(){return this.Wn!==null}Gn(t){y("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.Wn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,()=>p(this,null,function*(){this.Wn=null;try{yield this.localStore.collectGarbage(this.garbageCollector)}catch(e){ke(e)?y("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):yield Ne(e)}yield this.Gn(3e5)}))}},wu=class{constructor(t,e){this.zn=t,this.params=e}calculateTargetCount(t,e){return this.zn.jn(t).next(r=>Math.floor(e/100*r))}nthSequenceNumber(t,e){if(e===0)return f.resolve(bt.oe);let r=new _u(e);return this.zn.forEachTarget(t,i=>r.Un(i.sequenceNumber)).next(()=>this.zn.Hn(t,i=>r.Un(i))).next(()=>r.maxValue)}removeTargets(t,e,r){return this.zn.removeTargets(t,e,r)}removeOrphanedDocuments(t,e){return this.zn.removeOrphanedDocuments(t,e)}collect(t,e){return this.params.cacheSizeCollectionThreshold===-1?(y("LruGarbageCollector","Garbage collection skipped; disabled"),f.resolve(Qd)):this.getCacheSize(t).next(r=>r<this.params.cacheSizeCollectionThreshold?(y("LruGarbageCollector",`Garbage collection skipped; Cache size ${r} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Qd):this.Jn(t,e))}getCacheSize(t){return this.zn.getCacheSize(t)}Jn(t,e){let r,i,s,o,a,u,c,l=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(h=>(h>this.params.maximumSequenceNumbersToCollect?(y("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${h}`),i=this.params.maximumSequenceNumbersToCollect):i=h,o=Date.now(),this.nthSequenceNumber(t,i))).next(h=>(r=h,a=Date.now(),this.removeTargets(t,r,e))).next(h=>(s=h,u=Date.now(),this.removeOrphanedDocuments(t,r))).next(h=>(c=Date.now(),Rn()<=zt.DEBUG&&y("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${o-l}ms
	Determined least recently used ${i} in `+(a-o)+`ms
	Removed ${s} targets in `+(u-a)+`ms
	Removed ${h} documents in `+(c-u)+`ms
Total Duration: ${c-l}ms`),f.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:h})))}};function q_(n,t){return new wu(n,t)}var vu=class{constructor(t,e){this.db=t,this.garbageCollector=q_(this,e)}jn(t){let e=this.Yn(t);return this.db.getTargetCache().getTargetCount(t).next(r=>e.next(i=>r+i))}Yn(t){let e=0;return this.Hn(t,r=>{e++}).next(()=>e)}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}Hn(t,e){return this.Zn(t,(r,i)=>e(i))}addReference(t,e,r){return rs(t,r)}removeReference(t,e,r){return rs(t,r)}removeTargets(t,e,r){return this.db.getTargetCache().removeTargets(t,e,r)}markPotentiallyOrphaned(t,e){return rs(t,e)}Xn(t,e){return function(i,s){let o=!1;return _m(i).Y(a=>pm(i,a,s).next(u=>(u&&(o=!0),f.resolve(!u)))).next(()=>o)}(t,e)}removeOrphanedDocuments(t,e){let r=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[],s=0;return this.Zn(t,(o,a)=>{if(a<=e){let u=this.Xn(t,o).next(c=>{if(!c)return s++,r.getEntry(t,o).next(()=>(r.removeEntry(o,P.min()),we(t).delete(function(h){return[0,Et(h.path)]}(o))))});i.push(u)}}).next(()=>f.waitFor(i)).next(()=>r.apply(t)).next(()=>s)}removeTarget(t,e){let r=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,r)}updateLimboDocument(t,e){return rs(t,e)}Zn(t,e){let r=we(t),i,s=bt.oe;return r.J({index:"documentTargetsIndex"},([o,a],{path:u,sequenceNumber:c})=>{o===0?(s!==bt.oe&&e(new I(Qt(i)),s),s=c,i=u):s=bt.oe}).next(()=>{s!==bt.oe&&e(new I(Qt(i)),s)})}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}};function rs(n,t){return we(n).put(function(r,i){return{targetId:0,path:Et(r.path),sequenceNumber:i}}(t,n.currentSequenceNumber))}var ks=class{constructor(){this.changes=new te(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,ut.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();let r=this.changes.get(e);return r!==void 0?f.resolve(r):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}};var Iu=class{constructor(t){this.serializer=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,r){return Ue(t).put(r)}removeEntry(t,e,r){return Ue(t).delete(function(s,o){let a=s.path.toArray();return[a.slice(0,a.length-2),a[a.length-2],bs(o),a[a.length-1]]}(e,r))}updateMetadata(t,e){return this.getMetadata(t).next(r=>(r.byteSize+=e,this.er(t,r)))}getEntry(t,e){let r=ut.newInvalidDocument(e);return Ue(t).J({index:"documentKeyIndex",range:IDBKeyRange.only(Lr(e))},(i,s)=>{r=this.tr(e,s)}).next(()=>r)}nr(t,e){let r={size:0,document:ut.newInvalidDocument(e)};return Ue(t).J({index:"documentKeyIndex",range:IDBKeyRange.only(Lr(e))},(i,s)=>{r={document:this.tr(e,s),size:Vs(s)}}).next(()=>r)}getEntries(t,e){let r=St();return this.rr(t,e,(i,s)=>{let o=this.tr(i,s);r=r.insert(i,o)}).next(()=>r)}ir(t,e){let r=St(),i=new $(I.comparator);return this.rr(t,e,(s,o)=>{let a=this.tr(s,o);r=r.insert(s,a),i=i.insert(s,Vs(o))}).next(()=>({documents:r,sr:i}))}rr(t,e,r){if(e.isEmpty())return f.resolve();let i=new z(Xd);e.forEach(u=>i=i.add(u));let s=IDBKeyRange.bound(Lr(i.first()),Lr(i.last())),o=i.getIterator(),a=o.getNext();return Ue(t).J({index:"documentKeyIndex",range:s},(u,c,l)=>{let h=I.fromSegments([...c.prefixPath,c.collectionGroup,c.documentId]);for(;a&&Xd(a,h)<0;)r(a,null),a=o.getNext();a&&a.isEqual(h)&&(r(a,c),a=o.hasNext()?o.getNext():null),a?l.$(Lr(a)):l.done()}).next(()=>{for(;a;)r(a,null),a=o.hasNext()?o.getNext():null})}getDocumentsMatchingQuery(t,e,r,i,s){let o=e.path,a=[o.popLast().toArray(),o.lastSegment(),bs(r.readTime),r.documentKey.path.isEmpty()?"":r.documentKey.path.lastSegment()],u=[o.popLast().toArray(),o.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Ue(t).U(IDBKeyRange.bound(a,u,!0)).next(c=>{s?.incrementDocumentReadCount(c.length);let l=St();for(let h of c){let d=this.tr(I.fromSegments(h.prefixPath.concat(h.collectionGroup,h.documentId)),h);d.isFoundDocument()&&(_i(e,d)||i.has(d.key))&&(l=l.insert(d.key,d))}return l})}getAllFromCollectionGroup(t,e,r,i){let s=St(),o=Yd(e,r),a=Yd(e,kt.max());return Ue(t).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(o,a,!0)},(u,c,l)=>{let h=this.tr(I.fromSegments(c.prefixPath.concat(c.collectionGroup,c.documentId)),c);s=s.insert(h.key,h),s.size===i&&l.done()}).next(()=>s)}newChangeBuffer(t){return new Eu(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next(e=>e.byteSize)}getMetadata(t){return Jd(t).get("remoteDocumentGlobalKey").next(e=>(R(!!e),e))}er(t,e){return Jd(t).put("remoteDocumentGlobalKey",e)}tr(t,e){if(e){let r=M_(this.serializer,e);if(!(r.isNoDocument()&&r.version.isEqual(P.min())))return r}return ut.newInvalidDocument(t)}};function ym(n){return new Iu(n)}var Eu=class extends ks{constructor(t,e){super(),this._r=t,this.trackRemovals=e,this.ar=new te(r=>r.toString(),(r,i)=>r.isEqual(i))}applyChanges(t){let e=[],r=0,i=new z((s,o)=>C(s.canonicalString(),o.canonicalString()));return this.changes.forEach((s,o)=>{let a=this.ar.get(s);if(e.push(this._r.removeEntry(t,s,a.readTime)),o.isValidDocument()){let u=Ld(this._r.serializer,o);i=i.add(s.path.popLast());let c=Vs(u);r+=c-a.size,e.push(this._r.addEntry(t,s,u))}else if(r-=a.size,this.trackRemovals){let u=Ld(this._r.serializer,o.convertToNoDocument(P.min()));e.push(this._r.addEntry(t,s,u))}}),i.forEach(s=>{e.push(this._r.indexManager.addToCollectionParentIndex(t,s))}),e.push(this._r.updateMetadata(t,r)),f.waitFor(e)}getFromCache(t,e){return this._r.nr(t,e).next(r=>(this.ar.set(e,{size:r.size,readTime:r.document.readTime}),r.document))}getAllFromCache(t,e){return this._r.ir(t,e).next(({documents:r,sr:i})=>(i.forEach((s,o)=>{this.ar.set(s,{size:o,readTime:r.get(s).readTime})}),r))}};function Jd(n){return ft(n,"remoteDocumentGlobal")}function Ue(n){return ft(n,"remoteDocumentsV14")}function Lr(n){let t=n.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function Yd(n,t){let e=t.documentKey.path.toArray();return[n,bs(t.readTime),e.slice(0,e.length-2),e.length>0?e[e.length-1]:""]}function Xd(n,t){let e=n.path.toArray(),r=t.path.toArray(),i=0;for(let s=0;s<e.length-2&&s<r.length-2;++s)if(i=C(e[s],r[s]),i)return i;return i=C(e.length,r.length),i||(i=C(e[e.length-2],r[r.length-2]),i||C(e[e.length-1],r[r.length-1]))}var Tu=class{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}};var Fs=class{constructor(t,e,r,i){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=r,this.indexManager=i}getDocument(t,e){let r=null;return this.documentOverlayCache.getOverlay(t,e).next(i=>(r=i,this.remoteDocumentCache.getEntry(t,e))).next(i=>(r!==null&&zr(r.mutation,i,xt.empty(),W.now()),i))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(r=>this.getLocalViewOfDocuments(t,r,V()).next(()=>r))}getLocalViewOfDocuments(t,e,r=V()){let i=Wt();return this.populateOverlays(t,i,e).next(()=>this.computeViews(t,e,i,r).next(s=>{let o=qr();return s.forEach((a,u)=>{o=o.insert(a,u.overlayedDocument)}),o}))}getOverlayedDocuments(t,e){let r=Wt();return this.populateOverlays(t,r,e).next(()=>this.computeViews(t,e,r,V()))}populateOverlays(t,e,r){let i=[];return r.forEach(s=>{e.has(s)||i.push(s)}),this.documentOverlayCache.getOverlays(t,i).next(s=>{s.forEach((o,a)=>{e.set(o,a)})})}computeViews(t,e,r,i){let s=St(),o=Gr(),a=function(){return Gr()}();return e.forEach((u,c)=>{let l=r.get(c.key);i.has(c.key)&&(l===void 0||l.mutation instanceof qt)?s=s.insert(c.key,c):l!==void 0?(o.set(c.key,l.mutation.getFieldMask()),zr(l.mutation,c,l.mutation.getFieldMask(),W.now())):o.set(c.key,xt.empty())}),this.recalculateAndSaveOverlays(t,s).next(u=>(u.forEach((c,l)=>o.set(c,l)),e.forEach((c,l)=>{var h;return a.set(c,new Tu(l,(h=o.get(c))!==null&&h!==void 0?h:null))}),a))}recalculateAndSaveOverlays(t,e){let r=Gr(),i=new $((o,a)=>o-a),s=V();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next(o=>{for(let a of o)a.keys().forEach(u=>{let c=e.get(u);if(c===null)return;let l=r.get(u)||xt.empty();l=a.applyToLocalView(c,l),r.set(u,l);let h=(i.get(a.batchId)||V()).add(u);i=i.insert(a.batchId,h)})}).next(()=>{let o=[],a=i.getReverseIterator();for(;a.hasNext();){let u=a.getNext(),c=u.key,l=u.value,h=Uf();l.forEach(d=>{if(!s.has(d)){let m=Hf(e.get(d),r.get(d));m!==null&&h.set(d,m),s=s.add(d)}}),o.push(this.documentOverlayCache.saveOverlays(t,c,h))}return f.waitFor(o)}).next(()=>r)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(r=>this.recalculateAndSaveOverlays(t,r))}getDocumentsMatchingQuery(t,e,r,i){return function(o){return I.isDocumentKey(o.path)&&o.collectionGroup===null&&o.filters.length===0}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):bc(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,r,i):this.getDocumentsMatchingCollectionQuery(t,e,r,i)}getNextDocuments(t,e,r,i){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,r,i).next(s=>{let o=i-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,r.largestBatchId,i-s.size):f.resolve(Wt()),a=-1,u=s;return o.next(c=>f.forEach(c,(l,h)=>(a<h.largestBatchId&&(a=h.largestBatchId),s.get(l)?f.resolve():this.remoteDocumentCache.getEntry(t,l).next(d=>{u=u.insert(l,d)}))).next(()=>this.populateOverlays(t,c,s)).next(()=>this.computeViews(t,u,c,V())).next(l=>({batchId:a,changes:Bf(l)})))})}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new I(e)).next(r=>{let i=qr();return r.isFoundDocument()&&(i=i.insert(r.key,r)),i})}getDocumentsMatchingCollectionGroupQuery(t,e,r,i){let s=e.collectionGroup,o=qr();return this.indexManager.getCollectionParents(t,s).next(a=>f.forEach(a,u=>{let c=function(h,d){return new Ot(d,null,h.explicitOrderBy.slice(),h.filters.slice(),h.limit,h.limitType,h.startAt,h.endAt)}(e,u.child(s));return this.getDocumentsMatchingCollectionQuery(t,c,r,i).next(l=>{l.forEach((h,d)=>{o=o.insert(h,d)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,e,r,i){let s;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,r.largestBatchId).next(o=>(s=o,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,r,s,i))).next(o=>{s.forEach((u,c)=>{let l=c.getKey();o.get(l)===null&&(o=o.insert(l,ut.newInvalidDocument(l)))});let a=qr();return o.forEach((u,c)=>{let l=s.get(u);l!==void 0&&zr(l.mutation,c,xt.empty(),W.now()),_i(e,c)&&(a=a.insert(u,c))}),a})}};var Au=class{constructor(t){this.serializer=t,this.ur=new Map,this.cr=new Map}getBundleMetadata(t,e){return f.resolve(this.ur.get(e))}saveBundleMetadata(t,e){return this.ur.set(e.id,function(i){return{id:i.id,version:i.version,createTime:et(i.createTime)}}(e)),f.resolve()}getNamedQuery(t,e){return f.resolve(this.cr.get(e))}saveNamedQuery(t,e){return this.cr.set(e.name,function(i){return{name:i.name,query:Cc(i.bundledQuery),readTime:et(i.readTime)}}(e)),f.resolve()}};var Su=class{constructor(){this.overlays=new $(I.comparator),this.lr=new Map}getOverlay(t,e){return f.resolve(this.overlays.get(e))}getOverlays(t,e){let r=Wt();return f.forEach(e,i=>this.getOverlay(t,i).next(s=>{s!==null&&r.set(i,s)})).next(()=>r)}saveOverlays(t,e,r){return r.forEach((i,s)=>{this.lt(t,e,s)}),f.resolve()}removeOverlaysForBatchId(t,e,r){let i=this.lr.get(r);return i!==void 0&&(i.forEach(s=>this.overlays=this.overlays.remove(s)),this.lr.delete(r)),f.resolve()}getOverlaysForCollection(t,e,r){let i=Wt(),s=e.length+1,o=new I(e.child("")),a=this.overlays.getIteratorFrom(o);for(;a.hasNext();){let u=a.getNext().value,c=u.getKey();if(!e.isPrefixOf(c.path))break;c.path.length===s&&u.largestBatchId>r&&i.set(u.getKey(),u)}return f.resolve(i)}getOverlaysForCollectionGroup(t,e,r,i){let s=new $((c,l)=>c-l),o=this.overlays.getIterator();for(;o.hasNext();){let c=o.getNext().value;if(c.getKey().getCollectionGroup()===e&&c.largestBatchId>r){let l=s.get(c.largestBatchId);l===null&&(l=Wt(),s=s.insert(c.largestBatchId,l)),l.set(c.getKey(),c)}}let a=Wt(),u=s.getIterator();for(;u.hasNext()&&(u.getNext().value.forEach((c,l)=>a.set(c,l)),!(a.size()>=i)););return f.resolve(a)}lt(t,e,r){let i=this.overlays.get(r.key);if(i!==null){let o=this.lr.get(i.largestBatchId).delete(r.key);this.lr.set(i.largestBatchId,o)}this.overlays=this.overlays.insert(r.key,new ti(e,r));let s=this.lr.get(e);s===void 0&&(s=V(),this.lr.set(e,s)),this.lr.set(e,s.add(r.key))}};var oi=class{constructor(){this.hr=new z(st.Pr),this.Ir=new z(st.Tr)}isEmpty(){return this.hr.isEmpty()}addReference(t,e){let r=new st(t,e);this.hr=this.hr.add(r),this.Ir=this.Ir.add(r)}Er(t,e){t.forEach(r=>this.addReference(r,e))}removeReference(t,e){this.dr(new st(t,e))}Ar(t,e){t.forEach(r=>this.removeReference(r,e))}Rr(t){let e=new I(new M([])),r=new st(e,t),i=new st(e,t+1),s=[];return this.Ir.forEachInRange([r,i],o=>{this.dr(o),s.push(o.key)}),s}Vr(){this.hr.forEach(t=>this.dr(t))}dr(t){this.hr=this.hr.delete(t),this.Ir=this.Ir.delete(t)}mr(t){let e=new I(new M([])),r=new st(e,t),i=new st(e,t+1),s=V();return this.Ir.forEachInRange([r,i],o=>{s=s.add(o.key)}),s}containsKey(t){let e=new st(t,0),r=this.hr.firstAfterOrEqual(e);return r!==null&&t.isEqual(r.key)}},st=class{constructor(t,e){this.key=t,this.gr=e}static Pr(t,e){return I.comparator(t.key,e.key)||C(t.gr,e.gr)}static Tr(t,e){return C(t.gr,e.gr)||I.comparator(t.key,e.key)}};var Ru=class{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.pr=1,this.yr=new z(st.Pr)}checkEmpty(t){return f.resolve(this.mutationQueue.length===0)}addMutationBatch(t,e,r,i){let s=this.pr;this.pr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let o=new Zr(s,e,r,i);this.mutationQueue.push(o);for(let a of i)this.yr=this.yr.add(new st(a.key,s)),this.indexManager.addToCollectionParentIndex(t,a.key.path.popLast());return f.resolve(o)}lookupMutationBatch(t,e){return f.resolve(this.wr(e))}getNextMutationBatchAfterBatchId(t,e){let r=e+1,i=this.Sr(r),s=i<0?0:i;return f.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return f.resolve(this.mutationQueue.length===0?-1:this.pr-1)}getAllMutationBatches(t){return f.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){let r=new st(e,0),i=new st(e,Number.POSITIVE_INFINITY),s=[];return this.yr.forEachInRange([r,i],o=>{let a=this.wr(o.gr);s.push(a)}),f.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let r=new z(C);return e.forEach(i=>{let s=new st(i,0),o=new st(i,Number.POSITIVE_INFINITY);this.yr.forEachInRange([s,o],a=>{r=r.add(a.gr)})}),f.resolve(this.br(r))}getAllMutationBatchesAffectingQuery(t,e){let r=e.path,i=r.length+1,s=r;I.isDocumentKey(s)||(s=s.child(""));let o=new st(new I(s),0),a=new z(C);return this.yr.forEachWhile(u=>{let c=u.key.path;return!!r.isPrefixOf(c)&&(c.length===i&&(a=a.add(u.gr)),!0)},o),f.resolve(this.br(a))}br(t){let e=[];return t.forEach(r=>{let i=this.wr(r);i!==null&&e.push(i)}),e}removeMutationBatch(t,e){R(this.Dr(e.batchId,"removed")===0),this.mutationQueue.shift();let r=this.yr;return f.forEach(e.mutations,i=>{let s=new st(i.key,e.batchId);return r=r.delete(s),this.referenceDelegate.markPotentiallyOrphaned(t,i.key)}).next(()=>{this.yr=r})}Fn(t){}containsKey(t,e){let r=new st(e,0),i=this.yr.firstAfterOrEqual(r);return f.resolve(e.isEqual(i&&i.key))}performConsistencyCheck(t){return this.mutationQueue.length,f.resolve()}Dr(t,e){return this.Sr(t)}Sr(t){return this.mutationQueue.length===0?0:t-this.mutationQueue[0].batchId}wr(t){let e=this.Sr(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}};var Pu=class{constructor(t){this.Cr=t,this.docs=function(){return new $(I.comparator)}(),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){let r=e.key,i=this.docs.get(r),s=i?i.size:0,o=this.Cr(e);return this.docs=this.docs.insert(r,{document:e.mutableCopy(),size:o}),this.size+=o-s,this.indexManager.addToCollectionParentIndex(t,r.path.popLast())}removeEntry(t){let e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){let r=this.docs.get(e);return f.resolve(r?r.document.mutableCopy():ut.newInvalidDocument(e))}getEntries(t,e){let r=St();return e.forEach(i=>{let s=this.docs.get(i);r=r.insert(i,s?s.document.mutableCopy():ut.newInvalidDocument(i))}),f.resolve(r)}getDocumentsMatchingQuery(t,e,r,i){let s=St(),o=e.path,a=new I(o.child("")),u=this.docs.getIteratorFrom(a);for(;u.hasNext();){let{key:c,value:{document:l}}=u.getNext();if(!o.isPrefixOf(c.path))break;c.path.length>o.length+1||Ac(_f(l),r)<=0||(i.has(l.key)||_i(e,l))&&(s=s.insert(l.key,l.mutableCopy()))}return f.resolve(s)}getAllFromCollectionGroup(t,e,r,i){S()}vr(t,e){return f.forEach(this.docs,r=>e(r))}newChangeBuffer(t){return new bu(this)}getSize(t){return f.resolve(this.size)}},bu=class extends ks{constructor(t){super(),this._r=t}applyChanges(t){let e=[];return this.changes.forEach((r,i)=>{i.isValidDocument()?e.push(this._r.addEntry(t,i)):this._r.removeEntry(r)}),f.waitFor(e)}getFromCache(t,e){return this._r.getEntry(t,e)}getAllFromCache(t,e){return this._r.getEntries(t,e)}};var xu=class{constructor(t){this.persistence=t,this.Fr=new te(e=>Xe(e),gi),this.lastRemoteSnapshotVersion=P.min(),this.highestTargetId=0,this.Mr=0,this.Or=new oi,this.targetCount=0,this.Nr=zn.On()}forEachTarget(t,e){return this.Fr.forEach((r,i)=>e(i)),f.resolve()}getLastRemoteSnapshotVersion(t){return f.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return f.resolve(this.Mr)}allocateTargetId(t){return this.highestTargetId=this.Nr.next(),f.resolve(this.highestTargetId)}setTargetsMetadata(t,e,r){return r&&(this.lastRemoteSnapshotVersion=r),e>this.Mr&&(this.Mr=e),f.resolve()}kn(t){this.Fr.set(t.target,t);let e=t.targetId;e>this.highestTargetId&&(this.Nr=new zn(e),this.highestTargetId=e),t.sequenceNumber>this.Mr&&(this.Mr=t.sequenceNumber)}addTargetData(t,e){return this.kn(e),this.targetCount+=1,f.resolve()}updateTargetData(t,e){return this.kn(e),f.resolve()}removeTargetData(t,e){return this.Fr.delete(e.target),this.Or.Rr(e.targetId),this.targetCount-=1,f.resolve()}removeTargets(t,e,r){let i=0,s=[];return this.Fr.forEach((o,a)=>{a.sequenceNumber<=e&&r.get(a.targetId)===null&&(this.Fr.delete(o),s.push(this.removeMatchingKeysForTargetId(t,a.targetId)),i++)}),f.waitFor(s).next(()=>i)}getTargetCount(t){return f.resolve(this.targetCount)}getTargetData(t,e){let r=this.Fr.get(e)||null;return f.resolve(r)}addMatchingKeys(t,e,r){return this.Or.Er(e,r),f.resolve()}removeMatchingKeys(t,e,r){this.Or.Ar(e,r);let i=this.persistence.referenceDelegate,s=[];return i&&e.forEach(o=>{s.push(i.markPotentiallyOrphaned(t,o))}),f.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.Or.Rr(e),f.resolve()}getMatchingKeysForTargetId(t,e){let r=this.Or.mr(e);return f.resolve(r)}containsKey(t,e){return f.resolve(this.Or.containsKey(e))}};var Ms=class{constructor(t,e){this.Lr={},this.overlays={},this.Br=new bt(0),this.kr=!1,this.kr=!0,this.referenceDelegate=t(this),this.qr=new xu(this),this.indexManager=new mu,this.remoteDocumentCache=function(i){return new Pu(i)}(r=>this.referenceDelegate.Qr(r)),this.serializer=new Ps(e),this.Kr=new Au(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.kr=!1,Promise.resolve()}get started(){return this.kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new Su,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let r=this.Lr[t.toKey()];return r||(r=new Ru(e,this.referenceDelegate),this.Lr[t.toKey()]=r),r}getTargetCache(){return this.qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Kr}runTransaction(t,e,r){y("MemoryPersistence","Starting transaction:",t);let i=new Du(this.Br.next());return this.referenceDelegate.$r(),r(i).next(s=>this.referenceDelegate.Ur(i).next(()=>s)).toPromise().then(s=>(i.raiseOnCommittedEvent(),s))}Wr(t,e){return f.or(Object.values(this.Lr).map(r=>()=>r.containsKey(t,e)))}},Du=class extends gs{constructor(t){super(),this.currentSequenceNumber=t}},Ls=class n{constructor(t){this.persistence=t,this.Gr=new oi,this.zr=null}static jr(t){return new n(t)}get Hr(){if(this.zr)return this.zr;throw S()}addReference(t,e,r){return this.Gr.addReference(r,e),this.Hr.delete(r.toString()),f.resolve()}removeReference(t,e,r){return this.Gr.removeReference(r,e),this.Hr.add(r.toString()),f.resolve()}markPotentiallyOrphaned(t,e){return this.Hr.add(e.toString()),f.resolve()}removeTarget(t,e){this.Gr.Rr(e.targetId).forEach(i=>this.Hr.add(i.toString()));let r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(t,e.targetId).next(i=>{i.forEach(s=>this.Hr.add(s.toString()))}).next(()=>r.removeTargetData(t,e))}$r(){this.zr=new Set}Ur(t){let e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return f.forEach(this.Hr,r=>{let i=I.fromPath(r);return this.Jr(t,i).next(s=>{s||e.removeEntry(i,P.min())})}).next(()=>(this.zr=null,e.apply(t)))}updateLimboDocument(t,e){return this.Jr(t,e).next(r=>{r?this.Hr.delete(e.toString()):this.Hr.add(e.toString())})}Qr(t){return 0}Jr(t,e){return f.or([()=>f.resolve(this.Gr.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Wr(t,e)])}};var Cu=class{constructor(t){this.serializer=t}O(t,e,r,i){let s=new ps("createOrUpgrade",e);r<1&&i>=1&&(function(u){u.createObjectStore("owner")}(t),function(u){u.createObjectStore("mutationQueues",{keyPath:"userId"}),u.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",gd,{unique:!0}),u.createObjectStore("documentMutations")}(t),Zd(t),function(u){u.createObjectStore("remoteDocuments")}(t));let o=f.resolve();return r<3&&i>=3&&(r!==0&&(function(u){u.deleteObjectStore("targetDocuments"),u.deleteObjectStore("targets"),u.deleteObjectStore("targetGlobal")}(t),Zd(t)),o=o.next(()=>function(u){let c=u.store("targetGlobal"),l={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:P.min().toTimestamp(),targetCount:0};return c.put("targetGlobalKey",l)}(s))),r<4&&i>=4&&(r!==0&&(o=o.next(()=>function(u,c){return c.store("mutations").U().next(l=>{u.deleteObjectStore("mutations"),u.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",gd,{unique:!0});let h=c.store("mutations"),d=l.map(m=>h.put(m));return f.waitFor(d)})}(t,s))),o=o.next(()=>{(function(u){u.createObjectStore("clientMetadata",{keyPath:"clientId"})})(t)})),r<5&&i>=5&&(o=o.next(()=>this.Zr(s))),r<6&&i>=6&&(o=o.next(()=>(function(u){u.createObjectStore("remoteDocumentGlobal")}(t),this.Xr(s)))),r<7&&i>=7&&(o=o.next(()=>this.ei(s))),r<8&&i>=8&&(o=o.next(()=>this.ti(t,s))),r<9&&i>=9&&(o=o.next(()=>{(function(u){u.objectStoreNames.contains("remoteDocumentChanges")&&u.deleteObjectStore("remoteDocumentChanges")})(t)})),r<10&&i>=10&&(o=o.next(()=>this.ni(s))),r<11&&i>=11&&(o=o.next(()=>{(function(u){u.createObjectStore("bundles",{keyPath:"bundleId"})})(t),function(u){u.createObjectStore("namedQueries",{keyPath:"name"})}(t)})),r<12&&i>=12&&(o=o.next(()=>{(function(u){let c=u.createObjectStore("documentOverlays",{keyPath:r_});c.createIndex("collectionPathOverlayIndex",i_,{unique:!1}),c.createIndex("collectionGroupOverlayIndex",s_,{unique:!1})})(t)})),r<13&&i>=13&&(o=o.next(()=>function(u){let c=u.createObjectStore("remoteDocumentsV14",{keyPath:$p});c.createIndex("documentKeyIndex",Qp),c.createIndex("collectionGroupIndex",Wp)}(t)).next(()=>this.ri(t,s)).next(()=>t.deleteObjectStore("remoteDocuments"))),r<14&&i>=14&&(o=o.next(()=>this.ii(t,s))),r<15&&i>=15&&(o=o.next(()=>function(u){u.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),u.createObjectStore("indexState",{keyPath:Zp}).createIndex("sequenceNumberIndex",t_,{unique:!1}),u.createObjectStore("indexEntries",{keyPath:e_}).createIndex("documentKeyIndex",n_,{unique:!1})}(t))),r<16&&i>=16&&(o=o.next(()=>{e.objectStore("indexState").clear()}).next(()=>{e.objectStore("indexEntries").clear()})),o}Xr(t){let e=0;return t.store("remoteDocuments").J((r,i)=>{e+=Vs(i)}).next(()=>{let r={byteSize:e};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",r)})}Zr(t){let e=t.store("mutationQueues"),r=t.store("mutations");return e.U().next(i=>f.forEach(i,s=>{let o=IDBKeyRange.bound([s.userId,-1],[s.userId,s.lastAcknowledgedBatchId]);return r.U("userMutationsIndex",o).next(a=>f.forEach(a,u=>{R(u.userId===s.userId);let c=je(this.serializer,u);return gm(t,s.userId,c).next(()=>{})}))}))}ei(t){let e=t.store("targetDocuments"),r=t.store("remoteDocuments");return t.store("targetGlobal").get("targetGlobalKey").next(i=>{let s=[];return r.J((o,a)=>{let u=new M(o),c=function(h){return[0,Et(h)]}(u);s.push(e.get(c).next(l=>l?f.resolve():(h=>e.put({targetId:0,path:Et(h),sequenceNumber:i.highestListenSequenceNumber}))(u)))}).next(()=>f.waitFor(s))})}ti(t,e){t.createObjectStore("collectionParents",{keyPath:Xp});let r=e.store("collectionParents"),i=new si,s=o=>{if(i.add(o)){let a=o.lastSegment(),u=o.popLast();return r.put({collectionId:a,parent:Et(u)})}};return e.store("remoteDocuments").J({H:!0},(o,a)=>{let u=new M(o);return s(u.popLast())}).next(()=>e.store("documentMutations").J({H:!0},([o,a,u],c)=>{let l=Qt(a);return s(l.popLast())}))}ni(t){let e=t.store("targets");return e.J((r,i)=>{let s=Br(i),o=dm(this.serializer,s);return e.put(o)})}ri(t,e){let r=e.store("remoteDocuments"),i=[];return r.J((s,o)=>{let a=e.store("remoteDocumentsV14"),u=function(h){return h.document?new I(M.fromString(h.document.name).popFirst(5)):h.noDocument?I.fromSegments(h.noDocument.path):h.unknownDocument?I.fromSegments(h.unknownDocument.path):S()}(o).path.toArray(),c={prefixPath:u.slice(0,u.length-2),collectionGroup:u[u.length-2],documentId:u[u.length-1],readTime:o.readTime||[0,0],unknownDocument:o.unknownDocument,noDocument:o.noDocument,document:o.document,hasCommittedMutations:!!o.hasCommittedMutations};i.push(a.put(c))}).next(()=>f.waitFor(i))}ii(t,e){let r=e.store("mutations"),i=ym(this.serializer),s=new Ms(Ls.jr,this.serializer.ut);return r.U().next(o=>{let a=new Map;return o.forEach(u=>{var c;let l=(c=a.get(u.userId))!==null&&c!==void 0?c:V();je(this.serializer,u).keys().forEach(h=>l=l.add(h)),a.set(u.userId,l)}),f.forEach(a,(u,c)=>{let l=new ot(c),h=xs.ct(this.serializer,l),d=s.getIndexManager(l),m=Ns.ct(l,this.serializer,d,s.referenceDelegate);return new Fs(i,m,h,d).recalculateAndSaveOverlaysForDocumentKeys(new Wr(e,bt.oe),u).next()})})}};function Zd(n){n.createObjectStore("targetDocuments",{keyPath:Jp}).createIndex("documentTargetsIndex",Yp,{unique:!0}),n.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Hp,{unique:!0}),n.createObjectStore("targetGlobal")}var Ea="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",Vu=class n{constructor(t,e,r,i,s,o,a,u,c,l,h=16){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=r,this.si=s,this.window=o,this.document=a,this.oi=c,this._i=l,this.ai=h,this.Br=null,this.kr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ui=null,this.inForeground=!1,this.ci=null,this.li=null,this.hi=Number.NEGATIVE_INFINITY,this.Pi=d=>Promise.resolve(),!n.D())throw new _(g.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new vu(this,i),this.Ii=e+"main",this.serializer=new Ps(u),this.Ti=new Ae(this.Ii,this.ai,new Cu(this.serializer)),this.qr=new pu(this.referenceDelegate,this.serializer),this.remoteDocumentCache=ym(this.serializer),this.Kr=new au,this.window&&this.window.localStorage?this.Ei=this.window.localStorage:(this.Ei=null,l===!1&&Z("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.di().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new _(g.FAILED_PRECONDITION,Ea);return this.Ai(),this.Ri(),this.Vi(),this.runTransaction("getHighestListenSequenceNumber","readonly",t=>this.qr.getHighestSequenceNumber(t))}).then(t=>{this.Br=new bt(t,this.oi)}).then(()=>{this.kr=!0}).catch(t=>(this.Ti&&this.Ti.close(),Promise.reject(t)))}mi(t){return this.Pi=e=>p(this,null,function*(){if(this.started)return t(e)}),t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ti.L(e=>p(this,null,function*(){e.newVersion===null&&(yield t())}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.si.enqueueAndForget(()=>p(this,null,function*(){this.started&&(yield this.di())})))}di(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>is(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.fi(t).next(e=>{e||(this.isPrimary=!1,this.si.enqueueRetryable(()=>this.Pi(!1)))})}).next(()=>this.gi(t)).next(e=>this.isPrimary&&!e?this.pi(t).next(()=>!1):!!e&&this.yi(t).next(()=>!0))).catch(t=>{if(ke(t))return y("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return y("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1}).then(t=>{this.isPrimary!==t&&this.si.enqueueRetryable(()=>this.Pi(t)),this.isPrimary=t})}fi(t){return Or(t).get("owner").next(e=>f.resolve(this.wi(e)))}Si(t){return is(t).delete(this.clientId)}bi(){return p(this,null,function*(){if(this.isPrimary&&!this.Di(this.hi,18e5)){this.hi=Date.now();let t=yield this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let r=ft(e,"clientMetadata");return r.U().next(i=>{let s=this.Ci(i,18e5),o=i.filter(a=>s.indexOf(a)===-1);return f.forEach(o,a=>r.delete(a.clientId)).next(()=>o)})}).catch(()=>[]);if(this.Ei)for(let e of t)this.Ei.removeItem(this.vi(e.clientId))}})}Vi(){this.li=this.si.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.di().then(()=>this.bi()).then(()=>this.Vi()))}wi(t){return!!t&&t.ownerId===this.clientId}gi(t){return this._i?f.resolve(!0):Or(t).get("owner").next(e=>{if(e!==null&&this.Di(e.leaseTimestampMs,5e3)&&!this.Fi(e.ownerId)){if(this.wi(e)&&this.networkEnabled)return!0;if(!this.wi(e)){if(!e.allowTabSynchronization)throw new _(g.FAILED_PRECONDITION,Ea);return!1}}return!(!this.networkEnabled||!this.inForeground)||is(t).U().next(r=>this.Ci(r,5e3).find(i=>{if(this.clientId!==i.clientId){let s=!this.networkEnabled&&i.networkEnabled,o=!this.inForeground&&i.inForeground,a=this.networkEnabled===i.networkEnabled;if(s||o&&a)return!0}return!1})===void 0)}).next(e=>(this.isPrimary!==e&&y("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}shutdown(){return p(this,null,function*(){this.kr=!1,this.Mi(),this.li&&(this.li.cancel(),this.li=null),this.xi(),this.Oi(),yield this.Ti.runTransaction("shutdown","readwrite",["owner","clientMetadata"],t=>{let e=new Wr(t,bt.oe);return this.pi(e).next(()=>this.Si(e))}),this.Ti.close(),this.Ni()})}Ci(t,e){return t.filter(r=>this.Di(r.updateTimeMs,e)&&!this.Fi(r.clientId))}Li(){return this.runTransaction("getActiveClients","readonly",t=>is(t).U().next(e=>this.Ci(e,18e5).map(r=>r.clientId)))}get started(){return this.kr}getMutationQueue(t,e){return Ns.ct(t,this.serializer,e,this.referenceDelegate)}getTargetCache(){return this.qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(t){return new gu(t,this.serializer.ut.databaseId)}getDocumentOverlayCache(t){return xs.ct(this.serializer,t)}getBundleCache(){return this.Kr}runTransaction(t,e,r){y("IndexedDbPersistence","Starting transaction:",t);let i=e==="readonly"?"readonly":"readwrite",s=function(u){return u===16?a_:u===15?Sf:u===14?Af:u===13?Tf:u===12?o_:u===11?Ef:void S()}(this.ai),o;return this.Ti.runTransaction(t,i,s,a=>(o=new Wr(a,this.Br?this.Br.next():bt.oe),e==="readwrite-primary"?this.fi(o).next(u=>!!u||this.gi(o)).next(u=>{if(!u)throw Z(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.si.enqueueRetryable(()=>this.Pi(!1)),new _(g.FAILED_PRECONDITION,yf);return r(o)}).next(u=>this.yi(o).next(()=>u)):this.Bi(o).next(()=>r(o)))).then(a=>(o.raiseOnCommittedEvent(),a))}Bi(t){return Or(t).get("owner").next(e=>{if(e!==null&&this.Di(e.leaseTimestampMs,5e3)&&!this.Fi(e.ownerId)&&!this.wi(e)&&!(this._i||this.allowTabSynchronization&&e.allowTabSynchronization))throw new _(g.FAILED_PRECONDITION,Ea)})}yi(t){let e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Or(t).put("owner",e)}static D(){return Ae.D()}pi(t){let e=Or(t);return e.get("owner").next(r=>this.wi(r)?(y("IndexedDbPersistence","Releasing primary lease."),e.delete("owner")):f.resolve())}Di(t,e){let r=Date.now();return!(t<r-e)&&(!(t>r)||(Z(`Detected an update time that is in the future: ${t} > ${r}`),!1))}Ai(){this.document!==null&&typeof this.document.addEventListener=="function"&&(this.ci=()=>{this.si.enqueueAndForget(()=>(this.inForeground=this.document.visibilityState==="visible",this.di()))},this.document.addEventListener("visibilitychange",this.ci),this.inForeground=this.document.visibilityState==="visible")}xi(){this.ci&&(this.document.removeEventListener("visibilitychange",this.ci),this.ci=null)}Ri(){var t;typeof((t=this.window)===null||t===void 0?void 0:t.addEventListener)=="function"&&(this.ui=()=>{this.Mi();let e=/(?:Version|Mobile)\/1[456]/;Po()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.si.enterRestrictedMode(!0),this.si.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.ui))}Oi(){this.ui&&(this.window.removeEventListener("pagehide",this.ui),this.ui=null)}Fi(t){var e;try{let r=((e=this.Ei)===null||e===void 0?void 0:e.getItem(this.vi(t)))!==null;return y("IndexedDbPersistence",`Client '${t}' ${r?"is":"is not"} zombied in LocalStorage`),r}catch(r){return Z("IndexedDbPersistence","Failed to get zombied client id.",r),!1}}Mi(){if(this.Ei)try{this.Ei.setItem(this.vi(this.clientId),String(Date.now()))}catch(t){Z("Failed to set zombie client id.",t)}}Ni(){if(this.Ei)try{this.Ei.removeItem(this.vi(this.clientId))}catch{}}vi(t){return`firestore_zombie_${this.persistenceKey}_${t}`}};function Or(n){return ft(n,"owner")}function is(n){return ft(n,"clientMetadata")}function Nc(n,t){let e=n.projectId;return n.isDefaultDatabase||(e+="."+n.database),"firestore/"+t+"/"+e+"/"}var Nu=class n{constructor(t,e,r,i){this.targetId=t,this.fromCache=e,this.ki=r,this.qi=i}static Qi(t,e){let r=V(),i=V();for(let s of e.docChanges)switch(s.type){case 0:r=r.add(s.doc.key);break;case 1:i=i.add(s.doc.key)}return new n(t,e.fromCache,r,i)}};var ku=class{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}};var Os=class{constructor(){this.Ki=!1,this.$i=!1,this.Ui=100,this.Wi=function(){return Po()?8:wf(hr())>0?6:4}()}initialize(t,e){this.Gi=t,this.indexManager=e,this.Ki=!0}getDocumentsMatchingQuery(t,e,r,i){let s={result:null};return this.zi(t,e).next(o=>{s.result=o}).next(()=>{if(!s.result)return this.ji(t,e,i,r).next(o=>{s.result=o})}).next(()=>{if(s.result)return;let o=new ku;return this.Hi(t,e,o).next(a=>{if(s.result=a,this.$i)return this.Ji(t,e,o,a.size)})}).next(()=>s.result)}Ji(t,e,r,i){return r.documentReadCount<this.Ui?(Rn()<=zt.DEBUG&&y("QueryEngine","SDK will not create cache indexes for query:",Pn(e),"since it only creates cache indexes for collection contains","more than or equal to",this.Ui,"documents"),f.resolve()):(Rn()<=zt.DEBUG&&y("QueryEngine","Query:",Pn(e),"scans",r.documentReadCount,"local documents and returns",i,"documents as results."),r.documentReadCount>this.Wi*i?(Rn()<=zt.DEBUG&&y("QueryEngine","The SDK decides to create cache indexes for query:",Pn(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,Tt(e))):f.resolve())}zi(t,e){if(Rd(e))return f.resolve(null);let r=Tt(e);return this.indexManager.getIndexType(t,r).next(i=>i===0?null:(e.limit!==null&&i===1&&(e=Ts(e,null,"F"),r=Tt(e)),this.indexManager.getDocumentsMatchingTarget(t,r).next(s=>{let o=V(...s);return this.Gi.getDocuments(t,o).next(a=>this.indexManager.getMinOffset(t,r).next(u=>{let c=this.Yi(e,a);return this.Zi(e,c,o,u.readTime)?this.zi(t,Ts(e,null,"F")):this.Xi(t,c,e,u)}))})))}ji(t,e,r,i){return Rd(e)||i.isEqual(P.min())?f.resolve(null):this.Gi.getDocuments(t,r).next(s=>{let o=this.Yi(e,s);return this.Zi(e,o,r,i)?f.resolve(null):(Rn()<=zt.DEBUG&&y("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),Pn(e)),this.Xi(t,o,e,pf(i,-1)).next(a=>a))})}Yi(t,e){let r=new z(Of(t));return e.forEach((i,s)=>{_i(t,s)&&(r=r.add(s))}),r}Zi(t,e,r,i){if(t.limit===null)return!1;if(r.size!==e.size)return!0;let s=t.limitType==="F"?e.last():e.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(i)>0)}Hi(t,e,r){return Rn()<=zt.DEBUG&&y("QueryEngine","Using full collection scan to execute query:",Pn(e)),this.Gi.getDocumentsMatchingQuery(t,e,kt.min(),r)}Xi(t,e,r,i){return this.Gi.getDocumentsMatchingQuery(t,r,i).next(s=>(e.forEach(o=>{s=s.insert(o.key,o)}),s))}};var Fu=class{constructor(t,e,r,i){this.persistence=t,this.es=e,this.serializer=i,this.ts=new $(C),this.ns=new te(s=>Xe(s),gi),this.rs=new Map,this.ss=t.getRemoteDocumentCache(),this.qr=t.getTargetCache(),this.Kr=t.getBundleCache(),this.os(r)}os(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new Fs(this.ss,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.ss.setIndexManager(this.indexManager),this.es.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.ts))}};function wm(n,t,e,r){return new Fu(n,t,e,r)}function vm(n,t){return p(this,null,function*(){let e=E(n);return yield e.persistence.runTransaction("Handle user change","readonly",r=>{let i;return e.mutationQueue.getAllMutationBatches(r).next(s=>(i=s,e.os(t),e.mutationQueue.getAllMutationBatches(r))).next(s=>{let o=[],a=[],u=V();for(let c of i){o.push(c.batchId);for(let l of c.mutations)u=u.add(l.key)}for(let c of s){a.push(c.batchId);for(let l of c.mutations)u=u.add(l.key)}return e.localDocuments.getDocuments(r,u).next(c=>({_s:c,removedBatchIds:o,addedBatchIds:a}))})})})}function B_(n,t){let e=E(n);return e.persistence.runTransaction("Acknowledge batch","readwrite-primary",r=>{let i=t.batch.keys(),s=e.ss.newChangeBuffer({trackRemovals:!0});return function(a,u,c,l){let h=c.batch,d=h.keys(),m=f.resolve();return d.forEach(A=>{m=m.next(()=>l.getEntry(u,A)).next(w=>{let v=c.docVersions.get(A);R(v!==null),w.version.compareTo(v)<0&&(h.applyToRemoteDocument(w,c),w.isValidDocument()&&(w.setReadTime(c.commitVersion),l.addEntry(w)))})}),m.next(()=>a.mutationQueue.removeMutationBatch(u,h))}(e,r,t,s).next(()=>s.apply(r)).next(()=>e.mutationQueue.performConsistencyCheck(r)).next(()=>e.documentOverlayCache.removeOverlaysForBatchId(r,i,t.batch.batchId)).next(()=>e.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(r,function(a){let u=V();for(let c=0;c<a.mutationResults.length;++c)a.mutationResults[c].transformResults.length>0&&(u=u.add(a.batch.mutations[c].key));return u}(t))).next(()=>e.localDocuments.getDocuments(r,i))})}function Im(n){let t=E(n);return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.qr.getLastRemoteSnapshotVersion(e))}function U_(n,t){let e=E(n),r=t.snapshotVersion,i=e.ts;return e.persistence.runTransaction("Apply remote event","readwrite-primary",s=>{let o=e.ss.newChangeBuffer({trackRemovals:!0});i=e.ts;let a=[];t.targetChanges.forEach((l,h)=>{let d=i.get(h);if(!d)return;a.push(e.qr.removeMatchingKeys(s,l.removedDocuments,h).next(()=>e.qr.addMatchingKeys(s,l.addedDocuments,h)));let m=d.withSequenceNumber(s.currentSequenceNumber);t.targetMismatches.get(h)!==null?m=m.withResumeToken(dt.EMPTY_BYTE_STRING,P.min()).withLastLimboFreeSnapshotVersion(P.min()):l.resumeToken.approximateByteSize()>0&&(m=m.withResumeToken(l.resumeToken,r)),i=i.insert(h,m),function(w,v,b){return w.resumeToken.approximateByteSize()===0||v.snapshotVersion.toMicroseconds()-w.snapshotVersion.toMicroseconds()>=3e8?!0:b.addedDocuments.size+b.modifiedDocuments.size+b.removedDocuments.size>0}(d,m,l)&&a.push(e.qr.updateTargetData(s,m))});let u=St(),c=V();if(t.documentUpdates.forEach(l=>{t.resolvedLimboDocuments.has(l)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(s,l))}),a.push(Em(s,o,t.documentUpdates).next(l=>{u=l.us,c=l.cs})),!r.isEqual(P.min())){let l=e.qr.getLastRemoteSnapshotVersion(s).next(h=>e.qr.setTargetsMetadata(s,s.currentSequenceNumber,r));a.push(l)}return f.waitFor(a).next(()=>o.apply(s)).next(()=>e.localDocuments.getLocalViewOfDocuments(s,u,c)).next(()=>u)}).then(s=>(e.ts=i,s))}function Em(n,t,e){let r=V(),i=V();return e.forEach(s=>r=r.add(s)),t.getEntries(n,r).next(s=>{let o=St();return e.forEach((a,u)=>{let c=s.get(a);u.isFoundDocument()!==c.isFoundDocument()&&(i=i.add(a)),u.isNoDocument()&&u.version.isEqual(P.min())?(t.removeEntry(a,u.readTime),o=o.insert(a,u)):!c.isValidDocument()||u.version.compareTo(c.version)>0||u.version.compareTo(c.version)===0&&c.hasPendingWrites?(t.addEntry(u),o=o.insert(a,u)):y("LocalStore","Ignoring outdated watch update for ",a,". Current version:",c.version," Watch version:",u.version)}),{us:o,cs:i}})}function G_(n,t){let e=E(n);return e.persistence.runTransaction("Get next mutation batch","readonly",r=>(t===void 0&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(r,t)))}function jn(n,t){let e=E(n);return e.persistence.runTransaction("Allocate target","readwrite",r=>{let i;return e.qr.getTargetData(r,t).next(s=>s?(i=s,f.resolve(i)):e.qr.allocateTargetId(r).next(o=>(i=new Gn(t,o,"TargetPurposeListen",r.currentSequenceNumber),e.qr.addTargetData(r,i).next(()=>i))))}).then(r=>{let i=e.ts.get(r.targetId);return(i===null||r.snapshotVersion.compareTo(i.snapshotVersion)>0)&&(e.ts=e.ts.insert(r.targetId,r),e.ns.set(t,r.targetId)),r})}function Kn(n,t,e){return p(this,null,function*(){let r=E(n),i=r.ts.get(t),s=e?"readwrite":"readwrite-primary";try{e||(yield r.persistence.runTransaction("Release target",s,o=>r.persistence.referenceDelegate.removeTarget(o,i)))}catch(o){if(!ke(o))throw o;y("LocalStore",`Failed to update sequence numbers for target ${t}: ${o}`)}r.ts=r.ts.remove(t),r.ns.delete(i.target)})}function qs(n,t,e){let r=E(n),i=P.min(),s=V();return r.persistence.runTransaction("Execute query","readwrite",o=>function(u,c,l){let h=E(u),d=h.ns.get(l);return d!==void 0?f.resolve(h.ts.get(d)):h.qr.getTargetData(c,l)}(r,o,Tt(t)).next(a=>{if(a)return i=a.lastLimboFreeSnapshotVersion,r.qr.getMatchingKeysForTargetId(o,a.targetId).next(u=>{s=u})}).next(()=>r.es.getDocumentsMatchingQuery(o,t,e?i:P.min(),e?s:V())).next(a=>(Sm(r,Lf(t),a),{documents:a,ls:s})))}function Tm(n,t){let e=E(n),r=E(e.qr),i=e.ts.get(t);return i?Promise.resolve(i.target):e.persistence.runTransaction("Get target data","readonly",s=>r.ot(s,t).next(o=>o?o.target:null))}function Am(n,t){let e=E(n),r=e.rs.get(t)||P.min();return e.persistence.runTransaction("Get new document changes","readonly",i=>e.ss.getAllFromCollectionGroup(i,t,pf(r,-1),Number.MAX_SAFE_INTEGER)).then(i=>(Sm(e,t,i),i))}function Sm(n,t,e){let r=n.rs.get(t)||P.min();e.forEach((i,s)=>{s.readTime.compareTo(r)>0&&(r=s.readTime)}),n.rs.set(t,r)}function z_(n,t,e,r){return p(this,null,function*(){let i=E(n),s=V(),o=St();for(let c of e){let l=t.hs(c.metadata.name);c.document&&(s=s.add(l));let h=t.Ps(c);h.setReadTime(t.Is(c.metadata.readTime)),o=o.insert(l,h)}let a=i.ss.newChangeBuffer({trackRemovals:!0}),u=yield jn(i,function(l){return Tt(Zn(M.fromString(`__bundle__/docs/${l}`)))}(r));return i.persistence.runTransaction("Apply bundle documents","readwrite",c=>Em(c,a,o).next(l=>(a.apply(c),l)).next(l=>i.qr.removeMatchingKeysForTargetId(c,u.targetId).next(()=>i.qr.addMatchingKeys(c,s,u.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(c,l.us,l.cs)).next(()=>l.us)))})}function j_(r,i){return p(this,arguments,function*(n,t,e=V()){let s=yield jn(n,Tt(Cc(t.bundledQuery))),o=E(n);return o.persistence.runTransaction("Save named query","readwrite",a=>{let u=et(t.readTime);if(s.snapshotVersion.compareTo(u)>=0)return o.Kr.saveNamedQuery(a,t);let c=s.withResumeToken(dt.EMPTY_BYTE_STRING,u);return o.ts=o.ts.insert(c.targetId,c),o.qr.updateTargetData(a,c).next(()=>o.qr.removeMatchingKeysForTargetId(a,s.targetId)).next(()=>o.qr.addMatchingKeys(a,e,s.targetId)).next(()=>o.Kr.saveNamedQuery(a,t))})})}function tf(n,t){return`firestore_clients_${n}_${t}`}function ef(n,t,e){let r=`firestore_mutations_${n}_${e}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function Ta(n,t){return`firestore_targets_${n}_${t}`}var Bs=class n{constructor(t,e,r,i){this.user=t,this.batchId=e,this.state=r,this.error=i}static Ts(t,e,r){let i=JSON.parse(r),s,o=typeof i=="object"&&["pending","acknowledged","rejected"].indexOf(i.state)!==-1&&(i.error===void 0||typeof i.error=="object");return o&&i.error&&(o=typeof i.error.message=="string"&&typeof i.error.code=="string",o&&(s=new _(i.error.code,i.error.message))),o?new n(t,e,i.state,s):(Z("SharedClientState",`Failed to parse mutation state for ID '${e}': ${r}`),null)}Es(){let t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}},jr=class n{constructor(t,e,r){this.targetId=t,this.state=e,this.error=r}static Ts(t,e){let r=JSON.parse(e),i,s=typeof r=="object"&&["not-current","current","rejected"].indexOf(r.state)!==-1&&(r.error===void 0||typeof r.error=="object");return s&&r.error&&(s=typeof r.error.message=="string"&&typeof r.error.code=="string",s&&(i=new _(r.error.code,r.error.message))),s?new n(t,r.state,i):(Z("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}Es(){let t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}},Us=class n{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Ts(t,e){let r=JSON.parse(e),i=typeof r=="object"&&r.activeTargetIds instanceof Array,s=xc();for(let o=0;i&&o<r.activeTargetIds.length;++o)i=vf(r.activeTargetIds[o]),s=s.add(r.activeTargetIds[o]);return i?new n(t,s):(Z("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}},Mu=class n{constructor(t,e){this.clientId=t,this.onlineState=e}static Ts(t){let e=JSON.parse(t);return typeof e=="object"&&["Unknown","Online","Offline"].indexOf(e.onlineState)!==-1&&typeof e.clientId=="string"?new n(e.clientId,e.onlineState):(Z("SharedClientState",`Failed to parse online state: ${t}`),null)}},ai=class{constructor(){this.activeTargetIds=xc()}ds(t){this.activeTargetIds=this.activeTargetIds.add(t)}As(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Es(){let t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}},Kr=class{constructor(t,e,r,i,s){this.window=t,this.si=e,this.persistenceKey=r,this.Rs=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Vs=this.fs.bind(this),this.gs=new $(C),this.started=!1,this.ps=[];let o=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ys=tf(this.persistenceKey,this.Rs),this.ws=function(u){return`firestore_sequence_number_${u}`}(this.persistenceKey),this.gs=this.gs.insert(this.Rs,new ai),this.Ss=new RegExp(`^firestore_clients_${o}_([^_]*)$`),this.bs=new RegExp(`^firestore_mutations_${o}_(\\d+)(?:_(.*))?$`),this.Ds=new RegExp(`^firestore_targets_${o}_(\\d+)$`),this.Cs=function(u){return`firestore_online_state_${u}`}(this.persistenceKey),this.vs=function(u){return`firestore_bundle_loaded_v2_${u}`}(this.persistenceKey),this.window.addEventListener("storage",this.Vs)}static D(t){return!(!t||!t.localStorage)}start(){return p(this,null,function*(){let t=yield this.syncEngine.Li();for(let r of t){if(r===this.Rs)continue;let i=this.getItem(tf(this.persistenceKey,r));if(i){let s=Us.Ts(r,i);s&&(this.gs=this.gs.insert(s.clientId,s))}}this.Fs();let e=this.storage.getItem(this.Cs);if(e){let r=this.Ms(e);r&&this.xs(r)}for(let r of this.ps)this.fs(r);this.ps=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0})}writeSequenceNumber(t){this.setItem(this.ws,JSON.stringify(t))}getAllActiveQueryTargets(){return this.Os(this.gs)}isActiveQueryTarget(t){let e=!1;return this.gs.forEach((r,i)=>{i.activeTargetIds.has(t)&&(e=!0)}),e}addPendingMutation(t){this.Ns(t,"pending")}updateMutationState(t,e,r){this.Ns(t,e,r),this.Ls(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){let r=this.storage.getItem(Ta(this.persistenceKey,t));if(r){let i=jr.Ts(t,r);i&&(e=i.state)}}return this.Bs.ds(t),this.Fs(),e}removeLocalQueryTarget(t){this.Bs.As(t),this.Fs()}isLocalQueryTarget(t){return this.Bs.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(Ta(this.persistenceKey,t))}updateQueryState(t,e,r){this.ks(t,e,r)}handleUserChange(t,e,r){e.forEach(i=>{this.Ls(i)}),this.currentUser=t,r.forEach(i=>{this.addPendingMutation(i)})}setOnlineState(t){this.qs(t)}notifyBundleLoaded(t){this.Qs(t)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Vs),this.removeItem(this.ys),this.started=!1)}getItem(t){let e=this.storage.getItem(t);return y("SharedClientState","READ",t,e),e}setItem(t,e){y("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){y("SharedClientState","REMOVE",t),this.storage.removeItem(t)}fs(t){let e=t;if(e.storageArea===this.storage){if(y("SharedClientState","EVENT",e.key,e.newValue),e.key===this.ys)return void Z("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.si.enqueueRetryable(()=>p(this,null,function*(){if(this.started){if(e.key!==null){if(this.Ss.test(e.key)){if(e.newValue==null){let r=this.Ks(e.key);return this.$s(r,null)}{let r=this.Us(e.key,e.newValue);if(r)return this.$s(r.clientId,r)}}else if(this.bs.test(e.key)){if(e.newValue!==null){let r=this.Ws(e.key,e.newValue);if(r)return this.Gs(r)}}else if(this.Ds.test(e.key)){if(e.newValue!==null){let r=this.zs(e.key,e.newValue);if(r)return this.js(r)}}else if(e.key===this.Cs){if(e.newValue!==null){let r=this.Ms(e.newValue);if(r)return this.xs(r)}}else if(e.key===this.ws){let r=function(s){let o=bt.oe;if(s!=null)try{let a=JSON.parse(s);R(typeof a=="number"),o=a}catch(a){Z("SharedClientState","Failed to read sequence number from WebStorage",a)}return o}(e.newValue);r!==bt.oe&&this.sequenceNumberHandler(r)}else if(e.key===this.vs){let r=this.Hs(e.newValue);yield Promise.all(r.map(i=>this.syncEngine.Js(i)))}}}else this.ps.push(e)}))}}get Bs(){return this.gs.get(this.Rs)}Fs(){this.setItem(this.ys,this.Bs.Es())}Ns(t,e,r){let i=new Bs(this.currentUser,t,e,r),s=ef(this.persistenceKey,this.currentUser,t);this.setItem(s,i.Es())}Ls(t){let e=ef(this.persistenceKey,this.currentUser,t);this.removeItem(e)}qs(t){let e={clientId:this.Rs,onlineState:t};this.storage.setItem(this.Cs,JSON.stringify(e))}ks(t,e,r){let i=Ta(this.persistenceKey,t),s=new jr(t,e,r);this.setItem(i,s.Es())}Qs(t){let e=JSON.stringify(Array.from(t));this.setItem(this.vs,e)}Ks(t){let e=this.Ss.exec(t);return e?e[1]:null}Us(t,e){let r=this.Ks(t);return Us.Ts(r,e)}Ws(t,e){let r=this.bs.exec(t),i=Number(r[1]),s=r[2]!==void 0?r[2]:null;return Bs.Ts(new ot(s),i,e)}zs(t,e){let r=this.Ds.exec(t),i=Number(r[1]);return jr.Ts(i,e)}Ms(t){return Mu.Ts(t)}Hs(t){return JSON.parse(t)}Gs(t){return p(this,null,function*(){if(t.user.uid===this.currentUser.uid)return this.syncEngine.Ys(t.batchId,t.state,t.error);y("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)})}js(t){return this.syncEngine.Zs(t.targetId,t.state,t.error)}$s(t,e){let r=e?this.gs.insert(t,e):this.gs.remove(t),i=this.Os(this.gs),s=this.Os(r),o=[],a=[];return s.forEach(u=>{i.has(u)||o.push(u)}),i.forEach(u=>{s.has(u)||a.push(u)}),this.syncEngine.Xs(o,a).then(()=>{this.gs=r})}xs(t){this.gs.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}Os(t){let e=xc();return t.forEach((r,i)=>{e=e.unionWith(i.activeTargetIds)}),e}},Gs=class{constructor(){this.eo=new ai,this.no={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,r){}addLocalQueryTarget(t){return this.eo.ds(t),this.no[t]||"not-current"}updateQueryState(t,e,r){this.no[t]=e}removeLocalQueryTarget(t){this.eo.As(t)}isLocalQueryTarget(t){return this.eo.activeTargetIds.has(t)}clearQueryState(t){delete this.no[t]}getAllActiveQueryTargets(){return this.eo.activeTargetIds}isActiveQueryTarget(t){return this.eo.activeTargetIds.has(t)}start(){return this.eo=new ai,Promise.resolve()}handleUserChange(t,e,r){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}};var Lu=class{ro(t){}shutdown(){}};var zs=class{constructor(){this.io=()=>this.so(),this.oo=()=>this._o(),this.ao=[],this.uo()}ro(t){this.ao.push(t)}shutdown(){window.removeEventListener("online",this.io),window.removeEventListener("offline",this.oo)}uo(){window.addEventListener("online",this.io),window.addEventListener("offline",this.oo)}so(){y("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(let t of this.ao)t(0)}_o(){y("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(let t of this.ao)t(1)}static D(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}};var ss=null;function Aa(){return ss===null?ss=function(){return 268435456+Math.round(2147483648*Math.random())}():ss++,"0x"+ss.toString(16)}var K_={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};var Ou=class{constructor(t){this.co=t.co,this.lo=t.lo}ho(t){this.Po=t}Io(t){this.To=t}Eo(t){this.Ao=t}onMessage(t){this.Ro=t}close(){this.lo()}send(t){this.co(t)}Vo(){this.Po()}mo(){this.To()}fo(t){this.Ao(t)}po(t){this.Ro(t)}};var wt="WebChannelConnection",qu=class extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let r=e.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),s=encodeURIComponent(this.databaseId.database);this.yo=r+"://"+e.host,this.wo=`projects/${i}/databases/${s}`,this.So=this.databaseId.database==="(default)"?`project_id=${i}`:`project_id=${i}&database_id=${s}`}get bo(){return!1}Do(e,r,i,s,o){let a=Aa(),u=this.Co(e,r.toUriEncodedString());y("RestConnection",`Sending RPC '${e}' ${a}:`,u,i);let c={"google-cloud-resource-prefix":this.wo,"x-goog-request-params":this.So};return this.vo(c,s,o),this.Fo(e,u,c,i).then(l=>(y("RestConnection",`Received RPC '${e}' ${a}: `,l),l),l=>{throw Nt("RestConnection",`RPC '${e}' ${a} failed with error: `,l,"url: ",u,"request:",i),l})}Mo(e,r,i,s,o,a){return this.Do(e,r,i,s,o)}vo(e,r,i){e["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+Xn}(),e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),r&&r.headers.forEach((s,o)=>e[o]=s),i&&i.headers.forEach((s,o)=>e[o]=s)}Co(e,r){let i=K_[e];return`${this.yo}/v1/${r}:${i}`}terminate(){}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}Fo(t,e,r,i){let s=Aa();return new Promise((o,a)=>{let u=new ld;u.setWithCredentials(!0),u.listenOnce(ad.COMPLETE,()=>{try{switch(u.getLastErrorCode()){case es.NO_ERROR:let l=u.getResponseJson();y(wt,`XHR for RPC '${t}' ${s} received:`,JSON.stringify(l)),o(l);break;case es.TIMEOUT:y(wt,`RPC '${t}' ${s} timed out`),a(new _(g.DEADLINE_EXCEEDED,"Request time out"));break;case es.HTTP_ERROR:let h=u.getStatus();if(y(wt,`RPC '${t}' ${s} failed with status:`,h,"response text:",u.getResponseText()),h>0){let d=u.getResponseJson();Array.isArray(d)&&(d=d[0]);let m=d?.error;if(m&&m.status&&m.message){let A=function(v){let b=v.toLowerCase().replace(/_/g,"-");return Object.values(g).indexOf(b)>=0?b:g.UNKNOWN}(m.status);a(new _(A,m.message))}else a(new _(g.UNKNOWN,"Server responded with status "+u.getStatus()))}else a(new _(g.UNAVAILABLE,"Connection failed."));break;default:S()}}finally{y(wt,`RPC '${t}' ${s} completed.`)}});let c=JSON.stringify(i);y(wt,`RPC '${t}' ${s} sending request:`,i),u.send(e,"POST",c,r,15)})}xo(t,e,r){let i=Aa(),s=[this.yo,"/","google.firestore.v1.Firestore","/",t,"/channel"],o=sd(),a=od(),u={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;c!==void 0&&(u.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(u.xmlHttpFactory=new cd({})),this.vo(u.initMessageHeaders,e,r),u.encodeInitMessageHeaders=!0;let l=s.join("");y(wt,`Creating RPC '${t}' stream ${i}: ${l}`,u);let h=o.createWebChannel(l,u),d=!1,m=!1,A=new Ou({co:v=>{m?y(wt,`Not sending because RPC '${t}' stream ${i} is closed:`,v):(d||(y(wt,`Opening RPC '${t}' stream ${i} transport.`),h.open(),d=!0),y(wt,`RPC '${t}' stream ${i} sending:`,v),h.send(v))},lo:()=>h.close()}),w=(v,b,N)=>{v.listen(b,x=>{try{N(x)}catch(q){setTimeout(()=>{throw q},0)}})};return w(h,kr.EventType.OPEN,()=>{m||(y(wt,`RPC '${t}' stream ${i} transport opened.`),A.Vo())}),w(h,kr.EventType.CLOSE,()=>{m||(m=!0,y(wt,`RPC '${t}' stream ${i} transport closed`),A.fo())}),w(h,kr.EventType.ERROR,v=>{m||(m=!0,Nt(wt,`RPC '${t}' stream ${i} transport errored:`,v),A.fo(new _(g.UNAVAILABLE,"The operation could not be completed")))}),w(h,kr.EventType.MESSAGE,v=>{var b;if(!m){let N=v.data[0];R(!!N);let x=N,q=x.error||((b=x[0])===null||b===void 0?void 0:b.error);if(q){y(wt,`RPC '${t}' stream ${i} received error:`,q);let B=q.status,O=function(Kg){let _l=it[Kg];if(_l!==void 0)return Xf(_l)}(B),nt=q.message;O===void 0&&(O=g.INTERNAL,nt="Unknown error status: "+B+" with message "+q.message),m=!0,A.fo(new _(O,nt)),h.close()}else y(wt,`RPC '${t}' stream ${i} received:`,N),A.po(N)}}),w(a,ud.STAT_EVENT,v=>{v.stat===va.PROXY?y(wt,`RPC '${t}' stream ${i} detected buffering proxy`):v.stat===va.NOPROXY&&y(wt,`RPC '${t}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{A.mo()},0),A}};function Rm(){return typeof window<"u"?window:null}function ls(){return typeof document<"u"?document:null}function yi(n){return new nu(n,!0)}var ui=class{constructor(t,e,r=1e3,i=1.5,s=6e4){this.si=t,this.timerId=e,this.Oo=r,this.No=i,this.Lo=s,this.Bo=0,this.ko=null,this.qo=Date.now(),this.reset()}reset(){this.Bo=0}Qo(){this.Bo=this.Lo}Ko(t){this.cancel();let e=Math.floor(this.Bo+this.$o()),r=Math.max(0,Date.now()-this.qo),i=Math.max(0,e-r);i>0&&y("ExponentialBackoff",`Backing off for ${i} ms (base delay: ${this.Bo} ms, delay with jitter: ${e} ms, last attempt: ${r} ms ago)`),this.ko=this.si.enqueueAfterDelay(this.timerId,i,()=>(this.qo=Date.now(),t())),this.Bo*=this.No,this.Bo<this.Oo&&(this.Bo=this.Oo),this.Bo>this.Lo&&(this.Bo=this.Lo)}Uo(){this.ko!==null&&(this.ko.skipDelay(),this.ko=null)}cancel(){this.ko!==null&&(this.ko.cancel(),this.ko=null)}$o(){return(Math.random()-.5)*this.Bo}};var js=class{constructor(t,e,r,i,s,o,a,u){this.si=t,this.Wo=r,this.Go=i,this.connection=s,this.authCredentialsProvider=o,this.appCheckCredentialsProvider=a,this.listener=u,this.state=0,this.zo=0,this.jo=null,this.Ho=null,this.stream=null,this.Jo=new ui(t,e)}Yo(){return this.state===1||this.state===5||this.Zo()}Zo(){return this.state===2||this.state===3}start(){this.state!==4?this.auth():this.Xo()}stop(){return p(this,null,function*(){this.Yo()&&(yield this.close(0))})}e_(){this.state=0,this.Jo.reset()}t_(){this.Zo()&&this.jo===null&&(this.jo=this.si.enqueueAfterDelay(this.Wo,6e4,()=>this.n_()))}r_(t){this.i_(),this.stream.send(t)}n_(){return p(this,null,function*(){if(this.Zo())return this.close(0)})}i_(){this.jo&&(this.jo.cancel(),this.jo=null)}s_(){this.Ho&&(this.Ho.cancel(),this.Ho=null)}close(t,e){return p(this,null,function*(){this.i_(),this.s_(),this.Jo.cancel(),this.zo++,t!==4?this.Jo.reset():e&&e.code===g.RESOURCE_EXHAUSTED?(Z(e.toString()),Z("Using maximum backoff delay to prevent overloading the backend."),this.Jo.Qo()):e&&e.code===g.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.o_(),this.stream.close(),this.stream=null),this.state=t,yield this.listener.Eo(e)})}o_(){}auth(){this.state=1;let t=this.__(this.zo),e=this.zo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([r,i])=>{this.zo===e&&this.a_(r,i)},r=>{t(()=>{let i=new _(g.UNKNOWN,"Fetching auth token failed: "+r.message);return this.u_(i)})})}a_(t,e){let r=this.__(this.zo);this.stream=this.c_(t,e),this.stream.ho(()=>{r(()=>this.listener.ho())}),this.stream.Io(()=>{r(()=>(this.state=2,this.Ho=this.si.enqueueAfterDelay(this.Go,1e4,()=>(this.Zo()&&(this.state=3),Promise.resolve())),this.listener.Io()))}),this.stream.Eo(i=>{r(()=>this.u_(i))}),this.stream.onMessage(i=>{r(()=>this.onMessage(i))})}Xo(){this.state=5,this.Jo.Ko(()=>p(this,null,function*(){this.state=0,this.start()}))}u_(t){return y("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}__(t){return e=>{this.si.enqueueAndForget(()=>this.zo===t?e():(y("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}},Bu=class extends js{constructor(t,e,r,i,s,o){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,r,i,o),this.serializer=s}c_(t,e){return this.connection.xo("Listen",t,e)}onMessage(t){this.Jo.reset();let e=x_(this.serializer,t),r=function(s){if(!("targetChange"in s))return P.min();let o=s.targetChange;return o.targetIds&&o.targetIds.length?P.min():o.readTime?et(o.readTime):P.min()}(t);return this.listener.l_(e,r)}h_(t){let e={};e.database=su(this.serializer),e.addTarget=function(s,o){let a,u=o.target;if(a=Is(u)?{documents:om(s,u)}:{query:am(s,u)._t},a.targetId=o.targetId,o.resumeToken.approximateByteSize()>0){a.resumeToken=tm(s,o.resumeToken);let c=ru(s,o.expectedCount);c!==null&&(a.expectedCount=c)}else if(o.snapshotVersion.compareTo(P.min())>0){a.readTime=Un(s,o.snapshotVersion.toTimestamp());let c=ru(s,o.expectedCount);c!==null&&(a.expectedCount=c)}return a}(this.serializer,t);let r=C_(this.serializer,t);r&&(e.labels=r),this.r_(e)}P_(t){let e={};e.database=su(this.serializer),e.removeTarget=t,this.r_(e)}},Uu=class extends js{constructor(t,e,r,i,s,o){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,r,i,o),this.serializer=s,this.I_=!1}get T_(){return this.I_}start(){this.I_=!1,this.lastStreamToken=void 0,super.start()}o_(){this.I_&&this.E_([])}c_(t,e){return this.connection.xo("Write",t,e)}onMessage(t){if(R(!!t.streamToken),this.lastStreamToken=t.streamToken,this.I_){this.Jo.reset();let e=D_(t.writeResults,t.commitTime),r=et(t.commitTime);return this.listener.d_(r,e)}return R(!t.writeResults||t.writeResults.length===0),this.I_=!0,this.listener.A_()}R_(){let t={};t.database=su(this.serializer),this.r_(t)}E_(t){let e={streamToken:this.lastStreamToken,writes:t.map(r=>ii(this.serializer,r))};this.r_(e)}};var Gu=class extends class{}{constructor(t,e,r,i){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=r,this.serializer=i,this.V_=!1}m_(){if(this.V_)throw new _(g.FAILED_PRECONDITION,"The client has already been terminated.")}Do(t,e,r,i){return this.m_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,o])=>this.connection.Do(t,iu(e,r),i,s,o)).catch(s=>{throw s.name==="FirebaseError"?(s.code===g.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),s):new _(g.UNKNOWN,s.toString())})}Mo(t,e,r,i,s){return this.m_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([o,a])=>this.connection.Mo(t,iu(e,r),i,o,a,s)).catch(o=>{throw o.name==="FirebaseError"?(o.code===g.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),o):new _(g.UNKNOWN,o.toString())})}terminate(){this.V_=!0,this.connection.terminate()}};var zu=class{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.g_=0,this.p_=null,this.y_=!0}w_(){this.g_===0&&(this.S_("Unknown"),this.p_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.p_=null,this.b_("Backend didn't respond within 10 seconds."),this.S_("Offline"),Promise.resolve())))}D_(t){this.state==="Online"?this.S_("Unknown"):(this.g_++,this.g_>=1&&(this.C_(),this.b_(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.S_("Offline")))}set(t){this.C_(),this.g_=0,t==="Online"&&(this.y_=!1),this.S_(t)}S_(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}b_(t){let e=`Could not reach Cloud Firestore backend. ${t}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.y_?(Z(e),this.y_=!1):y("OnlineStateTracker",e)}C_(){this.p_!==null&&(this.p_.cancel(),this.p_=null)}};var ju=class{constructor(t,e,r,i,s){this.localStore=t,this.datastore=e,this.asyncQueue=r,this.remoteSyncer={},this.v_=[],this.F_=new Map,this.M_=new Set,this.x_=[],this.O_=s,this.O_.ro(o=>{r.enqueueAndForget(()=>p(this,null,function*(){Fe(this)&&(y("RemoteStore","Restarting streams for network reachability change."),yield function(u){return p(this,null,function*(){let c=E(u);c.M_.add(4),yield tr(c),c.N_.set("Unknown"),c.M_.delete(4),yield wi(c)})}(this))}))}),this.N_=new zu(r,i)}};function wi(n){return p(this,null,function*(){if(Fe(n))for(let t of n.x_)yield t(!0)})}function tr(n){return p(this,null,function*(){for(let t of n.x_)yield t(!1)})}function co(n,t){let e=E(n);e.F_.has(t.targetId)||(e.F_.set(t.targetId,t),Mc(e)?Fc(e):nr(e).Zo()&&kc(e,t))}function $n(n,t){let e=E(n),r=nr(e);e.F_.delete(t),r.Zo()&&Pm(e,t),e.F_.size===0&&(r.Zo()?r.t_():Fe(e)&&e.N_.set("Unknown"))}function kc(n,t){if(n.L_.xe(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(P.min())>0){let e=n.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(e)}nr(n).h_(t)}function Pm(n,t){n.L_.xe(t),nr(n).P_(t)}function Fc(n){n.L_=new eu({getRemoteKeysForTarget:t=>n.remoteSyncer.getRemoteKeysForTarget(t),ot:t=>n.F_.get(t)||null,tt:()=>n.datastore.serializer.databaseId}),nr(n).start(),n.N_.w_()}function Mc(n){return Fe(n)&&!nr(n).Yo()&&n.F_.size>0}function Fe(n){return E(n).M_.size===0}function bm(n){n.L_=void 0}function $_(n){return p(this,null,function*(){n.N_.set("Online")})}function Q_(n){return p(this,null,function*(){n.F_.forEach((t,e)=>{kc(n,t)})})}function W_(n,t){return p(this,null,function*(){bm(n),Mc(n)?(n.N_.D_(t),Fc(n)):n.N_.set("Unknown")})}function H_(n,t,e){return p(this,null,function*(){if(n.N_.set("Online"),t instanceof Ss&&t.state===2&&t.cause)try{yield function(i,s){return p(this,null,function*(){let o=s.cause;for(let a of s.targetIds)i.F_.has(a)&&(yield i.remoteSyncer.rejectListen(a,o),i.F_.delete(a),i.L_.removeTarget(a))})}(n,t)}catch(r){y("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),r),yield Ks(n,r)}else if(t instanceof kn?n.L_.Ke(t):t instanceof As?n.L_.He(t):n.L_.We(t),!e.isEqual(P.min()))try{let r=yield Im(n.localStore);e.compareTo(r)>=0&&(yield function(s,o){let a=s.L_.rt(o);return a.targetChanges.forEach((u,c)=>{if(u.resumeToken.approximateByteSize()>0){let l=s.F_.get(c);l&&s.F_.set(c,l.withResumeToken(u.resumeToken,o))}}),a.targetMismatches.forEach((u,c)=>{let l=s.F_.get(u);if(!l)return;s.F_.set(u,l.withResumeToken(dt.EMPTY_BYTE_STRING,l.snapshotVersion)),Pm(s,u);let h=new Gn(l.target,u,c,l.sequenceNumber);kc(s,h)}),s.remoteSyncer.applyRemoteEvent(a)}(n,e))}catch(r){y("RemoteStore","Failed to raise snapshot:",r),yield Ks(n,r)}})}function Ks(n,t,e){return p(this,null,function*(){if(!ke(t))throw t;n.M_.add(1),yield tr(n),n.N_.set("Offline"),e||(e=()=>Im(n.localStore)),n.asyncQueue.enqueueRetryable(()=>p(this,null,function*(){y("RemoteStore","Retrying IndexedDB access"),yield e(),n.M_.delete(1),yield wi(n)}))})}function xm(n,t){return t().catch(e=>Ks(n,e,t))}function er(n){return p(this,null,function*(){let t=E(n),e=Ve(t),r=t.v_.length>0?t.v_[t.v_.length-1].batchId:-1;for(;J_(t);)try{let i=yield G_(t.localStore,r);if(i===null){t.v_.length===0&&e.t_();break}r=i.batchId,Y_(t,i)}catch(i){yield Ks(t,i)}Dm(t)&&Cm(t)})}function J_(n){return Fe(n)&&n.v_.length<10}function Y_(n,t){n.v_.push(t);let e=Ve(n);e.Zo()&&e.T_&&e.E_(t.mutations)}function Dm(n){return Fe(n)&&!Ve(n).Yo()&&n.v_.length>0}function Cm(n){Ve(n).start()}function X_(n){return p(this,null,function*(){Ve(n).R_()})}function Z_(n){return p(this,null,function*(){let t=Ve(n);for(let e of n.v_)t.E_(e.mutations)})}function ty(n,t,e){return p(this,null,function*(){let r=n.v_.shift(),i=Xa.from(r,t,e);yield xm(n,()=>n.remoteSyncer.applySuccessfulWrite(i)),yield er(n)})}function ey(n,t){return p(this,null,function*(){t&&Ve(n).T_&&(yield function(r,i){return p(this,null,function*(){if(function(o){return Yf(o)&&o!==g.ABORTED}(i.code)){let s=r.v_.shift();Ve(r).e_(),yield xm(r,()=>r.remoteSyncer.rejectFailedWrite(s.batchId,i)),yield er(r)}})}(n,t)),Dm(n)&&Cm(n)})}function nf(n,t){return p(this,null,function*(){let e=E(n);e.asyncQueue.verifyOperationInProgress(),y("RemoteStore","RemoteStore received new credentials");let r=Fe(e);e.M_.add(3),yield tr(e),r&&e.N_.set("Unknown"),yield e.remoteSyncer.handleCredentialChange(t),e.M_.delete(3),yield wi(e)})}function Ku(n,t){return p(this,null,function*(){let e=E(n);t?(e.M_.delete(2),yield wi(e)):t||(e.M_.add(2),yield tr(e),e.N_.set("Unknown"))})}function nr(n){return n.B_||(n.B_=function(e,r,i){let s=E(e);return s.m_(),new Bu(r,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(n.datastore,n.asyncQueue,{ho:$_.bind(null,n),Io:Q_.bind(null,n),Eo:W_.bind(null,n),l_:H_.bind(null,n)}),n.x_.push(t=>p(this,null,function*(){t?(n.B_.e_(),Mc(n)?Fc(n):n.N_.set("Unknown")):(yield n.B_.stop(),bm(n))}))),n.B_}function Ve(n){return n.k_||(n.k_=function(e,r,i){let s=E(e);return s.m_(),new Uu(r,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(n.datastore,n.asyncQueue,{ho:()=>Promise.resolve(),Io:X_.bind(null,n),Eo:ey.bind(null,n),A_:Z_.bind(null,n),d_:ty.bind(null,n)}),n.x_.push(t=>p(this,null,function*(){t?(n.k_.e_(),yield er(n)):(yield n.k_.stop(),n.v_.length>0&&(y("RemoteStore",`Stopping write stream with ${n.v_.length} pending writes`),n.v_=[]))}))),n.k_}var $u=class n{constructor(t,e,r,i,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=r,this.op=i,this.removalCallback=s,this.deferred=new at,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(o=>{})}get promise(){return this.deferred.promise}static createAndSchedule(t,e,r,i,s){let o=Date.now()+r,a=new n(t,e,o,i,s);return a.start(r),a}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new _(g.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}};function rr(n,t){if(Z("AsyncQueue",`${t}: ${n}`),ke(n))return new _(g.UNAVAILABLE,`${t}: ${n}`);throw n}var $s=class n{constructor(t){this.comparator=t?(e,r)=>t(e,r)||I.comparator(e.key,r.key):(e,r)=>I.comparator(e.key,r.key),this.keyedMap=qr(),this.sortedSet=new $(this.comparator)}static emptySet(t){return new n(t.comparator)}has(t){return this.keyedMap.get(t)!=null}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){let e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal((e,r)=>(t(e),!1))}add(t){let e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){let e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof n)||this.size!==t.size)return!1;let e=this.sortedSet.getIterator(),r=t.sortedSet.getIterator();for(;e.hasNext();){let i=e.getNext().key,s=r.getNext().key;if(!i.isEqual(s))return!1}return!0}toString(){let t=[];return this.forEach(e=>{t.push(e.toString())}),t.length===0?"DocumentSet ()":`DocumentSet (
  `+t.join(`  
`)+`
)`}copy(t,e){let r=new n;return r.comparator=this.comparator,r.keyedMap=t,r.sortedSet=e,r}};var Qs=class{constructor(){this.q_=new $(I.comparator)}track(t){let e=t.doc.key,r=this.q_.get(e);r?t.type!==0&&r.type===3?this.q_=this.q_.insert(e,t):t.type===3&&r.type!==1?this.q_=this.q_.insert(e,{type:r.type,doc:t.doc}):t.type===2&&r.type===2?this.q_=this.q_.insert(e,{type:2,doc:t.doc}):t.type===2&&r.type===0?this.q_=this.q_.insert(e,{type:0,doc:t.doc}):t.type===1&&r.type===0?this.q_=this.q_.remove(e):t.type===1&&r.type===2?this.q_=this.q_.insert(e,{type:1,doc:r.doc}):t.type===0&&r.type===1?this.q_=this.q_.insert(e,{type:2,doc:t.doc}):S():this.q_=this.q_.insert(e,t)}Q_(){let t=[];return this.q_.inorderTraversal((e,r)=>{t.push(r)}),t}},Qn=class n{constructor(t,e,r,i,s,o,a,u,c){this.query=t,this.docs=e,this.oldDocs=r,this.docChanges=i,this.mutatedKeys=s,this.fromCache=o,this.syncStateChanged=a,this.excludesMetadataChanges=u,this.hasCachedResults=c}static fromInitialDocuments(t,e,r,i,s){let o=[];return e.forEach(a=>{o.push({type:0,doc:a})}),new n(t,e,$s.emptySet(e),o,r,i,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&pi(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;let e=this.docChanges,r=t.docChanges;if(e.length!==r.length)return!1;for(let i=0;i<e.length;i++)if(e[i].type!==r[i].type||!e[i].doc.isEqual(r[i].doc))return!1;return!0}};var Qu=class{constructor(){this.K_=void 0,this.U_=[]}W_(){return this.U_.some(t=>t.G_())}},Wu=class{constructor(){this.queries=new te(t=>Mf(t),pi),this.onlineState="Unknown",this.z_=new Set}};function Lc(n,t){return p(this,null,function*(){let e=E(n),r=3,i=t.query,s=e.queries.get(i);s?!s.W_()&&t.G_()&&(r=2):(s=new Qu,r=t.G_()?0:1);try{switch(r){case 0:s.K_=yield e.onListen(i,!0);break;case 1:s.K_=yield e.onListen(i,!1);break;case 2:yield e.onFirstRemoteStoreListen(i)}}catch(o){let a=rr(o,`Initialization of query '${Pn(t.query)}' failed`);return void t.onError(a)}e.queries.set(i,s),s.U_.push(t),t.j_(e.onlineState),s.K_&&t.H_(s.K_)&&qc(e)})}function Oc(n,t){return p(this,null,function*(){let e=E(n),r=t.query,i=3,s=e.queries.get(r);if(s){let o=s.U_.indexOf(t);o>=0&&(s.U_.splice(o,1),s.U_.length===0?i=t.G_()?0:1:!s.W_()&&t.G_()&&(i=2))}switch(i){case 0:return e.queries.delete(r),e.onUnlisten(r,!0);case 1:return e.queries.delete(r),e.onUnlisten(r,!1);case 2:return e.onLastRemoteStoreUnlisten(r);default:return}})}function ny(n,t){let e=E(n),r=!1;for(let i of t){let s=i.query,o=e.queries.get(s);if(o){for(let a of o.U_)a.H_(i)&&(r=!0);o.K_=i}}r&&qc(e)}function ry(n,t,e){let r=E(n),i=r.queries.get(t);if(i)for(let s of i.U_)s.onError(e);r.queries.delete(t)}function qc(n){n.z_.forEach(t=>{t.next()})}var Hu,rf;(rf=Hu||(Hu={})).J_="default",rf.Cache="cache";var ci=class{constructor(t,e,r){this.query=t,this.Y_=e,this.Z_=!1,this.X_=null,this.onlineState="Unknown",this.options=r||{}}H_(t){if(!this.options.includeMetadataChanges){let r=[];for(let i of t.docChanges)i.type!==3&&r.push(i);t=new Qn(t.query,t.docs,t.oldDocs,r,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.Z_?this.ea(t)&&(this.Y_.next(t),e=!0):this.ta(t,this.onlineState)&&(this.na(t),e=!0),this.X_=t,e}onError(t){this.Y_.error(t)}j_(t){this.onlineState=t;let e=!1;return this.X_&&!this.Z_&&this.ta(this.X_,t)&&(this.na(this.X_),e=!0),e}ta(t,e){if(!t.fromCache||!this.G_())return!0;let r=e!=="Offline";return(!this.options.ra||!r)&&(!t.docs.isEmpty()||t.hasCachedResults||e==="Offline")}ea(t){if(t.docChanges.length>0)return!0;let e=this.X_&&this.X_.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&this.options.includeMetadataChanges===!0}na(t){t=Qn.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.Z_=!0,this.Y_.next(t)}G_(){return this.options.source!==Hu.Cache}};var Ju=class{constructor(t,e){this.ia=t,this.byteLength=e}sa(){return"metadata"in this.ia}};var Ws=class{constructor(t){this.serializer=t}hs(t){return Jt(this.serializer,t)}Ps(t){return t.metadata.exists?sm(this.serializer,t.document,!1):ut.newNoDocument(this.hs(t.metadata.name),this.Is(t.metadata.readTime))}Is(t){return et(t)}},Yu=class{constructor(t,e,r){this.oa=t,this.localStore=e,this.serializer=r,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Vm(t)}_a(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;if(t.ia.namedQuery)this.queries.push(t.ia.namedQuery);else if(t.ia.documentMetadata){this.documents.push({metadata:t.ia.documentMetadata}),t.ia.documentMetadata.exists||++e;let r=M.fromString(t.ia.documentMetadata.name);this.collectionGroups.add(r.get(r.length-2))}else t.ia.document&&(this.documents[this.documents.length-1].document=t.ia.document,++e);return e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}aa(t){let e=new Map,r=new Ws(this.serializer);for(let i of t)if(i.metadata.queries){let s=r.hs(i.metadata.name);for(let o of i.metadata.queries){let a=(e.get(o)||V()).add(s);e.set(o,a)}}return e}complete(){return p(this,null,function*(){let t=yield z_(this.localStore,new Ws(this.serializer),this.documents,this.oa.id),e=this.aa(this.documents);for(let r of this.queries)yield j_(this.localStore,r,e.get(r.name));return this.progress.taskState="Success",{progress:this.progress,ua:this.collectionGroups,ca:t}})}};function Vm(n){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:n.totalDocuments,totalBytes:n.totalBytes}}var Hs=class{constructor(t){this.key=t}},Js=class{constructor(t){this.key=t}},Ys=class{constructor(t,e){this.query=t,this.la=e,this.ha=null,this.hasCachedResults=!1,this.current=!1,this.Pa=V(),this.mutatedKeys=V(),this.Ia=Of(t),this.Ta=new $s(this.Ia)}get Ea(){return this.la}da(t,e){let r=e?e.Aa:new Qs,i=e?e.Ta:this.Ta,s=e?e.mutatedKeys:this.mutatedKeys,o=i,a=!1,u=this.query.limitType==="F"&&i.size===this.query.limit?i.last():null,c=this.query.limitType==="L"&&i.size===this.query.limit?i.first():null;if(t.inorderTraversal((l,h)=>{let d=i.get(l),m=_i(this.query,h)?h:null,A=!!d&&this.mutatedKeys.has(d.key),w=!!m&&(m.hasLocalMutations||this.mutatedKeys.has(m.key)&&m.hasCommittedMutations),v=!1;d&&m?d.data.isEqual(m.data)?A!==w&&(r.track({type:3,doc:m}),v=!0):this.Ra(d,m)||(r.track({type:2,doc:m}),v=!0,(u&&this.Ia(m,u)>0||c&&this.Ia(m,c)<0)&&(a=!0)):!d&&m?(r.track({type:0,doc:m}),v=!0):d&&!m&&(r.track({type:1,doc:d}),v=!0,(u||c)&&(a=!0)),v&&(m?(o=o.add(m),s=w?s.add(l):s.delete(l)):(o=o.delete(l),s=s.delete(l)))}),this.query.limit!==null)for(;o.size>this.query.limit;){let l=this.query.limitType==="F"?o.last():o.first();o=o.delete(l.key),s=s.delete(l.key),r.track({type:1,doc:l})}return{Ta:o,Aa:r,Zi:a,mutatedKeys:s}}Ra(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,r,i){let s=this.Ta;this.Ta=t.Ta,this.mutatedKeys=t.mutatedKeys;let o=t.Aa.Q_();o.sort((l,h)=>function(m,A){let w=v=>{switch(v){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return S()}};return w(m)-w(A)}(l.type,h.type)||this.Ia(l.doc,h.doc)),this.Va(r),i=i!=null&&i;let a=e&&!i?this.ma():[],u=this.Pa.size===0&&this.current&&!i?1:0,c=u!==this.ha;return this.ha=u,o.length!==0||c?{snapshot:new Qn(this.query,t.Ta,s,o,t.mutatedKeys,u===0,c,!1,!!r&&r.resumeToken.approximateByteSize()>0),fa:a}:{fa:a}}j_(t){return this.current&&t==="Offline"?(this.current=!1,this.applyChanges({Ta:this.Ta,Aa:new Qs,mutatedKeys:this.mutatedKeys,Zi:!1},!1)):{fa:[]}}ga(t){return!this.la.has(t)&&!!this.Ta.has(t)&&!this.Ta.get(t).hasLocalMutations}Va(t){t&&(t.addedDocuments.forEach(e=>this.la=this.la.add(e)),t.modifiedDocuments.forEach(e=>{}),t.removedDocuments.forEach(e=>this.la=this.la.delete(e)),this.current=t.current)}ma(){if(!this.current)return[];let t=this.Pa;this.Pa=V(),this.Ta.forEach(r=>{this.ga(r.key)&&(this.Pa=this.Pa.add(r.key))});let e=[];return t.forEach(r=>{this.Pa.has(r)||e.push(new Js(r))}),this.Pa.forEach(r=>{t.has(r)||e.push(new Hs(r))}),e}pa(t){this.la=t.ls,this.Pa=V();let e=this.da(t.documents);return this.applyChanges(e,!0)}ya(){return Qn.fromInitialDocuments(this.query,this.Ta,this.mutatedKeys,this.ha===0,this.hasCachedResults)}},Xu=class{constructor(t,e,r){this.query=t,this.targetId=e,this.view=r}},Zu=class{constructor(t){this.key=t,this.wa=!1}},tc=class{constructor(t,e,r,i,s,o){this.localStore=t,this.remoteStore=e,this.eventManager=r,this.sharedClientState=i,this.currentUser=s,this.maxConcurrentLimboResolutions=o,this.Sa={},this.ba=new te(a=>Mf(a),pi),this.Da=new Map,this.Ca=new Set,this.va=new $(I.comparator),this.Fa=new Map,this.Ma=new oi,this.xa={},this.Oa=new Map,this.Na=zn.Nn(),this.onlineState="Unknown",this.La=void 0}get isPrimaryClient(){return this.La===!0}};function iy(n,t,e=!0){return p(this,null,function*(){let r=lo(n),i,s=r.ba.get(t);return s?(r.sharedClientState.addLocalQueryTarget(s.targetId),i=s.view.ya()):i=yield Nm(r,t,e,!0),i})}function sy(n,t){return p(this,null,function*(){let e=lo(n);yield Nm(e,t,!0,!1)})}function Nm(n,t,e,r){return p(this,null,function*(){let i=yield jn(n.localStore,Tt(t)),s=i.targetId,o=e?n.sharedClientState.addLocalQueryTarget(s):"not-current",a;return r&&(a=yield Bc(n,t,s,o==="current",i.resumeToken)),n.isPrimaryClient&&e&&co(n.remoteStore,i),a})}function Bc(n,t,e,r,i){return p(this,null,function*(){n.Ba=(h,d,m)=>function(w,v,b,N){return p(this,null,function*(){let x=v.view.da(b);x.Zi&&(x=yield qs(w.localStore,v.query,!1).then(({documents:nt})=>v.view.da(nt,x)));let q=N&&N.targetChanges.get(v.targetId),B=N&&N.targetMismatches.get(v.targetId)!=null,O=v.view.applyChanges(x,w.isPrimaryClient,q,B);return ec(w,v.targetId,O.fa),O.snapshot})}(n,h,d,m);let s=yield qs(n.localStore,t,!0),o=new Ys(t,s.ls),a=o.da(s.documents),u=ni.createSynthesizedTargetChangeForCurrentChange(e,r&&n.onlineState!=="Offline",i),c=o.applyChanges(a,n.isPrimaryClient,u);ec(n,e,c.fa);let l=new Xu(t,e,o);return n.ba.set(t,l),n.Da.has(e)?n.Da.get(e).push(t):n.Da.set(e,[t]),c.snapshot})}function oy(n,t,e){return p(this,null,function*(){let r=E(n),i=r.ba.get(t),s=r.Da.get(i.targetId);if(s.length>1)return r.Da.set(i.targetId,s.filter(o=>!pi(o,t))),void r.ba.delete(t);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(i.targetId),r.sharedClientState.isActiveQueryTarget(i.targetId)||(yield Kn(r.localStore,i.targetId,!1).then(()=>{r.sharedClientState.clearQueryState(i.targetId),e&&$n(r.remoteStore,i.targetId),Wn(r,i.targetId)}).catch(Ne))):(Wn(r,i.targetId),yield Kn(r.localStore,i.targetId,!0))})}function ay(n,t){return p(this,null,function*(){let e=E(n),r=e.ba.get(t),i=e.Da.get(r.targetId);e.isPrimaryClient&&i.length===1&&(e.sharedClientState.removeLocalQueryTarget(r.targetId),$n(e.remoteStore,r.targetId))})}function uy(n,t,e){return p(this,null,function*(){let r=jc(n);try{let i=yield function(o,a){let u=E(o),c=W.now(),l=a.reduce((m,A)=>m.add(A.key),V()),h,d;return u.persistence.runTransaction("Locally write mutations","readwrite",m=>{let A=St(),w=V();return u.ss.getEntries(m,l).next(v=>{A=v,A.forEach((b,N)=>{N.isValidDocument()||(w=w.add(b))})}).next(()=>u.localDocuments.getOverlayedDocuments(m,A)).next(v=>{h=v;let b=[];for(let N of a){let x=E_(N,h.get(N.key).overlayedDocument);x!=null&&b.push(new qt(N.key,x,xf(x.value.mapValue),X.exists(!0)))}return u.mutationQueue.addMutationBatch(m,c,b,a)}).next(v=>{d=v;let b=v.applyToLocalDocumentSet(h,w);return u.documentOverlayCache.saveOverlays(m,v.batchId,b)})}).then(()=>({batchId:d.batchId,changes:Bf(h)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(i.batchId),function(o,a,u){let c=o.xa[o.currentUser.toKey()];c||(c=new $(C)),c=c.insert(a,u),o.xa[o.currentUser.toKey()]=c}(r,i.batchId,e),yield fe(r,i.changes),yield er(r.remoteStore)}catch(i){let s=rr(i,"Failed to persist write");e.reject(s)}})}function km(n,t){return p(this,null,function*(){let e=E(n);try{let r=yield U_(e.localStore,t);t.targetChanges.forEach((i,s)=>{let o=e.Fa.get(s);o&&(R(i.addedDocuments.size+i.modifiedDocuments.size+i.removedDocuments.size<=1),i.addedDocuments.size>0?o.wa=!0:i.modifiedDocuments.size>0?R(o.wa):i.removedDocuments.size>0&&(R(o.wa),o.wa=!1))}),yield fe(e,r,t)}catch(r){yield Ne(r)}})}function sf(n,t,e){let r=E(n);if(r.isPrimaryClient&&e===0||!r.isPrimaryClient&&e===1){let i=[];r.ba.forEach((s,o)=>{let a=o.view.j_(t);a.snapshot&&i.push(a.snapshot)}),function(o,a){let u=E(o);u.onlineState=a;let c=!1;u.queries.forEach((l,h)=>{for(let d of h.U_)d.j_(a)&&(c=!0)}),c&&qc(u)}(r.eventManager,t),i.length&&r.Sa.l_(i),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}function cy(n,t,e){return p(this,null,function*(){let r=E(n);r.sharedClientState.updateQueryState(t,"rejected",e);let i=r.Fa.get(t),s=i&&i.key;if(s){let o=new $(I.comparator);o=o.insert(s,ut.newNoDocument(s,P.min()));let a=V().add(s),u=new ei(P.min(),new Map,new $(C),o,a);yield km(r,u),r.va=r.va.remove(s),r.Fa.delete(t),zc(r)}else yield Kn(r.localStore,t,!1).then(()=>Wn(r,t,e)).catch(Ne)})}function ly(n,t){return p(this,null,function*(){let e=E(n),r=t.batch.batchId;try{let i=yield B_(e.localStore,t);Gc(e,r,null),Uc(e,r),e.sharedClientState.updateMutationState(r,"acknowledged"),yield fe(e,i)}catch(i){yield Ne(i)}})}function hy(n,t,e){return p(this,null,function*(){let r=E(n);try{let i=yield function(o,a){let u=E(o);return u.persistence.runTransaction("Reject batch","readwrite-primary",c=>{let l;return u.mutationQueue.lookupMutationBatch(c,a).next(h=>(R(h!==null),l=h.keys(),u.mutationQueue.removeMutationBatch(c,h))).next(()=>u.mutationQueue.performConsistencyCheck(c)).next(()=>u.documentOverlayCache.removeOverlaysForBatchId(c,l,a)).next(()=>u.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(c,l)).next(()=>u.localDocuments.getDocuments(c,l))})}(r.localStore,t);Gc(r,t,e),Uc(r,t),r.sharedClientState.updateMutationState(t,"rejected",e),yield fe(r,i)}catch(i){yield Ne(i)}})}function dy(n,t){return p(this,null,function*(){let e=E(n);Fe(e.remoteStore)||y("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{let r=yield function(o){let a=E(o);return a.persistence.runTransaction("Get highest unacknowledged batch id","readonly",u=>a.mutationQueue.getHighestUnacknowledgedBatchId(u))}(e.localStore);if(r===-1)return void t.resolve();let i=e.Oa.get(r)||[];i.push(t),e.Oa.set(r,i)}catch(r){let i=rr(r,"Initialization of waitForPendingWrites() operation failed");t.reject(i)}})}function Uc(n,t){(n.Oa.get(t)||[]).forEach(e=>{e.resolve()}),n.Oa.delete(t)}function Gc(n,t,e){let r=E(n),i=r.xa[r.currentUser.toKey()];if(i){let s=i.get(t);s&&(e?s.reject(e):s.resolve(),i=i.remove(t)),r.xa[r.currentUser.toKey()]=i}}function Wn(n,t,e=null){n.sharedClientState.removeLocalQueryTarget(t);for(let r of n.Da.get(t))n.ba.delete(r),e&&n.Sa.ka(r,e);n.Da.delete(t),n.isPrimaryClient&&n.Ma.Rr(t).forEach(r=>{n.Ma.containsKey(r)||Fm(n,r)})}function Fm(n,t){n.Ca.delete(t.path.canonicalString());let e=n.va.get(t);e!==null&&($n(n.remoteStore,e),n.va=n.va.remove(t),n.Fa.delete(e),zc(n))}function ec(n,t,e){for(let r of e)r instanceof Hs?(n.Ma.addReference(r.key,t),fy(n,r)):r instanceof Js?(y("SyncEngine","Document no longer in limbo: "+r.key),n.Ma.removeReference(r.key,t),n.Ma.containsKey(r.key)||Fm(n,r.key)):S()}function fy(n,t){let e=t.key,r=e.path.canonicalString();n.va.get(e)||n.Ca.has(r)||(y("SyncEngine","New document in limbo: "+e),n.Ca.add(r),zc(n))}function zc(n){for(;n.Ca.size>0&&n.va.size<n.maxConcurrentLimboResolutions;){let t=n.Ca.values().next().value;n.Ca.delete(t);let e=new I(M.fromString(t)),r=n.Na.next();n.Fa.set(r,new Zu(e)),n.va=n.va.insert(e,r),co(n.remoteStore,new Gn(Tt(Zn(e.path)),r,"TargetPurposeLimboResolution",bt.oe))}}function fe(n,t,e){return p(this,null,function*(){let r=E(n),i=[],s=[],o=[];r.ba.isEmpty()||(r.ba.forEach((a,u)=>{o.push(r.Ba(u,t,e).then(c=>{if((c||e)&&r.isPrimaryClient&&r.sharedClientState.updateQueryState(u.targetId,c?.fromCache?"not-current":"current"),c){i.push(c);let l=Nu.Qi(u.targetId,c);s.push(l)}}))}),yield Promise.all(o),r.Sa.l_(i),yield function(u,c){return p(this,null,function*(){let l=E(u);try{yield l.persistence.runTransaction("notifyLocalViewChanges","readwrite",h=>f.forEach(c,d=>f.forEach(d.ki,m=>l.persistence.referenceDelegate.addReference(h,d.targetId,m)).next(()=>f.forEach(d.qi,m=>l.persistence.referenceDelegate.removeReference(h,d.targetId,m)))))}catch(h){if(!ke(h))throw h;y("LocalStore","Failed to update sequence numbers: "+h)}for(let h of c){let d=h.targetId;if(!h.fromCache){let m=l.ts.get(d),A=m.snapshotVersion,w=m.withLastLimboFreeSnapshotVersion(A);l.ts=l.ts.insert(d,w)}}})}(r.localStore,s))})}function my(n,t){return p(this,null,function*(){let e=E(n);if(!e.currentUser.isEqual(t)){y("SyncEngine","User change. New user:",t.toKey());let r=yield vm(e.localStore,t);e.currentUser=t,function(s,o){s.Oa.forEach(a=>{a.forEach(u=>{u.reject(new _(g.CANCELLED,o))})}),s.Oa.clear()}(e,"'waitForPendingWrites' promise is rejected due to a user change."),e.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),yield fe(e,r._s)}})}function gy(n,t){let e=E(n),r=e.Fa.get(t);if(r&&r.wa)return V().add(r.key);{let i=V(),s=e.Da.get(t);if(!s)return i;for(let o of s){let a=e.ba.get(o);i=i.unionWith(a.view.Ea)}return i}}function py(n,t){return p(this,null,function*(){let e=E(n),r=yield qs(e.localStore,t.query,!0),i=t.view.pa(r);return e.isPrimaryClient&&ec(e,t.targetId,i.fa),i})}function _y(n,t){return p(this,null,function*(){let e=E(n);return Am(e.localStore,t).then(r=>fe(e,r))})}function yy(n,t,e,r){return p(this,null,function*(){let i=E(n),s=yield function(a,u){let c=E(a),l=E(c.mutationQueue);return c.persistence.runTransaction("Lookup mutation documents","readonly",h=>l.Cn(h,u).next(d=>d?c.localDocuments.getDocuments(h,d):f.resolve(null)))}(i.localStore,t);s!==null?(e==="pending"?yield er(i.remoteStore):e==="acknowledged"||e==="rejected"?(Gc(i,t,r||null),Uc(i,t),function(a,u){E(E(a).mutationQueue).Fn(u)}(i.localStore,t)):S(),yield fe(i,s)):y("SyncEngine","Cannot apply mutation batch with id: "+t)})}function wy(n,t){return p(this,null,function*(){let e=E(n);if(lo(e),jc(e),t===!0&&e.La!==!0){let r=e.sharedClientState.getAllActiveQueryTargets(),i=yield of(e,r.toArray());e.La=!0,yield Ku(e.remoteStore,!0);for(let s of i)co(e.remoteStore,s)}else if(t===!1&&e.La!==!1){let r=[],i=Promise.resolve();e.Da.forEach((s,o)=>{e.sharedClientState.isLocalQueryTarget(o)?r.push(o):i=i.then(()=>(Wn(e,o),Kn(e.localStore,o,!0))),$n(e.remoteStore,o)}),yield i,yield of(e,r),function(o){let a=E(o);a.Fa.forEach((u,c)=>{$n(a.remoteStore,c)}),a.Ma.Vr(),a.Fa=new Map,a.va=new $(I.comparator)}(e),e.La=!1,yield Ku(e.remoteStore,!1)}})}function of(n,t,e){return p(this,null,function*(){let r=E(n),i=[],s=[];for(let o of t){let a,u=r.Da.get(o);if(u&&u.length!==0){a=yield jn(r.localStore,Tt(u[0]));for(let c of u){let l=r.ba.get(c),h=yield py(r,l);h.snapshot&&s.push(h.snapshot)}}else{let c=yield Tm(r.localStore,o);a=yield jn(r.localStore,c),yield Bc(r,Mm(c),o,!1,a.resumeToken)}i.push(a)}return r.Sa.l_(s),i})}function Mm(n){return Ff(n.path,n.collectionGroup,n.orderBy,n.filters,n.limit,"F",n.startAt,n.endAt)}function vy(n){return function(e){return E(E(e).persistence).Li()}(E(n).localStore)}function Iy(n,t,e,r){return p(this,null,function*(){let i=E(n);if(i.La)return void y("SyncEngine","Ignoring unexpected query state notification.");let s=i.Da.get(t);if(s&&s.length>0)switch(e){case"current":case"not-current":{let o=yield Am(i.localStore,Lf(s[0])),a=ei.createSynthesizedRemoteEventForCurrentChange(t,e==="current",dt.EMPTY_BYTE_STRING);yield fe(i,o,a);break}case"rejected":yield Kn(i.localStore,t,!0),Wn(i,t,r);break;default:S()}})}function Ey(n,t,e){return p(this,null,function*(){let r=lo(n);if(r.La){for(let i of t){if(r.Da.has(i)&&r.sharedClientState.isActiveQueryTarget(i)){y("SyncEngine","Adding an already active target "+i);continue}let s=yield Tm(r.localStore,i),o=yield jn(r.localStore,s);yield Bc(r,Mm(s),o.targetId,!1,o.resumeToken),co(r.remoteStore,o)}for(let i of e)r.Da.has(i)&&(yield Kn(r.localStore,i,!1).then(()=>{$n(r.remoteStore,i),Wn(r,i)}).catch(Ne))}})}function lo(n){let t=E(n);return t.remoteStore.remoteSyncer.applyRemoteEvent=km.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=gy.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=cy.bind(null,t),t.Sa.l_=ny.bind(null,t.eventManager),t.Sa.ka=ry.bind(null,t.eventManager),t}function jc(n){let t=E(n);return t.remoteStore.remoteSyncer.applySuccessfulWrite=ly.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=hy.bind(null,t),t}function Ty(n,t,e){let r=E(n);(function(s,o,a){return p(this,null,function*(){try{let u=yield o.getMetadata();if(yield function(m,A){let w=E(m),v=et(A.createTime);return w.persistence.runTransaction("hasNewerBundle","readonly",b=>w.Kr.getBundleMetadata(b,A.id)).then(b=>!!b&&b.createTime.compareTo(v)>=0)}(s.localStore,u))return yield o.close(),a._completeWith(function(m){return{taskState:"Success",documentsLoaded:m.totalDocuments,bytesLoaded:m.totalBytes,totalDocuments:m.totalDocuments,totalBytes:m.totalBytes}}(u)),Promise.resolve(new Set);a._updateProgress(Vm(u));let c=new Yu(u,s.localStore,o.serializer),l=yield o.qa();for(;l;){let d=yield c._a(l);d&&a._updateProgress(d),l=yield o.qa()}let h=yield c.complete();return yield fe(s,h.ca,void 0),yield function(m,A){let w=E(m);return w.persistence.runTransaction("Save bundle","readwrite",v=>w.Kr.saveBundleMetadata(v,A))}(s.localStore,u),a._completeWith(h.progress),Promise.resolve(h.ua)}catch(u){return Nt("SyncEngine",`Loading bundle failed with ${u}`),a._failWith(u),Promise.resolve(new Set)}})})(r,t,e).then(i=>{r.sharedClientState.notifyBundleLoaded(i)})}var li=class{constructor(){this.synchronizeTabs=!1}initialize(t){return p(this,null,function*(){this.serializer=yi(t.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(t),this.persistence=this.createPersistence(t),yield this.persistence.start(),this.localStore=this.createLocalStore(t),this.gcScheduler=this.createGarbageCollectionScheduler(t,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(t,this.localStore)})}createGarbageCollectionScheduler(t,e){return null}createIndexBackfillerScheduler(t,e){return null}createLocalStore(t){return wm(this.persistence,new Os,t.initialUser,this.serializer)}createPersistence(t){return new Ms(Ls.jr,this.serializer)}createSharedClientState(t){return new Gs}terminate(){return p(this,null,function*(){var t,e;(t=this.gcScheduler)===null||t===void 0||t.stop(),(e=this.indexBackfillerScheduler)===null||e===void 0||e.stop(),this.sharedClientState.shutdown(),yield this.persistence.shutdown()})}};var Xs=class n extends li{constructor(t,e,r){super(),this.Qa=t,this.cacheSizeBytes=e,this.forceOwnership=r,this.synchronizeTabs=!1}initialize(t){return p(this,null,function*(){yield Ao(n.prototype,this,"initialize").call(this,t),yield this.Qa.initialize(this,t),yield jc(this.Qa.syncEngine),yield er(this.Qa.remoteStore),yield this.persistence.mi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))})}createLocalStore(t){return wm(this.persistence,new Os,t.initialUser,this.serializer)}createGarbageCollectionScheduler(t,e){let r=this.persistence.referenceDelegate.garbageCollector;return new yu(r,t.asyncQueue,e)}createIndexBackfillerScheduler(t,e){let r=new Ma(e,this.persistence);return new Fa(t.asyncQueue,r)}createPersistence(t){let e=Nc(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),r=this.cacheSizeBytes!==void 0?Vt.withCacheSize(this.cacheSizeBytes):Vt.DEFAULT;return new Vu(this.synchronizeTabs,e,t.clientId,r,t.asyncQueue,Rm(),ls(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(t){return new Gs}},nc=class n extends Xs{constructor(t,e){super(t,e,!1),this.Qa=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}initialize(t){return p(this,null,function*(){yield Ao(n.prototype,this,"initialize").call(this,t);let e=this.Qa.syncEngine;this.sharedClientState instanceof Kr&&(this.sharedClientState.syncEngine={Ys:yy.bind(null,e),Zs:Iy.bind(null,e),Xs:Ey.bind(null,e),Li:vy.bind(null,e),Js:_y.bind(null,e)},yield this.sharedClientState.start()),yield this.persistence.mi(r=>p(this,null,function*(){yield wy(this.Qa.syncEngine,r),this.gcScheduler&&(r&&!this.gcScheduler.started?this.gcScheduler.start():r||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(r&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():r||this.indexBackfillerScheduler.stop())}))})}createSharedClientState(t){let e=Rm();if(!Kr.D(e))throw new _(g.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let r=Nc(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new Kr(e,t.asyncQueue,r,t.clientId,t.initialUser)}},hi=class{initialize(t,e){return p(this,null,function*(){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=r=>sf(this.syncEngine,r,1),this.remoteStore.remoteSyncer.handleCredentialChange=my.bind(null,this.syncEngine),yield Ku(this.remoteStore,this.syncEngine.isPrimaryClient))})}createEventManager(t){return function(){return new Wu}()}createDatastore(t){let e=yi(t.databaseInfo.databaseId),r=function(s){return new qu(s)}(t.databaseInfo);return function(s,o,a,u){return new Gu(s,o,a,u)}(t.authCredentials,t.appCheckCredentials,r,e)}createRemoteStore(t){return function(r,i,s,o,a){return new ju(r,i,s,o,a)}(this.localStore,this.datastore,t.asyncQueue,e=>sf(this.syncEngine,e,0),function(){return zs.D()?new zs:new Lu}())}createSyncEngine(t,e){return function(i,s,o,a,u,c,l){let h=new tc(i,s,o,a,u,c);return l&&(h.La=!0),h}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return p(this,null,function*(){var t;yield function(r){return p(this,null,function*(){let i=E(r);y("RemoteStore","RemoteStore shutting down."),i.M_.add(5),yield tr(i),i.O_.shutdown(),i.N_.set("Unknown")})}(this.remoteStore),(t=this.datastore)===null||t===void 0||t.terminate()})}};function af(n,t=10240){let e=0;return{read(){return p(this,null,function*(){if(e<n.byteLength){let i={value:n.slice(e,e+t),done:!1};return e+=t,i}return{done:!0}})},cancel(){return p(this,null,function*(){})},releaseLock(){},closed:Promise.resolve()}}var Hn=class{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.Ka(this.observer.next,t)}error(t){this.observer.error?this.Ka(this.observer.error,t):Z("Uncaught Error in snapshot listener:",t.toString())}$a(){this.muted=!0}Ka(t,e){this.muted||setTimeout(()=>{this.muted||t(e)},0)}};var rc=class{constructor(t,e){this.Ua=t,this.serializer=e,this.metadata=new at,this.buffer=new Uint8Array,this.Wa=function(){return new TextDecoder("utf-8")}(),this.Ga().then(r=>{r&&r.sa()?this.metadata.resolve(r.ia.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(r?.ia)}`))},r=>this.metadata.reject(r))}close(){return this.Ua.cancel()}getMetadata(){return p(this,null,function*(){return this.metadata.promise})}qa(){return p(this,null,function*(){return yield this.getMetadata(),this.Ga()})}Ga(){return p(this,null,function*(){let t=yield this.za();if(t===null)return null;let e=this.Wa.decode(t),r=Number(e);isNaN(r)&&this.ja(`length string (${e}) is not valid number`);let i=yield this.Ha(r);return new Ju(JSON.parse(i),t.length+r)})}Ja(){return this.buffer.findIndex(t=>t===123)}za(){return p(this,null,function*(){for(;this.Ja()<0&&!(yield this.Ya()););if(this.buffer.length===0)return null;let t=this.Ja();t<0&&this.ja("Reached the end of bundle when a length string is expected.");let e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e})}Ha(t){return p(this,null,function*(){for(;this.buffer.length<t;)(yield this.Ya())&&this.ja("Reached the end of bundle when more is expected.");let e=this.Wa.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e})}ja(t){throw this.Ua.cancel(),new Error(`Invalid bundle format: ${t}`)}Ya(){return p(this,null,function*(){let t=yield this.Ua.read();if(!t.done){let e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done})}};var ic=class{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}lookup(t){return p(this,null,function*(){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new _(g.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let e=yield function(i,s){return p(this,null,function*(){let o=E(i),a={documents:s.map(h=>ri(o.serializer,h))},u=yield o.Mo("BatchGetDocuments",o.serializer.databaseId,M.emptyPath(),a,s.length),c=new Map;u.forEach(h=>{let d=b_(o.serializer,h);c.set(d.key.toString(),d)});let l=[];return s.forEach(h=>{let d=c.get(h.toString());R(!!d),l.push(d)}),l})}(this.datastore,t);return e.forEach(r=>this.recordVersion(r)),e})}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(r){this.lastTransactionError=r}this.writtenDocs.add(t.toString())}delete(t){this.write(new Ce(t,this.precondition(t))),this.writtenDocs.add(t.toString())}commit(){return p(this,null,function*(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,r)=>{let i=I.fromPath(r);this.mutations.push(new Xr(i,this.precondition(i)))}),yield function(r,i){return p(this,null,function*(){let s=E(r),o={writes:i.map(a=>ii(s.serializer,a))};yield s.Do("Commit",s.serializer.databaseId,M.emptyPath(),o)})}(this.datastore,this.mutations),this.committed=!0})}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw S();e=P.min()}let r=this.readVersions.get(t.key.toString());if(r){if(!e.isEqual(r))throw new _(g.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){let e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?e.isEqual(P.min())?X.exists(!1):X.updateTime(e):X.none()}preconditionForUpdate(t){let e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(P.min()))throw new _(g.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return X.updateTime(e)}return X.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}};var sc=class{constructor(t,e,r,i,s){this.asyncQueue=t,this.datastore=e,this.options=r,this.updateFunction=i,this.deferred=s,this.Za=r.maxAttempts,this.Jo=new ui(this.asyncQueue,"transaction_retry")}Xa(){this.Za-=1,this.eu()}eu(){this.Jo.Ko(()=>p(this,null,function*(){let t=new ic(this.datastore),e=this.tu(t);e&&e.then(r=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(r)}).catch(i=>{this.nu(i)}))}).catch(r=>{this.nu(r)})}))}tu(t){try{let e=this.updateFunction(t);return!mi(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}nu(t){this.Za>0&&this.ru(t)?(this.Za-=1,this.asyncQueue.enqueueAndForget(()=>(this.eu(),Promise.resolve()))):this.deferred.reject(t)}ru(t){if(t.name==="FirebaseError"){let e=t.code;return e==="aborted"||e==="failed-precondition"||e==="already-exists"||!Yf(e)}return!1}};var oc=class{constructor(t,e,r,i){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=r,this.databaseInfo=i,this.user=ot.UNAUTHENTICATED,this.clientId=fs.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(r,s=>p(this,null,function*(){y("FirestoreClient","Received user=",s.uid),yield this.authCredentialListener(s),this.user=s})),this.appCheckCredentials.start(r,s=>(y("FirestoreClient","Received new app check token=",s),this.appCheckCredentialListener(s,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new _(g.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();let t=new at;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(()=>p(this,null,function*(){try{this._onlineComponents&&(yield this._onlineComponents.terminate()),this._offlineComponents&&(yield this._offlineComponents.terminate()),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){let r=rr(e,"Failed to shutdown persistence");t.reject(r)}})),t.promise}};function hs(n,t){return p(this,null,function*(){n.asyncQueue.verifyOperationInProgress(),y("FirestoreClient","Initializing OfflineComponentProvider");let e=n.configuration;yield t.initialize(e);let r=e.initialUser;n.setCredentialChangeListener(i=>p(this,null,function*(){r.isEqual(i)||(yield vm(t.localStore,i),r=i)})),t.persistence.setDatabaseDeletedListener(()=>n.terminate()),n._offlineComponents=t})}function ac(n,t){return p(this,null,function*(){n.asyncQueue.verifyOperationInProgress();let e=yield Kc(n);y("FirestoreClient","Initializing OnlineComponentProvider"),yield t.initialize(e,n.configuration),n.setCredentialChangeListener(r=>nf(t.remoteStore,r)),n.setAppCheckTokenChangeListener((r,i)=>nf(t.remoteStore,i)),n._onlineComponents=t})}function Lm(n){return n.name==="FirebaseError"?n.code===g.FAILED_PRECONDITION||n.code===g.UNIMPLEMENTED:!(typeof DOMException<"u"&&n instanceof DOMException)||n.code===22||n.code===20||n.code===11}function Kc(n){return p(this,null,function*(){if(!n._offlineComponents)if(n._uninitializedComponentsProvider){y("FirestoreClient","Using user provided OfflineComponentProvider");try{yield hs(n,n._uninitializedComponentsProvider._offline)}catch(t){let e=t;if(!Lm(e))throw e;Nt("Error using user provided cache. Falling back to memory cache: "+e),yield hs(n,new li)}}else y("FirestoreClient","Using default OfflineComponentProvider"),yield hs(n,new li);return n._offlineComponents})}function ho(n){return p(this,null,function*(){return n._onlineComponents||(n._uninitializedComponentsProvider?(y("FirestoreClient","Using user provided OnlineComponentProvider"),yield ac(n,n._uninitializedComponentsProvider._online)):(y("FirestoreClient","Using default OnlineComponentProvider"),yield ac(n,new hi))),n._onlineComponents})}function Om(n){return Kc(n).then(t=>t.persistence)}function $c(n){return Kc(n).then(t=>t.localStore)}function qm(n){return ho(n).then(t=>t.remoteStore)}function Qc(n){return ho(n).then(t=>t.syncEngine)}function Ay(n){return ho(n).then(t=>t.datastore)}function Jn(n){return p(this,null,function*(){let t=yield ho(n),e=t.eventManager;return e.onListen=iy.bind(null,t.syncEngine),e.onUnlisten=oy.bind(null,t.syncEngine),e.onFirstRemoteStoreListen=sy.bind(null,t.syncEngine),e.onLastRemoteStoreUnlisten=ay.bind(null,t.syncEngine),e})}function Sy(n){return n.asyncQueue.enqueue(()=>p(this,null,function*(){let t=yield Om(n),e=yield qm(n);return t.setNetworkEnabled(!0),function(i){let s=E(i);return s.M_.delete(0),wi(s)}(e)}))}function Ry(n){return n.asyncQueue.enqueue(()=>p(this,null,function*(){let t=yield Om(n),e=yield qm(n);return t.setNetworkEnabled(!1),function(i){return p(this,null,function*(){let s=E(i);s.M_.add(0),yield tr(s),s.N_.set("Offline")})}(e)}))}function Py(n,t){let e=new at;return n.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return function(i,s,o){return p(this,null,function*(){try{let a=yield function(c,l){let h=E(c);return h.persistence.runTransaction("read document","readonly",d=>h.localDocuments.getDocument(d,l))}(i,s);a.isFoundDocument()?o.resolve(a):a.isNoDocument()?o.resolve(null):o.reject(new _(g.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(a){let u=rr(a,`Failed to get document '${s} from cache`);o.reject(u)}})}(yield $c(n),t,e)})),e.promise}function Bm(n,t,e={}){let r=new at;return n.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return function(s,o,a,u,c){let l=new Hn({next:d=>{o.enqueueAndForget(()=>Oc(s,h));let m=d.docs.has(a);!m&&d.fromCache?c.reject(new _(g.UNAVAILABLE,"Failed to get document because the client is offline.")):m&&d.fromCache&&u&&u.source==="server"?c.reject(new _(g.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):c.resolve(d)},error:d=>c.reject(d)}),h=new ci(Zn(a.path),l,{includeMetadataChanges:!0,ra:!0});return Lc(s,h)}(yield Jn(n),n.asyncQueue,t,e,r)})),r.promise}function by(n,t){let e=new at;return n.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return function(i,s,o){return p(this,null,function*(){try{let a=yield qs(i,s,!0),u=new Ys(s,a.ls),c=u.da(a.documents),l=u.applyChanges(c,!1);o.resolve(l.snapshot)}catch(a){let u=rr(a,`Failed to execute query '${s} against cache`);o.reject(u)}})}(yield $c(n),t,e)})),e.promise}function Um(n,t,e={}){let r=new at;return n.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return function(s,o,a,u,c){let l=new Hn({next:d=>{o.enqueueAndForget(()=>Oc(s,h)),d.fromCache&&u.source==="server"?c.reject(new _(g.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):c.resolve(d)},error:d=>c.reject(d)}),h=new ci(a,l,{includeMetadataChanges:!0,ra:!0});return Lc(s,h)}(yield Jn(n),n.asyncQueue,t,e,r)})),r.promise}function xy(n,t){let e=new Hn(t);return n.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return function(i,s){E(i).z_.add(s),s.next()}(yield Jn(n),e)})),()=>{e.$a(),n.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return function(i,s){E(i).z_.delete(s)}(yield Jn(n),e)}))}}function Dy(n,t,e,r){let i=function(o,a){let u;return u=typeof o=="string"?Zf().encode(o):o,function(l,h){return new rc(l,h)}(function(l,h){if(l instanceof Uint8Array)return af(l,h);if(l instanceof ArrayBuffer)return af(new Uint8Array(l),h);if(l instanceof ReadableStream)return l.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(u),a)}(e,yi(t));n.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){Ty(yield Qc(n),i,r)}))}function Cy(n,t){return n.asyncQueue.enqueue(()=>p(this,null,function*(){return function(r,i){let s=E(r);return s.persistence.runTransaction("Get named query","readonly",o=>s.Kr.getNamedQuery(o,i))}(yield $c(n),t)}))}function Gm(n){let t={};return n.timeoutSeconds!==void 0&&(t.timeoutSeconds=n.timeoutSeconds),t}var uf=new Map;function Wc(n,t,e){if(!e)throw new _(g.INVALID_ARGUMENT,`Function ${n}() cannot be called with an empty ${t}.`)}function Hc(n,t,e,r){if(t===!0&&r===!0)throw new _(g.INVALID_ARGUMENT,`${n} and ${e} cannot be used together.`)}function cf(n){if(!I.isDocumentKey(n))throw new _(g.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${n} has ${n.length}.`)}function lf(n){if(I.isDocumentKey(n))throw new _(g.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${n} has ${n.length}.`)}function fo(n){if(n===void 0)return"undefined";if(n===null)return"null";if(typeof n=="string")return n.length>20&&(n=`${n.substring(0,20)}...`),JSON.stringify(n);if(typeof n=="number"||typeof n=="boolean")return""+n;if(typeof n=="object"){if(n instanceof Array)return"an array";{let t=function(r){return r.constructor?r.constructor.name:null}(n);return t?`a custom ${t} object`:"an object"}}return typeof n=="function"?"a function":S()}function L(n,t){if("_delegate"in n&&(n=n._delegate),!(n instanceof t)){if(t.name===n.constructor.name)throw new _(g.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let e=fo(n);throw new _(g.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${e}`)}}return n}function zm(n,t){if(t<=0)throw new _(g.INVALID_ARGUMENT,`Function ${n}() requires a positive number, but it was: ${t}.`)}var Zs=class{constructor(t){var e,r;if(t.host===void 0){if(t.ssl!==void 0)throw new _(g.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=(e=t.ssl)===null||e===void 0||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,t.cacheSizeBytes===void 0)this.cacheSizeBytes=41943040;else{if(t.cacheSizeBytes!==-1&&t.cacheSizeBytes<1048576)throw new _(g.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}Hc("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:t.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Gm((r=t.experimentalLongPollingOptions)!==null&&r!==void 0?r:{}),function(s){if(s.timeoutSeconds!==void 0){if(isNaN(s.timeoutSeconds))throw new _(g.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (must not be NaN)`);if(s.timeoutSeconds<5)throw new _(g.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (minimum allowed value is 5)`);if(s.timeoutSeconds>30)throw new _(g.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(r,i){return r.timeoutSeconds===i.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}},nn=class{constructor(t,e,r,i){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=r,this._app=i,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Zs({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new _(g.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!==void 0}_setSettings(t){if(this._settingsFrozen)throw new _(g.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Zs(t),t.credentials!==void 0&&(this._authCredentials=function(r){if(!r)return new Sa;switch(r.type){case"firstParty":return new xa(r.sessionIndex||"0",r.iamToken||null,r.authTokenFactory||null);case"provider":return r.client;default:throw new _(g.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let r=uf.get(e);r&&(y("ComponentProvider","Removing Datastore"),uf.delete(e),r.terminate())}(this),Promise.resolve()}};function jm(n,t,e,r={}){var i;let s=(n=L(n,nn))._getSettings(),o=`${t}:${e}`;if(s.host!=="firestore.googleapis.com"&&s.host!==o&&Nt("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),n._setSettings(Object.assign(Object.assign({},s),{host:o,ssl:!1})),r.mockUserToken){let a,u;if(typeof r.mockUserToken=="string")a=r.mockUserToken,u=ot.MOCK_USER;else{a=Al(r.mockUserToken,(i=n._app)===null||i===void 0?void 0:i.options.projectId);let c=r.mockUserToken.sub||r.mockUserToken.user_id;if(!c)throw new _(g.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");u=new ot(c)}n._authCredentials=new Ra(new ds(a,u))}}var pt=class n{constructor(t,e,r){this.converter=e,this._query=r,this.type="query",this.firestore=t}withConverter(t){return new n(this.firestore,t,this._query)}},j=class n{constructor(t,e,r){this.converter=e,this._key=r,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Yt(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new n(this.firestore,t,this._key)}},Yt=class n extends pt{constructor(t,e,r){super(t,e,Zn(r)),this._path=r,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let t=this._path.popLast();return t.isEmpty()?null:new j(this.firestore,null,new I(t))}withConverter(t){return new n(this.firestore,t,this._path)}};function Jc(n,t,...e){if(n=H(n),Wc("collection","path",t),n instanceof nn){let r=M.fromString(t,...e);return lf(r),new Yt(n,null,r)}{if(!(n instanceof j||n instanceof Yt))throw new _(g.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=n._path.child(M.fromString(t,...e));return lf(r),new Yt(n.firestore,null,r)}}function Km(n,t){if(n=L(n,nn),Wc("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new _(g.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new pt(n,null,function(r){return new Ot(M.emptyPath(),r)}(t))}function vi(n,t,...e){if(n=H(n),arguments.length===1&&(t=fs.newId()),Wc("doc","path",t),n instanceof nn){let r=M.fromString(t,...e);return cf(r),new j(n,null,new I(r))}{if(!(n instanceof j||n instanceof Yt))throw new _(g.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=n._path.child(M.fromString(t,...e));return cf(r),new j(n.firestore,n instanceof Yt?n.converter:null,new I(r))}}function Yc(n,t){return n=H(n),t=H(t),(n instanceof j||n instanceof Yt)&&(t instanceof j||t instanceof Yt)&&n.firestore===t.firestore&&n.path===t.path&&n.converter===t.converter}function Xc(n,t){return n=H(n),t=H(t),n instanceof pt&&t instanceof pt&&n.firestore===t.firestore&&pi(n._query,t._query)&&n.converter===t.converter}var uc=class{constructor(){this.iu=Promise.resolve(),this.su=[],this.ou=!1,this._u=[],this.au=null,this.uu=!1,this.cu=!1,this.lu=[],this.Jo=new ui(this,"async_queue_retry"),this.hu=()=>{let e=ls();e&&y("AsyncQueue","Visibility state changed to "+e.visibilityState),this.Jo.Uo()};let t=ls();t&&typeof t.addEventListener=="function"&&t.addEventListener("visibilitychange",this.hu)}get isShuttingDown(){return this.ou}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.Pu(),this.Iu(t)}enterRestrictedMode(t){if(!this.ou){this.ou=!0,this.cu=t||!1;let e=ls();e&&typeof e.removeEventListener=="function"&&e.removeEventListener("visibilitychange",this.hu)}}enqueue(t){if(this.Pu(),this.ou)return new Promise(()=>{});let e=new at;return this.Iu(()=>this.ou&&this.cu?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.su.push(t),this.Tu()))}Tu(){return p(this,null,function*(){if(this.su.length!==0){try{yield this.su[0](),this.su.shift(),this.Jo.reset()}catch(t){if(!ke(t))throw t;y("AsyncQueue","Operation failed with retryable error: "+t)}this.su.length>0&&this.Jo.Ko(()=>this.Tu())}})}Iu(t){let e=this.iu.then(()=>(this.uu=!0,t().catch(r=>{this.au=r,this.uu=!1;let i=function(o){let a=o.message||"";return o.stack&&(a=o.stack.includes(o.message)?o.stack:o.message+`
`+o.stack),a}(r);throw Z("INTERNAL UNHANDLED ERROR: ",i),r}).then(r=>(this.uu=!1,r))));return this.iu=e,e}enqueueAfterDelay(t,e,r){this.Pu(),this.lu.indexOf(t)>-1&&(e=0);let i=$u.createAndSchedule(this,t,e,r,s=>this.Eu(s));return this._u.push(i),i}Pu(){this.au&&S()}verifyOperationInProgress(){}du(){return p(this,null,function*(){let t;do t=this.iu,yield t;while(t!==this.iu)})}Au(t){for(let e of this._u)if(e.timerId===t)return!0;return!1}Ru(t){return this.du().then(()=>{this._u.sort((e,r)=>e.targetTimeMs-r.targetTimeMs);for(let e of this._u)if(e.skipDelay(),t!=="all"&&e.timerId===t)break;return this.du()})}Vu(t){this.lu.push(t)}Eu(t){let e=this._u.indexOf(t);this._u.splice(e,1)}};function cc(n){return function(e,r){if(typeof e!="object"||e===null)return!1;let i=e;for(let s of r)if(s in i&&typeof i[s]=="function")return!0;return!1}(n,["next","error","complete"])}var lc=class{constructor(){this._progressObserver={},this._taskCompletionResolver=new at,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,r){this._progressObserver={next:t,error:e,complete:r}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}};var $m=-1,Q=class extends nn{constructor(t,e,r,i){super(t,e,r,i),this.type="firestore",this._queue=function(){return new uc}(),this._persistenceKey=i?.name||"[DEFAULT]"}_terminate(){return this._firestoreClient||Qm(this),this._firestoreClient.terminate()}};function ct(n){return n._firestoreClient||Qm(n),n._firestoreClient.verifyNotTerminated(),n._firestoreClient}function Qm(n){var t,e,r;let i=n._freezeSettings(),s=function(a,u,c,l){return new La(a,u,c,l.host,l.ssl,l.experimentalForceLongPolling,l.experimentalAutoDetectLongPolling,Gm(l.experimentalLongPollingOptions),l.useFetchStreams)}(n._databaseId,((t=n._app)===null||t===void 0?void 0:t.options.appId)||"",n._persistenceKey,i);n._firestoreClient=new oc(n._authCredentials,n._appCheckCredentials,n._queue,s),!((e=i.localCache)===null||e===void 0)&&e._offlineComponentProvider&&(!((r=i.localCache)===null||r===void 0)&&r._onlineComponentProvider)&&(n._firestoreClient._uninitializedComponentsProvider={_offlineKind:i.localCache.kind,_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider})}function Wm(n,t){rg(n=L(n,Q));let e=ct(n);if(e._uninitializedComponentsProvider)throw new _(g.FAILED_PRECONDITION,"SDK cache is already specified.");Nt("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let r=n._freezeSettings(),i=new hi;return Jm(e,i,new Xs(i,r.cacheSizeBytes,t?.forceOwnership))}function Hm(n){rg(n=L(n,Q));let t=ct(n);if(t._uninitializedComponentsProvider)throw new _(g.FAILED_PRECONDITION,"SDK cache is already specified.");Nt("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let e=n._freezeSettings(),r=new hi;return Jm(t,r,new nc(r,e.cacheSizeBytes))}function Jm(n,t,e){let r=new at;return n.asyncQueue.enqueue(()=>p(this,null,function*(){try{yield hs(n,e),yield ac(n,t),r.resolve()}catch(i){let s=i;if(!Lm(s))throw s;Nt("Error enabling indexeddb cache. Falling back to memory cache: "+s),r.reject(s)}})).then(()=>r.promise)}function Ym(n){if(n._initialized&&!n._terminated)throw new _(g.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");let t=new at;return n._queue.enqueueAndForgetEvenWhileRestricted(()=>p(this,null,function*(){try{yield function(r){return p(this,null,function*(){if(!Ae.D())return Promise.resolve();let i=r+"main";yield Ae.delete(i)})}(Nc(n._databaseId,n._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise}function Xm(n){return function(e){let r=new at;return e.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return dy(yield Qc(e),r)})),r.promise}(ct(n=L(n,Q)))}function Zm(n){return Sy(ct(n=L(n,Q)))}function tg(n){return Ry(ct(n=L(n,Q)))}function eg(n,t){let e=ct(n=L(n,Q)),r=new lc;return Dy(e,n._databaseId,t,r),r}function ng(n,t){return Cy(ct(n=L(n,Q)),t).then(e=>e?new pt(n,null,e.query):null)}function rg(n){if(n._initialized||n._terminated)throw new _(g.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}var ee=class n{constructor(t){this._byteString=t}static fromBase64String(t){try{return new n(dt.fromBase64String(t))}catch(e){throw new _(g.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(t){return new n(dt.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}};var Bt=class{constructor(...t){for(let e=0;e<t.length;++e)if(t[e].length===0)throw new _(g.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new tt(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}};var he=class{constructor(t){this._methodName=t}};var rn=class{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new _(g.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new _(g.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return C(this._lat,t._lat)||C(this._long,t._long)}};var Vy=/^__.*__$/,hc=class{constructor(t,e,r){this.data=t,this.fieldMask=e,this.fieldTransforms=r}toMutation(t,e){return this.fieldMask!==null?new qt(t,this.data,this.fieldMask,e,this.fieldTransforms):new De(t,this.data,e,this.fieldTransforms)}},to=class{constructor(t,e,r){this.data=t,this.fieldMask=e,this.fieldTransforms=r}toMutation(t,e){return new qt(t,this.data,this.fieldMask,e,this.fieldTransforms)}};function ig(n){switch(n){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw S()}}var eo=class n{constructor(t,e,r,i,s,o){this.settings=t,this.databaseId=e,this.serializer=r,this.ignoreUndefinedProperties=i,s===void 0&&this.mu(),this.fieldTransforms=s||[],this.fieldMask=o||[]}get path(){return this.settings.path}get fu(){return this.settings.fu}gu(t){return new n(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}pu(t){var e;let r=(e=this.path)===null||e===void 0?void 0:e.child(t),i=this.gu({path:r,yu:!1});return i.wu(t),i}Su(t){var e;let r=(e=this.path)===null||e===void 0?void 0:e.child(t),i=this.gu({path:r,yu:!1});return i.mu(),i}bu(t){return this.gu({path:void 0,yu:!0})}Du(t){return no(t,this.settings.methodName,this.settings.Cu||!1,this.path,this.settings.vu)}contains(t){return this.fieldMask.find(e=>t.isPrefixOf(e))!==void 0||this.fieldTransforms.find(e=>t.isPrefixOf(e.field))!==void 0}mu(){if(this.path)for(let t=0;t<this.path.length;t++)this.wu(this.path.get(t))}wu(t){if(t.length===0)throw this.Du("Document fields must not be empty");if(ig(this.fu)&&Vy.test(t))throw this.Du('Document fields cannot begin and end with "__"')}},dc=class{constructor(t,e,r){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=r||yi(t)}Fu(t,e,r,i=!1){return new eo({fu:t,methodName:e,vu:r,path:tt.emptyPath(),yu:!1,Cu:i},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}};function un(n){let t=n._freezeSettings(),e=yi(n._databaseId);return new dc(n._databaseId,!!t.ignoreUndefinedProperties,e)}function mo(n,t,e,r,i,s={}){let o=n.Fu(s.merge||s.mergeFields?2:0,t,e,i);el("Data must be an object, but it was:",o,r);let a=ag(r,o),u,c;if(s.merge)u=new xt(o.fieldMask),c=o.fieldTransforms;else if(s.mergeFields){let l=[];for(let h of s.mergeFields){let d=_c(t,h,e);if(!o.contains(d))throw new _(g.INVALID_ARGUMENT,`Field '${d}' is specified in your field mask but missing from your input data.`);cg(l,d)||l.push(d)}u=new xt(l),c=o.fieldTransforms.filter(h=>u.covers(h.field))}else u=null,c=o.fieldTransforms;return new hc(new vt(a),u,c)}var di=class n extends he{_toFieldTransform(t){if(t.fu!==2)throw t.fu===1?t.Du(`${this._methodName}() can only appear at the top level of your update data`):t.Du(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof n}};function sg(n,t,e){return new eo({fu:3,vu:t.settings.vu,methodName:n._methodName,yu:e},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}var fc=class n extends he{_toFieldTransform(t){return new Ze(t.path,new be)}isEqual(t){return t instanceof n}},mc=class n extends he{constructor(t,e){super(t),this.Mu=e}_toFieldTransform(t){let e=sg(this,t,!0),r=this.Mu.map(s=>cn(s,e)),i=new ce(r);return new Ze(t.path,i)}isEqual(t){return t instanceof n&&bo(this.Mu,t.Mu)}},gc=class n extends he{constructor(t,e){super(t),this.Mu=e}_toFieldTransform(t){let e=sg(this,t,!0),r=this.Mu.map(s=>cn(s,e)),i=new le(r);return new Ze(t.path,i)}isEqual(t){return t instanceof n&&bo(this.Mu,t.Mu)}},pc=class n extends he{constructor(t,e){super(t),this.xu=e}_toFieldTransform(t){let e=new xe(t.serializer,jf(t.serializer,this.xu));return new Ze(t.path,e)}isEqual(t){return t instanceof n&&this.xu===t.xu}};function Zc(n,t,e,r){let i=n.Fu(1,t,e);el("Data must be an object, but it was:",i,r);let s=[],o=vt.empty();an(r,(u,c)=>{let l=nl(t,u,e);c=H(c);let h=i.Su(l);if(c instanceof di)s.push(l);else{let d=cn(c,h);d!=null&&(s.push(l),o.set(l,d))}});let a=new xt(s);return new to(o,a,i.fieldTransforms)}function tl(n,t,e,r,i,s){let o=n.Fu(1,t,e),a=[_c(t,r,e)],u=[i];if(s.length%2!=0)throw new _(g.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let d=0;d<s.length;d+=2)a.push(_c(t,s[d])),u.push(s[d+1]);let c=[],l=vt.empty();for(let d=a.length-1;d>=0;--d)if(!cg(c,a[d])){let m=a[d],A=u[d];A=H(A);let w=o.Su(m);if(A instanceof di)c.push(m);else{let v=cn(A,w);v!=null&&(c.push(m),l.set(m,v))}}let h=new xt(c);return new to(l,h,o.fieldTransforms)}function og(n,t,e,r=!1){return cn(e,n.Fu(r?4:3,t))}function cn(n,t){if(ug(n=H(n)))return el("Unsupported field value:",t,n),ag(n,t);if(n instanceof he)return function(r,i){if(!ig(i.fu))throw i.Du(`${r._methodName}() can only be used with update() and set()`);if(!i.path)throw i.Du(`${r._methodName}() is not currently supported inside arrays`);let s=r._toFieldTransform(i);s&&i.fieldTransforms.push(s)}(n,t),null;if(n===void 0&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),n instanceof Array){if(t.settings.yu&&t.fu!==4)throw t.Du("Nested arrays are not supported");return function(r,i){let s=[],o=0;for(let a of r){let u=cn(a,i.bu(o));u==null&&(u={nullValue:"NULL_VALUE"}),s.push(u),o++}return{arrayValue:{values:s}}}(n,t)}return function(r,i){if((r=H(r))===null)return{nullValue:"NULL_VALUE"};if(typeof r=="number")return jf(i.serializer,r);if(typeof r=="boolean")return{booleanValue:r};if(typeof r=="string")return{stringValue:r};if(r instanceof Date){let s=W.fromDate(r);return{timestampValue:Un(i.serializer,s)}}if(r instanceof W){let s=new W(r.seconds,1e3*Math.floor(r.nanoseconds/1e3));return{timestampValue:Un(i.serializer,s)}}if(r instanceof rn)return{geoPointValue:{latitude:r.latitude,longitude:r.longitude}};if(r instanceof ee)return{bytesValue:tm(i.serializer,r._byteString)};if(r instanceof j){let s=i.databaseId,o=r.firestore._databaseId;if(!o.isEqual(s))throw i.Du(`Document reference is for database ${o.projectId}/${o.database} but should be for database ${s.projectId}/${s.database}`);return{referenceValue:Dc(r.firestore._databaseId||i.databaseId,r._key.path)}}throw i.Du(`Unsupported field value: ${fo(r)}`)}(n,t)}function ag(n,t){let e={};return Rf(n)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):an(n,(r,i)=>{let s=cn(i,t.pu(r));s!=null&&(e[r]=s)}),{mapValue:{fields:e}}}function ug(n){return!(typeof n!="object"||n===null||n instanceof Array||n instanceof Date||n instanceof W||n instanceof rn||n instanceof ee||n instanceof j||n instanceof he)}function el(n,t,e){if(!ug(e)||!function(i){return typeof i=="object"&&i!==null&&(Object.getPrototypeOf(i)===Object.prototype||Object.getPrototypeOf(i)===null)}(e)){let r=fo(e);throw r==="an object"?t.Du(n+" a custom object"):t.Du(n+" "+r)}}function _c(n,t,e){if((t=H(t))instanceof Bt)return t._internalPath;if(typeof t=="string")return nl(n,t);throw no("Field path arguments must be of type string or ",n,!1,void 0,e)}var Ny=new RegExp("[~\\*/\\[\\]]");function nl(n,t,e){if(t.search(Ny)>=0)throw no(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,n,!1,void 0,e);try{return new Bt(...t.split("."))._internalPath}catch{throw no(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,n,!1,void 0,e)}}function no(n,t,e,r,i){let s=r&&!r.isEmpty(),o=i!==void 0,a=`Function ${t}() called with invalid data`;e&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(s||o)&&(u+=" (found",s&&(u+=` in field ${r}`),o&&(u+=` in document ${i}`),u+=")"),new _(g.INVALID_ARGUMENT,a+n+u)}function cg(n,t){return n.some(e=>e.isEqual(t))}var sn=class{constructor(t,e,r,i,s){this._firestore=t,this._userDataWriter=e,this._key=r,this._document=i,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new j(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){let t=new yc(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){let e=this._document.data.field(go("DocumentSnapshot.get",t));if(e!==null)return this._userDataWriter.convertValue(e)}}},yc=class extends sn{data(){return super.data()}};function go(n,t){return typeof t=="string"?nl(n,t):t instanceof Bt?t._internalPath:t._delegate._internalPath}function lg(n){if(n.limitType==="L"&&n.explicitOrderBy.length===0)throw new _(g.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}var fi=class{},on=class extends fi{};function me(n,t,...e){let r=[];t instanceof fi&&r.push(t),r=r.concat(e),function(s){let o=s.filter(u=>u instanceof wc).length,a=s.filter(u=>u instanceof ro).length;if(o>1||o>0&&a>0)throw new _(g.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(let i of r)n=i._apply(n);return n}var ro=class n extends on{constructor(t,e,r){super(),this._field=t,this._op=e,this._value=r,this.type="where"}static _create(t,e,r){return new n(t,e,r)}_apply(t){let e=this._parse(t);return vg(t._query,e),new pt(t.firestore,t.converter,Ja(t._query,e))}_parse(t){let e=un(t.firestore);return function(s,o,a,u,c,l,h){let d;if(c.isKeyField()){if(l==="array-contains"||l==="array-contains-any")throw new _(g.INVALID_ARGUMENT,`Invalid Query. You can't perform '${l}' queries on documentId().`);if(l==="in"||l==="not-in"){df(h,l);let m=[];for(let A of h)m.push(hf(u,s,A));d={arrayValue:{values:m}}}else d=hf(u,s,h)}else l!=="in"&&l!=="not-in"&&l!=="array-contains-any"||df(h,l),d=og(a,o,h,l==="in"||l==="not-in");return k.create(c,l,d)}(t._query,"where",e,t.firestore._databaseId,this._field,this._op,this._value)}};function hg(n,t,e){let r=t,i=go("where",n);return ro._create(i,r,e)}var wc=class n extends fi{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new n(t,e)}_parse(t){let e=this._queryConstraints.map(r=>r._parse(t)).filter(r=>r.getFilters().length>0);return e.length===1?e[0]:G.create(e,this._getOperator())}_apply(t){let e=this._parse(t);return e.getFilters().length===0?t:(function(i,s){let o=i,a=s.getFlattenedFilters();for(let u of a)vg(o,u),o=Ja(o,u)}(t._query,e),new pt(t.firestore,t.converter,Ja(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}};var vc=class n extends on{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new n(t,e)}_apply(t){let e=function(i,s,o){if(i.startAt!==null)throw new _(g.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(i.endAt!==null)throw new _(g.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Ye(s,o)}(t._query,this._field,this._direction);return new pt(t.firestore,t.converter,function(i,s){let o=i.explicitOrderBy.concat([s]);return new Ot(i.path,i.collectionGroup,o,i.filters.slice(),i.limit,i.limitType,i.startAt,i.endAt)}(t._query,e))}};function dg(n,t="asc"){let e=t,r=go("orderBy",n);return vc._create(r,e)}var io=class n extends on{constructor(t,e,r){super(),this.type=t,this._limit=e,this._limitType=r}static _create(t,e,r){return new n(t,e,r)}_apply(t){return new pt(t.firestore,t.converter,Ts(t._query,this._limit,this._limitType))}};function fg(n){return zm("limit",n),io._create("limit",n,"F")}function mg(n){return zm("limitToLast",n),io._create("limitToLast",n,"L")}var so=class n extends on{constructor(t,e,r){super(),this.type=t,this._docOrFields=e,this._inclusive=r}static _create(t,e,r){return new n(t,e,r)}_apply(t){let e=wg(t,this.type,this._docOrFields,this._inclusive);return new pt(t.firestore,t.converter,function(i,s){return new Ot(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,s,i.endAt)}(t._query,e))}};function gg(...n){return so._create("startAt",n,!0)}function pg(...n){return so._create("startAfter",n,!1)}var oo=class n extends on{constructor(t,e,r){super(),this.type=t,this._docOrFields=e,this._inclusive=r}static _create(t,e,r){return new n(t,e,r)}_apply(t){let e=wg(t,this.type,this._docOrFields,this._inclusive);return new pt(t.firestore,t.converter,function(i,s){return new Ot(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,i.startAt,s)}(t._query,e))}};function _g(...n){return oo._create("endBefore",n,!1)}function yg(...n){return oo._create("endAt",n,!0)}function wg(n,t,e,r){if(e[0]=H(e[0]),e[0]instanceof sn)return function(s,o,a,u,c){if(!u)throw new _(g.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${a}().`);let l=[];for(let h of Nn(s))if(h.field.isKeyField())l.push(Je(o,u.key));else{let d=u.data.field(h.field);if(uo(d))throw new _(g.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+h.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(d===null){let m=h.field.canonicalString();throw new _(g.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${m}' (used as the orderBy) does not exist.`)}l.push(d)}return new Zt(l,c)}(n._query,n.firestore._databaseId,t,e[0]._document,r);{let i=un(n.firestore);return function(o,a,u,c,l,h){let d=o.explicitOrderBy;if(l.length>d.length)throw new _(g.INVALID_ARGUMENT,`Too many arguments provided to ${c}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let m=[];for(let A=0;A<l.length;A++){let w=l[A];if(d[A].field.isKeyField()){if(typeof w!="string")throw new _(g.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${c}(), but got a ${typeof w}`);if(!bc(o)&&w.indexOf("/")!==-1)throw new _(g.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${c}() must be a plain document ID, but '${w}' contains a slash.`);let v=o.path.child(M.fromString(w));if(!I.isDocumentKey(v))throw new _(g.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${c}() must result in a valid document path, but '${v}' is not because it contains an odd number of segments.`);let b=new I(v);m.push(Je(a,b))}else{let v=og(u,c,w);m.push(v)}}return new Zt(m,h)}(n._query,n.firestore._databaseId,i,t,e,r)}}function hf(n,t,e){if(typeof(e=H(e))=="string"){if(e==="")throw new _(g.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!bc(t)&&e.indexOf("/")!==-1)throw new _(g.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${e}' contains a '/' character.`);let r=t.path.child(M.fromString(e));if(!I.isDocumentKey(r))throw new _(g.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Je(n,new I(r))}if(e instanceof j)return Je(n,e._key);throw new _(g.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${fo(e)}.`)}function df(n,t){if(!Array.isArray(n)||n.length===0)throw new _(g.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function vg(n,t){let e=function(i,s){for(let o of i)for(let a of o.getFlattenedFilters())if(s.indexOf(a.op)>=0)return a.op;return null}(n.filters,function(i){switch(i){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(e!==null)throw e===t.op?new _(g.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new _(g.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${e.toString()}' filters.`)}var Yn=class{convertValue(t,e="none"){switch(He(t)){case 0:return null;case 1:return t.booleanValue;case 2:return Y(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(Se(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw S()}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t,e="none"){let r={};return an(t,(i,s)=>{r[i]=this.convertValue(s,e)}),r}convertGeoPoint(t){return new rn(Y(t.latitude),Y(t.longitude))}convertArray(t,e){return(t.values||[]).map(r=>this.convertValue(r,e))}convertServerTimestamp(t,e){switch(e){case"previous":let r=Rc(t);return r==null?null:this.convertValue(r,e);case"estimate":return this.convertTimestamp(Hr(t));default:return null}}convertTimestamp(t){let e=ue(t);return new W(e.seconds,e.nanos)}convertDocumentKey(t,e){let r=M.fromString(t);R(hm(r));let i=new Re(r.get(1),r.get(3)),s=new I(r.popFirst(5));return i.isEqual(e)||Z(`Document ${s} contains a document reference within a different database (${i.projectId}/${i.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}};function po(n,t,e){let r;return r=n?e&&(e.merge||e.mergeFields)?n.toFirestore(t,e):n.toFirestore(t):t,r}var Ic=class extends Yn{constructor(t){super(),this.firestore=t}convertBytes(t){return new ee(t)}convertReference(t){let e=this.convertDocumentKey(t,this.firestore._databaseId);return new j(this.firestore,null,e)}};var ae=class{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}},Ft=class extends sn{constructor(t,e,r,i,s,o){super(t,e,r,i,o),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){let e=new Ee(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){let r=this._document.data.field(go("DocumentSnapshot.get",t));if(r!==null)return this._userDataWriter.convertValue(r,e.serverTimestamps)}}},Ee=class extends Ft{data(t={}){return super.data(t)}},Ut=class{constructor(t,e,r,i){this._firestore=t,this._userDataWriter=e,this._snapshot=i,this.metadata=new ae(i.hasPendingWrites,i.fromCache),this.query=r}get docs(){let t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(t,e){this._snapshot.docs.forEach(r=>{t.call(e,new Ee(this._firestore,this._userDataWriter,r.key,r,new ae(this._snapshot.mutatedKeys.has(r.key),this._snapshot.fromCache),this.query.converter))})}docChanges(t={}){let e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new _(g.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(i,s){if(i._snapshot.oldDocs.isEmpty()){let o=0;return i._snapshot.docChanges.map(a=>{let u=new Ee(i._firestore,i._userDataWriter,a.doc.key,a.doc,new ae(i._snapshot.mutatedKeys.has(a.doc.key),i._snapshot.fromCache),i.query.converter);return a.doc,{type:"added",doc:u,oldIndex:-1,newIndex:o++}})}{let o=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(a=>s||a.type!==3).map(a=>{let u=new Ee(i._firestore,i._userDataWriter,a.doc.key,a.doc,new ae(i._snapshot.mutatedKeys.has(a.doc.key),i._snapshot.fromCache),i.query.converter),c=-1,l=-1;return a.type!==0&&(c=o.indexOf(a.doc.key),o=o.delete(a.doc.key)),a.type!==1&&(o=o.add(a.doc),l=o.indexOf(a.doc.key)),{type:ky(a.type),doc:u,oldIndex:c,newIndex:l}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}};function ky(n){switch(n){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return S()}}function rl(n,t){return n instanceof Ft&&t instanceof Ft?n._firestore===t._firestore&&n._key.isEqual(t._key)&&(n._document===null?t._document===null:n._document.isEqual(t._document))&&n._converter===t._converter:n instanceof Ut&&t instanceof Ut&&n._firestore===t._firestore&&Xc(n.query,t.query)&&n.metadata.isEqual(t.metadata)&&n._snapshot.isEqual(t._snapshot)}function Ig(n){n=L(n,j);let t=L(n.firestore,Q);return Bm(ct(t),n._key).then(e=>al(t,n,e))}var de=class extends Yn{constructor(t){super(),this.firestore=t}convertBytes(t){return new ee(t)}convertReference(t){let e=this.convertDocumentKey(t,this.firestore._databaseId);return new j(this.firestore,null,e)}};function Eg(n){n=L(n,j);let t=L(n.firestore,Q),e=ct(t),r=new de(t);return Py(e,n._key).then(i=>new Ft(t,r,n._key,i,new ae(i!==null&&i.hasLocalMutations,!0),n.converter))}function Tg(n){n=L(n,j);let t=L(n.firestore,Q);return Bm(ct(t),n._key,{source:"server"}).then(e=>al(t,n,e))}function Ag(n){n=L(n,pt);let t=L(n.firestore,Q),e=ct(t),r=new de(t);return lg(n._query),Um(e,n._query).then(i=>new Ut(t,r,n,i))}function Sg(n){n=L(n,pt);let t=L(n.firestore,Q),e=ct(t),r=new de(t);return by(e,n._query).then(i=>new Ut(t,r,n,i))}function Rg(n){n=L(n,pt);let t=L(n.firestore,Q),e=ct(t),r=new de(t);return Um(e,n._query,{source:"server"}).then(i=>new Ut(t,r,n,i))}function il(n,t,e){n=L(n,j);let r=L(n.firestore,Q),i=po(n.converter,t,e);return ir(r,[mo(un(r),"setDoc",n._key,i,n.converter!==null,e).toMutation(n._key,X.none())])}function sl(n,t,e,...r){n=L(n,j);let i=L(n.firestore,Q),s=un(i),o;return o=typeof(t=H(t))=="string"||t instanceof Bt?tl(s,"updateDoc",n._key,t,e,r):Zc(s,"updateDoc",n._key,t),ir(i,[o.toMutation(n._key,X.exists(!0))])}function Pg(n){return ir(L(n.firestore,Q),[new Ce(n._key,X.none())])}function bg(n,t){let e=L(n.firestore,Q),r=vi(n),i=po(n.converter,t);return ir(e,[mo(un(n.firestore),"addDoc",r._key,i,n.converter!==null,{}).toMutation(r._key,X.exists(!1))]).then(()=>r)}function ol(n,...t){var e,r,i;n=H(n);let s={includeMetadataChanges:!1,source:"default"},o=0;typeof t[o]!="object"||cc(t[o])||(s=t[o],o++);let a={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(cc(t[o])){let h=t[o];t[o]=(e=h.next)===null||e===void 0?void 0:e.bind(h),t[o+1]=(r=h.error)===null||r===void 0?void 0:r.bind(h),t[o+2]=(i=h.complete)===null||i===void 0?void 0:i.bind(h)}let u,c,l;if(n instanceof j)c=L(n.firestore,Q),l=Zn(n._key.path),u={next:h=>{t[o]&&t[o](al(c,n,h))},error:t[o+1],complete:t[o+2]};else{let h=L(n,pt);c=L(h.firestore,Q),l=h._query;let d=new de(c);u={next:m=>{t[o]&&t[o](new Ut(c,d,h,m))},error:t[o+1],complete:t[o+2]},lg(n._query)}return function(d,m,A,w){let v=new Hn(w),b=new ci(m,v,A);return d.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return Lc(yield Jn(d),b)})),()=>{v.$a(),d.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return Oc(yield Jn(d),b)}))}}(ct(c),l,a,u)}function xg(n,t){return xy(ct(n=L(n,Q)),cc(t)?t:{next:t})}function ir(n,t){return function(r,i){let s=new at;return r.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return uy(yield Qc(r),i,s)})),s.promise}(ct(n),t)}function al(n,t,e){let r=e.docs.get(t._key),i=new de(n);return new Ft(n,i,t._key,r,new ae(e.hasPendingWrites,e.fromCache),t.converter)}var Fy={maxAttempts:5};var ao=class{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=un(t)}set(t,e,r){this._verifyNotCommitted();let i=ve(t,this._firestore),s=po(i.converter,e,r),o=mo(this._dataReader,"WriteBatch.set",i._key,s,i.converter!==null,r);return this._mutations.push(o.toMutation(i._key,X.none())),this}update(t,e,r,...i){this._verifyNotCommitted();let s=ve(t,this._firestore),o;return o=typeof(e=H(e))=="string"||e instanceof Bt?tl(this._dataReader,"WriteBatch.update",s._key,e,r,i):Zc(this._dataReader,"WriteBatch.update",s._key,e),this._mutations.push(o.toMutation(s._key,X.exists(!0))),this}delete(t){this._verifyNotCommitted();let e=ve(t,this._firestore);return this._mutations=this._mutations.concat(new Ce(e._key,X.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new _(g.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}};function ve(n,t){if((n=H(n)).firestore!==t)throw new _(g.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return n}var Ec=class extends class{constructor(e,r){this._firestore=e,this._transaction=r,this._dataReader=un(e)}get(e){let r=ve(e,this._firestore),i=new Ic(this._firestore);return this._transaction.lookup([r._key]).then(s=>{if(!s||s.length!==1)return S();let o=s[0];if(o.isFoundDocument())return new sn(this._firestore,i,o.key,o,r.converter);if(o.isNoDocument())return new sn(this._firestore,i,r._key,null,r.converter);throw S()})}set(e,r,i){let s=ve(e,this._firestore),o=po(s.converter,r,i),a=mo(this._dataReader,"Transaction.set",s._key,o,s.converter!==null,i);return this._transaction.set(s._key,a),this}update(e,r,i,...s){let o=ve(e,this._firestore),a;return a=typeof(r=H(r))=="string"||r instanceof Bt?tl(this._dataReader,"Transaction.update",o._key,r,i,s):Zc(this._dataReader,"Transaction.update",o._key,r),this._transaction.update(o._key,a),this}delete(e){let r=ve(e,this._firestore);return this._transaction.delete(r._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){let e=ve(t,this._firestore),r=new de(this._firestore);return super.get(t).then(i=>new Ft(this._firestore,r,e._key,i._document,new ae(!1,!1),e.converter))}};function Dg(n,t,e){n=L(n,Q);let r=Object.assign(Object.assign({},Fy),e);return function(s){if(s.maxAttempts<1)throw new _(g.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(s,o,a){let u=new at;return s.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){let c=yield Ay(s);new sc(s.asyncQueue,c,a,o,u).Xa()})),u.promise}(ct(n),i=>t(new Ec(n,i)),r)}function Cg(){return new di("deleteField")}function Vg(){return new fc("serverTimestamp")}function Ng(...n){return new mc("arrayUnion",n)}function kg(...n){return new gc("arrayRemove",n)}function Fg(n){return new pc("increment",n)}(function(t,e=!0){(function(i){Xn=i})(xl),bl(new Ri("firestore",(r,{instanceIdentifier:i,options:s})=>{let o=r.getProvider("app").getImmediate(),a=new Q(new Pa(r.getProvider("auth-internal")),new Ca(r.getProvider("app-check-internal")),function(c,l){if(!Object.prototype.hasOwnProperty.apply(c.options,["projectId"]))throw new _(g.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Re(c.options.projectId,l)}(o,i),o);return s=Object.assign({useFetchStreams:e},s),a._setSettings(s),a},"PUBLIC").setMultipleInstances(!0)),xo(dd,"4.6.1",t),xo(dd,"4.6.1","esm2017")})();var My="@firebase/firestore-compat",Ly="0.3.30";function fl(n,t){if(t===void 0)return{merge:!1};if(t.mergeFields!==void 0&&t.merge!==void 0)throw new _("invalid-argument",`Invalid options passed to function ${n}(): You cannot specify both "merge" and "mergeFields".`);return t}function Mg(){if(typeof Uint8Array>"u")throw new _("unimplemented","Uint8Arrays are not available in this environment.")}function Lg(){if(!Pf())throw new _("unimplemented","Blobs are unavailable in Firestore in this environment.")}var _o=class n{constructor(t){this._delegate=t}static fromBase64String(t){return Lg(),new n(ee.fromBase64String(t))}static fromUint8Array(t){return Mg(),new n(ee.fromUint8Array(t))}toBase64(){return Lg(),this._delegate.toBase64()}toUint8Array(){return Mg(),this._delegate.toUint8Array()}isEqual(t){return this._delegate.isEqual(t._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}};function ul(n){return Oy(n,["next","error","complete"])}function Oy(n,t){if(typeof n!="object"||n===null)return!1;let e=n;for(let r of t)if(r in e&&typeof e[r]=="function")return!0;return!1}var cl=class{enableIndexedDbPersistence(t,e){return Wm(t._delegate,{forceOwnership:e})}enableMultiTabIndexedDbPersistence(t){return Hm(t._delegate)}clearIndexedDbPersistence(t){return Ym(t._delegate)}},yo=class{constructor(t,e,r){this._delegate=e,this._persistenceProvider=r,this.INTERNAL={delete:()=>this.terminate()},t instanceof Re||(this._appCompat=t)}get _databaseId(){return this._delegate._databaseId}settings(t){let e=this._delegate._getSettings();!t.merge&&e.host!==t.host&&Nt("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),t.merge&&(t=Object.assign(Object.assign({},e),t),delete t.merge),this._delegate._setSettings(t)}useEmulator(t,e,r={}){jm(this._delegate,t,e,r)}enableNetwork(){return Zm(this._delegate)}disableNetwork(){return tg(this._delegate)}enablePersistence(t){let e=!1,r=!1;return t&&(e=!!t.synchronizeTabs,r=!!t.experimentalForceOwningTab,Hc("synchronizeTabs",e,"experimentalForceOwningTab",r)),e?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,r)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return Xm(this._delegate)}onSnapshotsInSync(t){return xg(this._delegate,t)}get app(){if(!this._appCompat)throw new _("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(t){try{return new ar(this,Jc(this._delegate,t))}catch(e){throw At(e,"collection()","Firestore.collection()")}}doc(t){try{return new ne(this,vi(this._delegate,t))}catch(e){throw At(e,"doc()","Firestore.doc()")}}collectionGroup(t){try{return new fn(this,Km(this._delegate,t))}catch(e){throw At(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){return Dg(this._delegate,e=>t(new wo(this,e)))}batch(){return ct(this._delegate),new vo(new ao(this._delegate,t=>ir(this._delegate,t)))}loadBundle(t){return eg(this._delegate,t)}namedQuery(t){return ng(this._delegate,t).then(e=>e?new fn(this,e):null)}},sr=class extends Yn{constructor(t){super(),this.firestore=t}convertBytes(t){return new _o(new ee(t))}convertReference(t){let e=this.convertDocumentKey(t,this.firestore._databaseId);return ne.forKey(e,this.firestore,null)}};function qy(n){ff(n)}var wo=class{constructor(t,e){this._firestore=t,this._delegate=e,this._userDataWriter=new sr(t)}get(t){let e=ln(t);return this._delegate.get(e).then(r=>new hn(this._firestore,new Ft(this._firestore._delegate,this._userDataWriter,r._key,r._document,r.metadata,e.converter)))}set(t,e,r){let i=ln(t);return r?(fl("Transaction.set",r),this._delegate.set(i,e,r)):this._delegate.set(i,e),this}update(t,e,r,...i){let s=ln(t);return arguments.length===2?this._delegate.update(s,e):this._delegate.update(s,e,r,...i),this}delete(t){let e=ln(t);return this._delegate.delete(e),this}},vo=class{constructor(t){this._delegate=t}set(t,e,r){let i=ln(t);return r?(fl("WriteBatch.set",r),this._delegate.set(i,e,r)):this._delegate.set(i,e),this}update(t,e,r,...i){let s=ln(t);return arguments.length===2?this._delegate.update(s,e):this._delegate.update(s,e,r,...i),this}delete(t){let e=ln(t);return this._delegate.delete(e),this}commit(){return this._delegate.commit()}},or=class n{constructor(t,e,r){this._firestore=t,this._userDataWriter=e,this._delegate=r}fromFirestore(t,e){let r=new Ee(this._firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,null);return this._delegate.fromFirestore(new dn(this._firestore,r),e??{})}toFirestore(t,e){return e?this._delegate.toFirestore(t,e):this._delegate.toFirestore(t)}static getInstance(t,e){let r=n.INSTANCES,i=r.get(t);i||(i=new WeakMap,r.set(t,i));let s=i.get(e);return s||(s=new n(t,new sr(t),e),i.set(e,s)),s}};or.INSTANCES=new WeakMap;var ne=class n{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new sr(t)}static forPath(t,e,r){if(t.length%2!==0)throw new _("invalid-argument",`Invalid document reference. Document references must have an even number of segments, but ${t.canonicalString()} has ${t.length}`);return new n(e,new j(e._delegate,r,new I(t)))}static forKey(t,e,r){return new n(e,new j(e._delegate,r,t))}get id(){return this._delegate.id}get parent(){return new ar(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(t){try{return new ar(this.firestore,Jc(this._delegate,t))}catch(e){throw At(e,"collection()","DocumentReference.collection()")}}isEqual(t){return t=H(t),t instanceof j?Yc(this._delegate,t):!1}set(t,e){e=fl("DocumentReference.set",e);try{return e?il(this._delegate,t,e):il(this._delegate,t)}catch(r){throw At(r,"setDoc()","DocumentReference.set()")}}update(t,e,...r){try{return arguments.length===1?sl(this._delegate,t):sl(this._delegate,t,e,...r)}catch(i){throw At(i,"updateDoc()","DocumentReference.update()")}}delete(){return Pg(this._delegate)}onSnapshot(...t){let e=Og(t),r=qg(t,i=>new hn(this.firestore,new Ft(this.firestore._delegate,this._userDataWriter,i._key,i._document,i.metadata,this._delegate.converter)));return ol(this._delegate,e,r)}get(t){let e;return t?.source==="cache"?e=Eg(this._delegate):t?.source==="server"?e=Tg(this._delegate):e=Ig(this._delegate),e.then(r=>new hn(this.firestore,new Ft(this.firestore._delegate,this._userDataWriter,r._key,r._document,r.metadata,this._delegate.converter)))}withConverter(t){return new n(this.firestore,t?this._delegate.withConverter(or.getInstance(this.firestore,t)):this._delegate.withConverter(null))}};function At(n,t,e){return n.message=n.message.replace(t,e),n}function Og(n){for(let t of n)if(typeof t=="object"&&!ul(t))return t;return{}}function qg(n,t){var e,r;let i;return ul(n[0])?i=n[0]:ul(n[1])?i=n[1]:typeof n[0]=="function"?i={next:n[0],error:n[1],complete:n[2]}:i={next:n[1],error:n[2],complete:n[3]},{next:s=>{i.next&&i.next(t(s))},error:(e=i.error)===null||e===void 0?void 0:e.bind(i),complete:(r=i.complete)===null||r===void 0?void 0:r.bind(i)}}var hn=class{constructor(t,e){this._firestore=t,this._delegate=e}get ref(){return new ne(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(t){return this._delegate.data(t)}get(t,e){return this._delegate.get(t,e)}isEqual(t){return rl(this._delegate,t._delegate)}},dn=class extends hn{data(t){let e=this._delegate.data(t);return this._delegate._converter||mf(e!==void 0,"Document in a QueryDocumentSnapshot should exist"),e}},fn=class n{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new sr(t)}where(t,e,r){try{return new n(this.firestore,me(this._delegate,hg(t,e,r)))}catch(i){throw At(i,/(orderBy|where)\(\)/,"Query.$1()")}}orderBy(t,e){try{return new n(this.firestore,me(this._delegate,dg(t,e)))}catch(r){throw At(r,/(orderBy|where)\(\)/,"Query.$1()")}}limit(t){try{return new n(this.firestore,me(this._delegate,fg(t)))}catch(e){throw At(e,"limit()","Query.limit()")}}limitToLast(t){try{return new n(this.firestore,me(this._delegate,mg(t)))}catch(e){throw At(e,"limitToLast()","Query.limitToLast()")}}startAt(...t){try{return new n(this.firestore,me(this._delegate,gg(...t)))}catch(e){throw At(e,"startAt()","Query.startAt()")}}startAfter(...t){try{return new n(this.firestore,me(this._delegate,pg(...t)))}catch(e){throw At(e,"startAfter()","Query.startAfter()")}}endBefore(...t){try{return new n(this.firestore,me(this._delegate,_g(...t)))}catch(e){throw At(e,"endBefore()","Query.endBefore()")}}endAt(...t){try{return new n(this.firestore,me(this._delegate,yg(...t)))}catch(e){throw At(e,"endAt()","Query.endAt()")}}isEqual(t){return Xc(this._delegate,t._delegate)}get(t){let e;return t?.source==="cache"?e=Sg(this._delegate):t?.source==="server"?e=Rg(this._delegate):e=Ag(this._delegate),e.then(r=>new Ii(this.firestore,new Ut(this.firestore._delegate,this._userDataWriter,this._delegate,r._snapshot)))}onSnapshot(...t){let e=Og(t),r=qg(t,i=>new Ii(this.firestore,new Ut(this.firestore._delegate,this._userDataWriter,this._delegate,i._snapshot)));return ol(this._delegate,e,r)}withConverter(t){return new n(this.firestore,t?this._delegate.withConverter(or.getInstance(this.firestore,t)):this._delegate.withConverter(null))}},ll=class{constructor(t,e){this._firestore=t,this._delegate=e}get type(){return this._delegate.type}get doc(){return new dn(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}},Ii=class{constructor(t,e){this._firestore=t,this._delegate=e}get query(){return new fn(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(t=>new dn(this._firestore,t))}docChanges(t){return this._delegate.docChanges(t).map(e=>new ll(this._firestore,e))}forEach(t,e){this._delegate.forEach(r=>{t.call(e,new dn(this._firestore,r))})}isEqual(t){return rl(this._delegate,t._delegate)}},ar=class n extends fn{constructor(t,e){super(t,e),this.firestore=t,this._delegate=e}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){let t=this._delegate.parent;return t?new ne(this.firestore,t):null}doc(t){try{return t===void 0?new ne(this.firestore,vi(this._delegate)):new ne(this.firestore,vi(this._delegate,t))}catch(e){throw At(e,"doc()","CollectionReference.doc()")}}add(t){return bg(this._delegate,t).then(e=>new ne(this.firestore,e))}isEqual(t){return Yc(this._delegate,t._delegate)}withConverter(t){return new n(this.firestore,t?this._delegate.withConverter(or.getInstance(this.firestore,t)):this._delegate.withConverter(null))}};function ln(n){return L(n,j)}var hl=class n{constructor(...t){this._delegate=new Bt(...t)}static documentId(){return new n(tt.keyField().canonicalString())}isEqual(t){return t=H(t),t instanceof Bt?this._delegate._internalPath.isEqual(t._internalPath):!1}};var dl=class n{constructor(t){this._delegate=t}static serverTimestamp(){let t=Vg();return t._methodName="FieldValue.serverTimestamp",new n(t)}static delete(){let t=Cg();return t._methodName="FieldValue.delete",new n(t)}static arrayUnion(...t){let e=Ng(...t);return e._methodName="FieldValue.arrayUnion",new n(e)}static arrayRemove(...t){let e=kg(...t);return e._methodName="FieldValue.arrayRemove",new n(e)}static increment(t){let e=Fg(t);return e._methodName="FieldValue.increment",new n(e)}isEqual(t){return this._delegate.isEqual(t._delegate)}};var By={Firestore:yo,GeoPoint:rn,Timestamp:W,Blob:_o,Transaction:wo,WriteBatch:vo,DocumentReference:ne,DocumentSnapshot:hn,Query:fn,QueryDocumentSnapshot:dn,QuerySnapshot:Ii,CollectionReference:ar,FieldPath:hl,FieldValue:dl,setLogLevel:qy,CACHE_SIZE_UNLIMITED:$m};function Uy(n,t){n.INTERNAL.registerComponent(new Ri("firestore-compat",e=>{let r=e.getProvider("app-compat").getImmediate(),i=e.getProvider("firestore").getImmediate();return t(r,i)},"PUBLIC").setServiceProps(Object.assign({},By)))}function Gy(n){Uy(n,(t,e)=>new yo(t,e,new cl)),n.registerVersion(My,Ly)}Gy(Do);function jy(n,t=wl){return new yl(e=>{let r;return t!=null?t.schedule(()=>{r=n.onSnapshot({includeMetadataChanges:!0},e)}):r=n.onSnapshot({includeMetadataChanges:!0},e),()=>{r?.()}})}function Bg(n,t){return jy(n,t)}function Ky(n,t){return Bg(n,t).pipe(Ai(void 0),Ei(),Rt(e=>{let[r,i]=e;return i.exists?r?.exists?{payload:i,type:"modified"}:{payload:i,type:"added"}:{payload:i,type:"removed"}}))}function pl(n,t){return Bg(n,t).pipe(Rt(e=>({payload:e,type:"query"})))}var Io=class{ref;afs;constructor(t,e){this.ref=t,this.afs=e}set(t,e){return this.ref.set(t,e)}update(t){return this.ref.update(t)}delete(){return this.ref.delete()}collection(t,e){let r=this.ref.collection(t),{ref:i,query:s}=zg(r,e);return new To(i,s,this.afs)}snapshotChanges(){return Ky(this.ref,this.afs.schedulers.outsideAngular).pipe(Dt)}valueChanges(t={}){return this.snapshotChanges().pipe(Rt(({payload:e})=>t.idField?ur(mn({},e.data()),{[t.idField]:e.id}):e.data()))}get(t){return re(this.ref.get(t)).pipe(Dt)}};function Eo(n,t){return pl(n,t).pipe(Ai(void 0),Ei(),Rt(e=>{let[r,i]=e,s=i.payload.docChanges(),o=s.map(a=>({type:a.type,payload:a}));return r&&JSON.stringify(r.payload.metadata)!==JSON.stringify(i.payload.metadata)&&i.payload.docs.forEach((a,u)=>{let c=s.find(h=>h.doc.ref.isEqual(a.ref)),l=r?.payload.docs.find(h=>h.ref.isEqual(a.ref));c&&JSON.stringify(c.doc.metadata)===JSON.stringify(a.metadata)||!c&&l&&JSON.stringify(l.metadata)===JSON.stringify(a.metadata)||o.push({type:"modified",payload:{oldIndex:u,newIndex:u,type:"modified",doc:a}})}),o}))}function Ug(n,t,e){return Eo(n,e).pipe(Ti((r,i)=>$y(r,i.map(s=>s.payload),t),[]),vl(),Rt(r=>r.map(i=>({type:i.type,payload:i}))))}function $y(n,t,e){return t.forEach(r=>{e.indexOf(r.type)>-1&&(n=Qy(n,r))}),n}function ml(n,t,e,...r){let i=n.slice();return i.splice(t,e,...r),i}function Qy(n,t){switch(t.type){case"added":if(!(n[t.newIndex]&&n[t.newIndex].doc.ref.isEqual(t.doc.ref)))return ml(n,t.newIndex,0,t);break;case"modified":if(n[t.oldIndex]==null||n[t.oldIndex].doc.ref.isEqual(t.doc.ref))if(t.oldIndex!==t.newIndex){let e=n.slice();return e.splice(t.oldIndex,1),e.splice(t.newIndex,0,t),e}else return ml(n,t.newIndex,1,t);break;case"removed":if(n[t.oldIndex]&&n[t.oldIndex].doc.ref.isEqual(t.doc.ref))return ml(n,t.oldIndex,1);break}return n}function Gg(n){return(!n||n.length===0)&&(n=["added","removed","modified"]),n}var To=class{ref;query;afs;constructor(t,e,r){this.ref=t,this.query=e,this.afs=r}stateChanges(t){let e=Eo(this.query,this.afs.schedulers.outsideAngular);return t&&t.length>0&&(e=e.pipe(Rt(r=>r.filter(i=>t.indexOf(i.type)>-1)))),e.pipe(Ai(void 0),Ei(),So(([r,i])=>i.length>0||!r),Rt(([,r])=>r),Dt)}auditTrail(t){return this.stateChanges(t).pipe(Ti((e,r)=>[...e,...r],[]))}snapshotChanges(t){let e=Gg(t);return Ug(this.query,e,this.afs.schedulers.outsideAngular).pipe(Dt)}valueChanges(t={}){return pl(this.query,this.afs.schedulers.outsideAngular).pipe(Rt(e=>e.payload.docs.map(r=>t.idField?ur(mn({},r.data()),{[t.idField]:r.id}):r.data())),Dt)}get(t){return re(this.query.get(t)).pipe(Dt)}add(t){return this.ref.add(t)}doc(t){return new Io(this.ref.doc(t),this.afs)}},gl=class{query;afs;constructor(t,e){this.query=t,this.afs=e}stateChanges(t){return!t||t.length===0?Eo(this.query,this.afs.schedulers.outsideAngular).pipe(Dt):Eo(this.query,this.afs.schedulers.outsideAngular).pipe(Rt(e=>e.filter(r=>t.indexOf(r.type)>-1)),So(e=>e.length>0),Dt)}auditTrail(t){return this.stateChanges(t).pipe(Ti((e,r)=>[...e,...r],[]))}snapshotChanges(t){let e=Gg(t);return Ug(this.query,e,this.afs.schedulers.outsideAngular).pipe(Dt)}valueChanges(t={}){return pl(this.query,this.afs.schedulers.outsideAngular).pipe(Rt(r=>r.payload.docs.map(i=>t.idField?mn({[t.idField]:i.id},i.data()):i.data())),Dt)}get(t){return re(this.query.get(t)).pipe(Dt)}},Wy=new lr("angularfire2.enableFirestorePersistence"),Hy=new lr("angularfire2.firestore.persistenceSettings"),Jy=new lr("angularfire2.firestore.settings"),Yy=new lr("angularfire2.firestore.use-emulator");function zg(n,t=e=>e){return{query:t(n),ref:n}}var jg=(()=>{class n{schedulers;firestore;persistenceEnabled$;constructor(e,r,i,s,o,a,u,c,l,h,d,m,A,w,v,b,N){this.schedulers=u;let x=kl(e,a,r),q=l;h&&Gl(x,a,d,A,w,v,m,b),[this.firestore,this.persistenceEnabled$]=Fl(`${x.name}.firestore`,"AngularFirestore",x.name,()=>{let B=a.runOutsideAngular(()=>x.firestore());if(s&&B.settings(s),q&&B.useEmulator(...q),i&&!Tl(o)){let O=()=>{try{return re(B.enablePersistence(c||void 0).then(()=>!0,()=>!1))}catch(nt){return typeof console<"u"&&console.warn(nt),gn(!1)}};return[B,a.runOutsideAngular(O)]}else return[B,gn(!1)]},[s,q,i])}collection(e,r){let i;typeof e=="string"?i=this.firestore.collection(e):i=e;let{ref:s,query:o}=zg(i,r),a=this.schedulers.ngZone.run(()=>s);return new To(a,o,this)}collectionGroup(e,r){let i=r||(o=>o),s=this.firestore.collectionGroup(e);return new gl(i(s),this)}doc(e){let r;typeof e=="string"?r=this.firestore.doc(e):r=e;let i=this.schedulers.ngZone.run(()=>r);return new Io(i,this)}createId(){return this.firestore.collection("_").doc().id}static \u0275fac=function(r){return new(r||n)(rt(Vl),rt(Nl,8),rt(Wy,8),rt(Jy,8),rt(Il),rt(El),rt(Cl),rt(Hy,8),rt(Yy,8),rt(zl,8),rt(Ml,8),rt(Ll,8),rt(Ol,8),rt(ql,8),rt(Bl,8),rt(Ul,8),rt(Dl,8))};static \u0275prov=Si({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})();var $w=(()=>{let t=class t{constructor(r){this.firestore=r}setCollection(r){this.collection=this.firestore.collection(r)}getDocuments(){if(!this.collection)throw new Error("Collection path not set.");return this.collection.snapshotChanges().pipe(Rt(r=>r.map(i=>{let s=i.payload.doc.data(),o=i.payload.doc.id;return ur(mn({},s),{id:o})})),cr(r=>{throw console.error("Error obtaining data from Firestore:",r),r}))}addDocument(r){return re(this.collection.add(r)).pipe(Ro(i=>this.collection.doc(i.id).valueChanges()))}updateDocument(r,i){return re(this.collection.doc(r).update(i)).pipe(cr(s=>{throw console.error("Error updating document in Firestore:",s),s}))}deleteDocument(r){return re(this.collection.doc(r).delete()).pipe(cr(i=>{throw console.error("Error deleting document from Firestore:",i),i}))}getDocumentById(r){return this.collection.doc(r).get().pipe(Ro(i=>{if(i.exists){let s=i.data();return gn(s)}else return console.error("Document with provided ID does not exist:",r),gn(void 0)}),cr(i=>{throw console.error("Error getting document by ID:",i),i}))}};t.\u0275fac=function(i){return new(i||t)(rt(jg))},t.\u0275prov=Si({token:t,factory:t.\u0275fac,providedIn:"root"});let n=t;return n})();export{jg as a,$w as b};
